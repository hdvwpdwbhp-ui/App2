<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Operationsbegleiter</title>
    <style>
        /* === CLINICAL PRO DESIGN SYSTEM === */
        :root{
            /* Colors - Clean Clinical Palette */
            --bg:#f8fafc;--surface:#ffffff;--surface-2:#f1f5f9;--text:#0f172a;--text-2:#334155;--muted:#64748b;--border:#e2e8f0;
            --primary:#0ea5e9;--primary-2:#0284c7;--secondary:#6366f1;
            --success:#059669;--warning:#d97706;--danger:#dc2626;
            /* Shadows - Subtle */
            --shadow-1:0 1px 2px rgba(0,0,0,0.05);--shadow-2:0 4px 6px -1px rgba(0,0,0,0.07),0 2px 4px -2px rgba(0,0,0,0.05);--shadow-3:0 10px 15px -3px rgba(0,0,0,0.08),0 4px 6px -4px rgba(0,0,0,0.05);
            /* Radius */
            --radius-sm:6px;--radius-md:10px;--radius-lg:14px;--radius-xl:20px;
            /* Spacing */
            --space-1:4px;--space-2:8px;--space-3:12px;--space-4:16px;--space-5:24px;--space-6:32px;
            /* Focus */
            --focus:0 0 0 3px rgba(14,165,233,0.3);
            /* Safe Area Insets for iOS */
            --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);--sal:env(safe-area-inset-left,0px);--sar:env(safe-area-inset-right,0px);
            /* Legacy compatibility */
            --card:var(--surface);--input-bg:var(--surface);--radius:var(--radius-lg);--gradient:var(--primary)
        }
        /* Dark Mode - Soft, Professional */
        html[data-theme="dark"]{
            --bg:#0f172a;--surface:#1e293b;--surface-2:#334155;--text:#f1f5f9;--text-2:#cbd5e1;--muted:#94a3b8;--border:#334155;
            --primary:#38bdf8;--primary-2:#0ea5e9;--secondary:#818cf8;
            --success:#34d399;--warning:#fbbf24;--danger:#f87171;
            --shadow-1:0 1px 2px rgba(0,0,0,0.3);--shadow-2:0 4px 6px rgba(0,0,0,0.25);--shadow-3:0 10px 15px rgba(0,0,0,0.3);
            --card:var(--surface);--input-bg:var(--surface-2)
        }
        /* Base */
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{background-color:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;min-height:100vh;min-height:100dvh;transition:background-color .2s,color .2s;line-height:1.6;-webkit-font-smoothing:antialiased}
        .hidden{display:none!important}
        .app{max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;padding-bottom:calc(90px + var(--sab));padding-left:var(--sal);padding-right:var(--sar);background-color:var(--bg);transition:background-color .2s}
        /* Header - Clean Surface */
        .header{position:sticky;top:0;z-index:100;padding:var(--space-3) var(--space-4);padding-top:calc(var(--space-3) + var(--sat));background-color:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:var(--space-3);box-shadow:var(--shadow-1)}
        .back-btn,.icon-btn{width:40px;height:40px;min-width:40px;border:1px solid var(--border);background-color:var(--surface);border-radius:var(--radius-md);font-size:1.1rem;cursor:pointer;color:var(--text);transition:all .15s;display:flex;align-items:center;justify-content:center}
        .back-btn:hover,.icon-btn:hover{background-color:var(--surface-2);border-color:var(--muted)}
        .back-btn:focus,.icon-btn:focus{outline:none;box-shadow:var(--focus)}
        .logo-img{width:32px;height:32px;border-radius:var(--radius-sm)}
        .logo{flex:1;font-weight:700;font-size:1rem;color:var(--primary);letter-spacing:-0.02em}
        /* Screen */
        .screen{padding:var(--space-4);background-color:var(--bg);min-height:calc(100vh - 60px - var(--sat));min-height:calc(100dvh - 60px - var(--sat));animation:fadeIn .2s ease-out}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes recording{0%,100%{opacity:1}50%{opacity:.4}}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        /* Reduced motion */
        @media(prefers-reduced-motion:reduce){*{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}}
        /* Forms - Clean & Accessible */
        .form-group{margin-bottom:var(--space-4)}
        .form-label{display:block;font-weight:600;margin-bottom:var(--space-2);font-size:.875rem;color:var(--text-2)}
        .form-input,.form-select,.form-textarea{width:100%;padding:var(--space-3) var(--space-4);border:1px solid var(--border);border-radius:var(--radius-md);background-color:var(--input-bg);color:var(--text);font-size:1rem;font-family:inherit;transition:border-color .15s,box-shadow .15s}
        .form-input.date-input{max-width:160px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus)}
        .form-input::placeholder,.form-textarea::placeholder{color:var(--muted)}
        .form-textarea{resize:vertical;min-height:80px}
        .checkbox-group{display:flex;align-items:flex-start;gap:var(--space-3);padding:var(--space-4);background-color:var(--surface);border-radius:var(--radius-md);margin-bottom:var(--space-2);cursor:pointer;border:1px solid var(--border);transition:border-color .15s}
        .checkbox-group:hover{border-color:var(--primary)}
        .checkbox-group input{display:none}
        .custom-checkbox{width:22px;height:22px;min-width:22px;border:2px solid var(--border);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;transition:all .15s}
        .checkbox-group:hover .custom-checkbox{border-color:var(--primary)}
        .checkbox-group input:checked+.custom-checkbox{background-color:var(--primary);border-color:var(--primary)}
        .checkbox-group input:checked+.custom-checkbox::after{content:'✓';color:#fff;font-size:.8rem;font-weight:700}
        .checkbox-title{font-weight:600;font-size:.9rem;color:var(--text)}
        .checkbox-desc{font-size:.8rem;color:var(--muted);margin-top:2px;line-height:1.5}
        /* Buttons - Professional */
        .btn{padding:var(--space-3) var(--space-5);border:none;border-radius:var(--radius-xl);font-size:.9rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:var(--space-2);transition:all .15s;font-family:inherit;min-height:48px}
        .btn:focus{outline:none;box-shadow:var(--focus)}
        .btn-primary{background-color:var(--primary);color:#fff;box-shadow:var(--shadow-2)}
        .btn-primary:hover{background-color:var(--primary-2)}
        .btn-primary:active{transform:scale(0.98)}
        .btn-secondary{background-color:var(--surface);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{background-color:var(--surface-2);border-color:var(--muted)}
        .btn-danger{background-color:var(--danger);color:#fff}
        .btn-danger:hover{background-color:#b91c1c}
        .btn-block{width:100%}
        .btn-sm{padding:var(--space-2) var(--space-4);font-size:.85rem;min-height:40px}
        /* Hero - Clean Card */
        .hero{background-color:var(--primary);border-radius:var(--radius-lg);padding:var(--space-5);margin-bottom:var(--space-5);box-shadow:var(--shadow-2)}
        .hero-label{color:rgba(255,255,255,.85);font-size:.85rem;margin-bottom:var(--space-1);font-weight:500}
        .hero-value{font-size:3rem;font-weight:700;color:#fff;line-height:1;letter-spacing:-0.02em}
        .hero-unit{color:rgba(255,255,255,.9);font-size:1rem;margin-top:var(--space-1)}
        .hero-date{margin-top:var(--space-3);padding-top:var(--space-3);border-top:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.9);font-size:.875rem}
        /* Sections */
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-3)}
        .section-title{font-size:1rem;font-weight:700;color:var(--text);letter-spacing:-0.01em}
        .section-link{color:var(--primary);font-weight:600;font-size:.85rem;cursor:pointer}
        .section-link:hover{text-decoration:underline}
        /* Grid - Clean Cards */
        .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-3);margin-bottom:var(--space-5)}
        .grid-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);text-align:center;cursor:pointer;transition:all .15s;min-height:44px}
        .grid-card:hover{border-color:var(--primary);box-shadow:var(--shadow-2)}
        .grid-card:focus{outline:none;box-shadow:var(--focus)}
        .grid-card:active{transform:scale(0.98)}
        .grid-icon{font-size:1.6rem;margin-bottom:var(--space-2)}
        .grid-label{font-weight:600;font-size:.85rem;color:var(--text)}
        /* Cards - Flat & Structured */
        .card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;margin-bottom:var(--space-3)}
        .card-item{padding:var(--space-4);display:flex;align-items:center;gap:var(--space-3);border-bottom:1px solid var(--border);cursor:pointer;transition:background-color .15s;min-height:56px}
        .card-item:last-child{border-bottom:none}
        .card-item:hover{background-color:var(--surface-2)}
        .card-item:focus{outline:none;box-shadow:inset var(--focus)}
        .card-content{flex:1}
        .card-title{font-weight:600;font-size:.9rem;color:var(--text)}
        .card-desc{font-size:.8rem;color:var(--muted);margin-top:2px}
        /* Badge - Clean */
        .badge{padding:var(--space-1) var(--space-3);background-color:var(--primary);border-radius:var(--radius-xl);color:#fff;font-weight:600;font-size:.75rem}
        .badge.today{background-color:var(--warning)}
        /* Menu FAB - Subtle */
        .menu-fab{position:fixed;bottom:calc(20px + var(--sab));left:50%;transform:translateX(-50%);padding:var(--space-3) var(--space-5);background-color:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-xl);font-size:.9rem;font-weight:600;cursor:pointer;box-shadow:var(--shadow-3);z-index:100;display:flex;align-items:center;gap:var(--space-2);font-family:inherit;min-height:48px}
        .menu-fab:hover{border-color:var(--primary);box-shadow:var(--shadow-3),var(--focus)}
        .menu-fab:focus{outline:none;box-shadow:var(--shadow-3),var(--focus)}
        .menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;backdrop-filter:blur(2px)}
        .menu-drawer{position:fixed;bottom:0;left:0;right:0;background-color:var(--surface);border-radius:var(--radius-lg) var(--radius-lg) 0 0;max-height:calc(80vh - var(--sat));overflow-y:auto;z-index:1001;animation:slideUp .2s ease-out;box-shadow:var(--shadow-3);padding-bottom:var(--sab)}
        .menu-header{padding:var(--space-4);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .menu-title{font-weight:700;font-size:1rem;color:var(--text)}
        .menu-close{width:36px;height:36px;border:1px solid var(--border);background-color:var(--surface);border-radius:50%;font-size:1rem;cursor:pointer;color:var(--text);transition:all .15s}
        .menu-close:hover{background-color:var(--surface-2)}
        .menu-close:focus{outline:none;box-shadow:var(--focus)}
        .menu-section{padding:var(--space-3) var(--space-4);border-bottom:1px solid var(--border)}
        .menu-section-title{font-size:.7rem;color:var(--muted);text-transform:uppercase;margin-bottom:var(--space-2);font-weight:600;letter-spacing:0.05em}
        .menu-item{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3);border-radius:var(--radius-md);cursor:pointer;margin-bottom:var(--space-1);transition:background-color .15s;min-height:48px}
        .menu-item:hover{background-color:var(--surface-2)}
        .menu-item:focus{outline:none;box-shadow:var(--focus)}
        .menu-item-icon{font-size:1.2rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background-color:var(--surface-2);border-radius:var(--radius-md)}
        .menu-item h4{font-weight:600;font-size:.875rem;color:var(--text)}
        .menu-item p{font-size:.75rem;color:var(--muted)}
        /* Timeline - Clean */
        .timeline{position:relative;padding-left:35px}
        .timeline-line{position:absolute;left:14px;top:0;bottom:0;width:2px;background-color:var(--border)}
        .timeline-phase{margin-bottom:var(--space-5)}
        .timeline-header{display:flex;align-items:center;margin-bottom:var(--space-3);position:relative}
        .timeline-dot{position:absolute;left:-28px;width:18px;height:18px;background-color:var(--surface);border:2px solid var(--border);border-radius:50%}
        .timeline-dot.today{background-color:var(--warning);border-color:var(--warning)}
        .timeline-dot.completed{background-color:var(--success);border-color:var(--success)}
        .timeline-dot.op{background-color:var(--primary);border-color:var(--primary);width:22px;height:22px;left:-30px}
        .phase-label{font-weight:700;font-size:.95rem;color:var(--text)}
        .phase-date{font-size:.8rem;color:var(--muted)}
        /* Tasks - Flat */
        .task{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-2);transition:border-color .15s}
        .task:hover{border-color:var(--muted)}
        .task.completed{opacity:.6}
        .task.completed .task-title{text-decoration:line-through}
        .task-header{display:flex;align-items:flex-start;gap:var(--space-3)}
        .task-check{width:24px;height:24px;min-width:24px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.75rem;transition:all .15s}
        .task-check:hover{border-color:var(--primary)}
        .task-check:focus{outline:none;box-shadow:var(--focus)}
        .task-check.checked{background-color:var(--success);border-color:var(--success);color:#fff}
        .task-title{font-weight:600;font-size:.9rem;color:var(--text)}
        .task-desc{font-size:.8rem;color:var(--muted);margin-top:2px;line-height:1.5}
        .task-note{margin-top:var(--space-3);padding:var(--space-3);background-color:var(--surface-2);border-radius:var(--radius-sm);font-size:.85rem;color:var(--text)}
        .add-note-btn{margin-top:var(--space-2);padding:var(--space-2) var(--space-3);border:none;background:transparent;color:var(--primary);font-weight:600;font-size:.8rem;cursor:pointer}
        .add-note-btn:hover{text-decoration:underline}
        /* Fasting - Alert Style */
        .fasting{background-color:rgba(217,119,6,.08);border:1px solid var(--warning);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .fasting-title{font-weight:700;margin-bottom:var(--space-3);display:flex;align-items:center;gap:var(--space-2);color:var(--text)}
        .fasting-rule{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3);background-color:var(--surface);border-radius:var(--radius-sm);margin-bottom:var(--space-2);border:1px solid var(--border)}
        .fasting-rule:last-child{margin-bottom:0}
        .fasting-icon{font-size:1.2rem}
        .fasting-text strong{display:block;font-size:.875rem;color:var(--text)}
        .fasting-text span{font-size:.8rem;color:var(--muted)}
        /* Tabs - Clean Pills */
        .tabs{display:flex;gap:var(--space-2);overflow-x:auto;padding-bottom:var(--space-2);margin-bottom:var(--space-4)}
        .tab{padding:var(--space-2) var(--space-4);border:1px solid var(--border);border-radius:var(--radius-xl);background-color:var(--surface);color:var(--muted);font-weight:600;font-size:.85rem;white-space:nowrap;cursor:pointer;transition:all .15s;min-height:40px}
        .tab:hover{border-color:var(--primary);color:var(--text)}
        .tab:focus{outline:none;box-shadow:var(--focus)}
        .tab.active{background-color:var(--primary);color:#fff;border-color:var(--primary)}
        /* Info Content */
        .info-content{background-color:var(--surface);border-radius:var(--radius-md);padding:var(--space-5);border:1px solid var(--border)}
        .info-list{list-style:none}
        .info-list li{padding:var(--space-2) 0;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:var(--space-3);font-size:.9rem;line-height:1.6;color:var(--text)}
        .info-list li:last-child{border-bottom:none}
        .info-list li::before{content:'•';color:var(--primary);font-weight:bold}
        .disclaimer{background-color:var(--surface-2);border-radius:var(--radius-md);padding:var(--space-4);font-size:.85rem;color:var(--muted);display:flex;gap:var(--space-3);margin-top:var(--space-4);line-height:1.5}
        /* Emergency - Clean Alert */
        .emergency{background-color:var(--danger);border-radius:var(--radius-md);padding:var(--space-5);margin-bottom:var(--space-4);color:#fff;text-align:center}
        .emergency-title{font-size:1.1rem;font-weight:700;margin-bottom:var(--space-3)}
        .emergency-btn{display:inline-flex;align-items:center;gap:var(--space-2);padding:var(--space-3) var(--space-5);background:#fff;color:var(--danger);border-radius:var(--radius-xl);font-weight:700;text-decoration:none;margin-top:var(--space-3);min-height:44px}
        .emergency-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(255,255,255,0.5)}
        /* Warning Cards */
        .warning-card{background-color:var(--surface);border:1px solid var(--danger);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-3);display:flex;align-items:flex-start;gap:var(--space-3)}
        .warning-card:hover{background-color:rgba(220,38,38,.03)}
        .warning-card h4{font-weight:600;font-size:.9rem;color:var(--text)}
        .warning-card p{font-size:.8rem;color:var(--muted);line-height:1.5}
        .warning-icon{font-size:1.3rem;color:var(--danger);min-width:28px}
        .clinic-btn{display:flex;align-items:center;justify-content:center;gap:var(--space-3);width:100%;padding:var(--space-4);background-color:var(--surface);border:1px solid var(--primary);border-radius:var(--radius-md);color:var(--primary);font-weight:600;text-decoration:none;margin-top:var(--space-4);min-height:48px;transition:all .15s}
        .clinic-btn:hover{background-color:rgba(14,165,233,.05)}
        .clinic-btn:focus{outline:none;box-shadow:var(--focus)}
        /* Upload Area - Clean */
        .upload-area{border:1px dashed var(--border);border-radius:var(--radius-md);padding:var(--space-5);text-align:center;cursor:pointer;margin-bottom:var(--space-3);transition:all .15s;background-color:var(--surface)}
        .upload-area:hover{border-color:var(--primary);background-color:rgba(14,165,233,.03)}
        .upload-area:focus{outline:none;box-shadow:var(--focus)}
        .upload-icon{font-size:1.8rem;margin-bottom:var(--space-2);opacity:.6}
        .upload-text{color:var(--muted);font-size:.85rem}
        .file-input{display:none}
        /* Photo Grid - Modern */
        .photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-2);margin-top:var(--space-3)}
        .photo-item{aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;position:relative;cursor:pointer;border:1px solid var(--border)}
        .photo-item:focus{outline:none;box-shadow:var(--focus)}
        .photo-item img{width:100%;height:100%;object-fit:cover}
        .photo-date{position:absolute;bottom:0;left:0;right:0;padding:var(--space-1);background:linear-gradient(transparent,rgba(0,0,0,.6));color:#fff;font-size:.6rem;text-align:center}
        .photo-delete{position:absolute;top:var(--space-1);right:var(--space-1);width:24px;height:24px;background:rgba(220,38,38,.9);border:none;border-radius:50%;color:#fff;font-size:.7rem;cursor:pointer;opacity:1;transition:opacity .15s;display:flex;align-items:center;justify-content:center}
        .photo-delete:focus{outline:none;box-shadow:0 0 0 2px #fff}
        /* Doc Files */
        .doc-file{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-3);display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-2);cursor:pointer;transition:border-color .15s}
        .doc-file:hover{border-color:var(--primary)}
        .doc-file:focus{outline:none;box-shadow:var(--focus)}
        .doc-file-icon{font-size:1.4rem;opacity:.7}
        .doc-file-info{flex:1}
        .doc-file-name{font-weight:600;font-size:.85rem;color:var(--text)}
        .doc-file-meta{font-size:.75rem;color:var(--muted)}
        .doc-file-del{border:none;background:transparent;color:var(--danger);cursor:pointer;padding:var(--space-2);border-radius:var(--radius-sm);min-width:36px;min-height:36px}
        .doc-file-del:hover{background-color:rgba(220,38,38,.1)}
        .doc-file-del:focus{outline:none;box-shadow:var(--focus)}
        /* Recording - Clean */
        .recording-controls{display:flex;flex-direction:column;align-items:center;gap:var(--space-4);padding:var(--space-5);background-color:var(--surface);border-radius:var(--radius-md);border:1px solid var(--border)}
        .record-btn{width:72px;height:72px;border-radius:50%;border:none;background-color:var(--primary);color:#fff;font-size:1.6rem;cursor:pointer;box-shadow:var(--shadow-2);display:flex;align-items:center;justify-content:center}
        .record-btn:hover{background-color:var(--primary-2)}
        .record-btn:focus{outline:none;box-shadow:var(--shadow-2),var(--focus)}
        .record-btn.recording{background-color:var(--danger);animation:recording 1s infinite}
        .recording-status{font-weight:600;color:var(--muted)}
        .recording-status.active{color:var(--danger)}
        .recording-timer{font-size:1.6rem;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums}
        .speech-btn{width:100%;padding:var(--space-4);border:1px solid var(--primary);border-radius:var(--radius-md);background-color:var(--surface);color:var(--primary);font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--space-3);font-family:inherit;transition:all .15s;min-height:56px}
        .speech-btn:hover{background-color:rgba(14,165,233,.05)}
        .speech-btn:focus{outline:none;box-shadow:var(--focus)}
        .speech-btn.listening{background-color:rgba(220,38,38,.05);border-color:var(--danger);color:var(--danger);animation:recording 1s infinite}
        /* Memo Items */
        .memo-item{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-3);display:flex;align-items:center;gap:var(--space-3);margin-top:var(--space-3)}
        .play-btn{width:40px;height:40px;min-width:40px;border-radius:50%;border:none;background-color:var(--primary);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .play-btn:hover{background-color:var(--primary-2)}
        .play-btn:focus{outline:none;box-shadow:var(--focus)}
        .memo-info{flex:1}
        .memo-title{font-weight:600;font-size:.85rem;color:var(--text)}
        .memo-meta{font-size:.75rem;color:var(--muted)}
        .memo-delete{border:none;background:transparent;color:var(--danger);cursor:pointer;padding:var(--space-2);min-width:36px;min-height:36px;border-radius:var(--radius-sm)}
        .memo-delete:hover{background-color:rgba(220,38,38,.1)}
        .memo-delete:focus{outline:none;box-shadow:var(--focus)}
        /* Transcripts */
        .transcript-item{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-top:var(--space-3)}
        .transcript-header{display:flex;justify-content:space-between;margin-bottom:var(--space-2)}
        .transcript-date{font-size:.8rem;color:var(--muted)}
        .transcript-delete{border:none;background:transparent;color:var(--danger);cursor:pointer;min-width:36px;min-height:36px;border-radius:var(--radius-sm)}
        .transcript-delete:hover{background-color:rgba(220,38,38,.1)}
        .transcript-delete:focus{outline:none;box-shadow:var(--focus)}
        .transcript-text{color:var(--text);line-height:1.6}
        .transcript-name{font-weight:600;font-size:.9rem;color:var(--primary);margin-bottom:var(--space-1)}
        .transcript-edit{background:none;border:none;color:var(--primary);cursor:pointer;padding:var(--space-1);font-size:.85rem}
        .transcript-edit:hover{text-decoration:underline}
        /* VAS - Clean */
        .vas-container{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .vas-title{font-weight:600;color:var(--text);margin-bottom:var(--space-2)}
        .vas-scale{display:flex;align-items:center;gap:var(--space-3);margin:var(--space-4) 0}
        .vas-label{font-size:.75rem;color:var(--muted);min-width:50px}
        .vas-slider{flex:1;-webkit-appearance:none;height:8px;border-radius:4px;background:linear-gradient(90deg,var(--success),var(--warning),var(--danger))}
        .vas-slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:#fff;border:2px solid var(--primary);cursor:pointer;box-shadow:var(--shadow-2)}
        .vas-slider:focus{outline:none}
        .vas-slider:focus::-webkit-slider-thumb{box-shadow:var(--shadow-2),var(--focus)}
        .vas-value{min-width:35px;text-align:center;font-size:1.2rem;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums}
        .vas-emojis{display:flex;justify-content:space-between;font-size:1.1rem}
        /* Charts */
        .chart-container{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .chart-title{font-weight:700;margin-bottom:var(--space-3);color:var(--text)}
        .chart-canvas{width:100%;height:150px}
        .chart-svg{width:100%;height:100%}
        .chart-no-data{display:flex;flex-direction:column;align-items:center;justify-content:center;height:120px;color:var(--muted)}
        .chart-no-data-icon{font-size:1.6rem;margin-bottom:var(--space-2);opacity:.5}
        /* Vitals */
        .vitals-row{display:flex;gap:var(--space-3);margin-bottom:var(--space-3)}
        .vitals-group{flex:1}
        .vitals-group label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:var(--space-1)}
        .vitals-group input{width:100%;padding:var(--space-3);border:1px solid var(--border);border-radius:var(--radius-sm);background-color:var(--input-bg);color:var(--text);font-size:1rem;text-align:center}
        .vitals-group input:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus)}
        /* Appointments */
        .appt-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-3);display:flex;gap:var(--space-3)}
        .appt-date{min-width:50px;text-align:center;padding:var(--space-2);background-color:var(--primary);border-radius:var(--radius-sm);color:#fff}
        .appt-day{font-size:1.2rem;font-weight:700;line-height:1}
        .appt-month{font-size:.7rem}
        .appt-info{flex:1}
        .appt-title{font-weight:600;font-size:.9rem;color:var(--text)}
        .appt-details{font-size:.8rem;color:var(--muted)}
        .appt-delete{border:none;background:transparent;color:var(--danger);cursor:pointer;padding:var(--space-2);min-width:36px;min-height:36px;border-radius:var(--radius-sm)}
        .appt-delete:hover{background-color:rgba(220,38,38,.1)}
        .appt-delete:focus{outline:none;box-shadow:var(--focus)}
        /* Medications */
        .med-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-3)}
        .med-header{display:flex;justify-content:space-between;margin-bottom:var(--space-3)}
        .med-name{font-weight:600;color:var(--text)}
        .med-dose{font-size:.85rem;color:var(--muted)}
        .med-times{display:flex;flex-wrap:wrap;gap:var(--space-2)}
        .med-time{display:flex;align-items:center;gap:var(--space-1);padding:var(--space-2) var(--space-3);background-color:var(--surface-2);border-radius:var(--radius-xl);font-size:.8rem;cursor:pointer;color:var(--text);border:1px solid var(--border)}
        .med-time:hover{border-color:var(--primary)}
        .alarm-dot{width:6px;height:6px;background-color:var(--success);border-radius:50%}
        .alarm-dot.off{background-color:var(--muted)}
        /* Doc Items */
        .doc-item{padding:var(--space-4);display:flex;align-items:center;gap:var(--space-3);border-bottom:1px solid var(--border);cursor:pointer;transition:background-color .15s;min-height:56px}
        .doc-item:last-child{border-bottom:none}
        .doc-item:hover{background-color:var(--surface-2)}
        .doc-item:focus{outline:none;box-shadow:inset var(--focus)}
        .doc-check{width:22px;height:22px;min-width:22px;border:2px solid var(--border);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;transition:all .15s}
        .doc-item.checked .doc-check{background-color:var(--success);border-color:var(--success);color:#fff}
        .doc-icon{font-size:1rem}
        .doc-label{flex:1;font-weight:500;font-size:.9rem;color:var(--text)}
        .doc-delete{border:none;background:transparent;color:var(--danger);cursor:pointer;opacity:0;padding:var(--space-2);transition:opacity .15s;min-width:36px;min-height:36px;border-radius:var(--radius-sm)}
        .doc-item:hover .doc-delete{opacity:1}
        .doc-delete:focus{opacity:1;outline:none;box-shadow:var(--focus)}
        /* Settings - Clean */
        .settings-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;margin-bottom:var(--space-4)}
        .settings-item{padding:var(--space-4);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);min-height:56px}
        .settings-item:last-child{border-bottom:none}
        .settings-label{display:flex;align-items:center;gap:var(--space-3)}
        .settings-icon{font-size:1.1rem;opacity:.7}
        .settings-text h4{font-weight:600;font-size:.875rem;color:var(--text)}
        .settings-text p{font-size:.8rem;color:var(--muted);line-height:1.4}
        /* Toggle - Clean */
        .toggle{position:relative;width:50px;height:28px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;inset:0;background-color:var(--border);border-radius:14px;transition:.2s}
        .toggle-slider::before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:var(--shadow-1)}
        .toggle input:checked+.toggle-slider{background-color:var(--primary)}
        .toggle input:checked+.toggle-slider::before{transform:translateX(22px)}
        .toggle input:focus+.toggle-slider{box-shadow:var(--focus)}
        .storage-info{background-color:var(--surface-2);border-radius:var(--radius-md);padding:var(--space-4);font-size:.85rem;color:var(--muted);display:flex;gap:var(--space-3);line-height:1.5}
        /* Question Cards */
        .question-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:var(--space-4);overflow:hidden}
        .question-header{padding:var(--space-4);display:flex;align-items:center;gap:var(--space-3)}
        .question-header.anaesthesist{background-color:rgba(14,165,233,.08);border-bottom:1px solid var(--primary)}
        .question-header.operateur{background-color:rgba(5,150,105,.08);border-bottom:1px solid var(--success)}
        .question-icon{font-size:2rem}
        .question-header-info h3{font-weight:700;font-size:1rem;color:var(--text)}
        .question-header-info p{font-size:.8rem;color:var(--muted);margin-top:2px}
        .question-timing{margin:var(--space-3) var(--space-4);padding:var(--space-2) var(--space-4);border-radius:var(--radius-xl);font-size:.8rem;font-weight:600;display:inline-flex;align-items:center;gap:var(--space-2)}
        .question-timing.vor-op{background-color:rgba(217,119,6,.1);color:var(--warning)}
        .question-timing.op-tag{background-color:rgba(220,38,38,.1);color:var(--danger)}
        .question-timing.nach-op{background-color:rgba(5,150,105,.1);color:var(--success)}
        .question-body{padding:0 var(--space-4) var(--space-4)}
        .question-item{display:flex;align-items:flex-start;gap:var(--space-3);padding:var(--space-3);background-color:var(--surface-2);border-radius:var(--radius-sm);margin-bottom:var(--space-2)}
        .question-bullet{color:var(--primary);font-weight:bold}
        .question-text{flex:1;color:var(--text);font-size:.875rem;line-height:1.5}
        .question-del{border:none;background:transparent;color:var(--danger);cursor:pointer;padding:var(--space-1);min-width:32px;min-height:32px;border-radius:var(--radius-sm)}
        .question-del:hover{background-color:rgba(220,38,38,.1)}
        .question-del:focus{outline:none;box-shadow:var(--focus)}
        .question-empty{padding:var(--space-4);text-align:center;color:var(--muted);font-size:.85rem}
        /* Chat - Clean */
        .chat-container{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
        .chat-header{padding:var(--space-4);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:var(--space-3);background-color:var(--surface-2)}
        .chat-header-icon{font-size:1.4rem}
        .chat-header-text h3{font-weight:700;font-size:.95rem;color:var(--text)}
        .chat-header-text p{font-size:.75rem;color:var(--muted)}
        .chat-messages{height:280px;overflow-y:auto;padding:var(--space-4);background-color:var(--bg)}
        .chat-message{margin-bottom:var(--space-3);max-width:85%}
        .chat-message.user{margin-left:auto}
        .chat-message.assistant{margin-right:auto}
        .chat-bubble{padding:var(--space-3) var(--space-4);border-radius:var(--radius-md);font-size:.9rem;line-height:1.6}
        .chat-message.user .chat-bubble{background-color:var(--primary);color:#fff;border-bottom-right-radius:var(--radius-sm)}
        .chat-message.assistant .chat-bubble{background-color:var(--surface);color:var(--text);border-bottom-left-radius:var(--radius-sm);border:1px solid var(--border)}
        .chat-input-area{display:flex;gap:var(--space-2);padding:var(--space-3);border-top:1px solid var(--border);background-color:var(--surface)}
        .chat-input{flex:1;padding:var(--space-3);border:1px solid var(--border);border-radius:var(--radius-xl);background-color:var(--input-bg);color:var(--text);font-family:inherit;font-size:.9rem}
        .chat-input:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus)}
        .chat-send{width:44px;height:44px;min-width:44px;border:none;background-color:var(--primary);color:#fff;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
        .chat-send:hover{background-color:var(--primary-2)}
        .chat-send:focus{outline:none;box-shadow:var(--focus)}
        .chat-disclaimer{padding:var(--space-3);background-color:rgba(217,119,6,.1);font-size:.7rem;color:var(--muted);text-align:center;line-height:1.4}
        /* Modal - Clean */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:flex-end;justify-content:center;z-index:2000;backdrop-filter:blur(2px)}
        .modal{background-color:var(--surface);border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:var(--space-5);padding-bottom:calc(var(--space-5) + var(--sab));width:100%;max-width:480px;max-height:calc(85vh - var(--sat));overflow-y:auto;animation:slideUp .2s ease-out;box-shadow:var(--shadow-3)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-4)}
        .modal-title{font-size:1.1rem;font-weight:700;color:var(--text)}
        .modal-close{width:36px;height:36px;border:1px solid var(--border);background-color:var(--surface);border-radius:50%;font-size:1rem;cursor:pointer;color:var(--text);display:flex;align-items:center;justify-content:center}
        .modal-close:hover{background-color:var(--surface-2)}
        .modal-close:focus{outline:none;box-shadow:var(--focus)}
        /* Toast - Minimal */
        .toast{position:fixed;bottom:calc(90px + var(--sab));left:50%;transform:translateX(-50%);background-color:var(--text);color:var(--bg);padding:var(--space-3) var(--space-5);border-radius:var(--radius-xl);font-weight:600;font-size:.875rem;z-index:3000;box-shadow:var(--shadow-3);animation:fadeIn .2s,fadeOut .2s 2.8s forwards}
        @keyframes fadeOut{to{opacity:0;transform:translate(-50%,10px)}}
        /* Photo Viewer */
        .photo-viewer{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:3000;display:flex;flex-direction:column;padding-top:var(--sat);padding-bottom:var(--sab)}
        .photo-viewer-header{padding:var(--space-4);display:flex;justify-content:space-between;align-items:center;color:#fff}
        .photo-viewer-close{width:44px;height:44px;border:none;background:rgba(255,255,255,.1);color:#fff;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .photo-viewer-close:hover{background:rgba(255,255,255,.2)}
        .photo-viewer-close:focus{outline:none;box-shadow:0 0 0 3px rgba(255,255,255,.3)}
        .photo-viewer-content{flex:1;display:flex;align-items:center;justify-content:center;padding:var(--space-4)}
        .photo-viewer-content img{max-width:100%;max-height:100%;object-fit:contain}
        /* Onboarding - Clean */
        .onboarding{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;background-color:var(--bg);padding-top:var(--sat);padding-left:var(--sal);padding-right:var(--sar)}
        .onboarding-progress{padding:var(--space-4);display:flex;gap:var(--space-2)}
        .progress-dot{flex:1;height:4px;border-radius:2px;background-color:var(--border)}
        .progress-dot.active{background-color:var(--primary)}
        .progress-dot.completed{background-color:var(--success)}
        .onboarding-content{flex:1;padding:var(--space-4) var(--space-5);display:flex;flex-direction:column;overflow-y:auto}
        .onboarding-hero{text-align:center;margin-bottom:var(--space-4)}
        .onboarding-logo{width:56px;height:56px;margin:0 auto var(--space-3);border-radius:var(--radius-lg)}
        .onboarding-title{font-size:1.3rem;font-weight:700;margin-bottom:var(--space-2);color:var(--primary)}
        .onboarding-subtitle{font-size:.9rem;color:var(--muted);line-height:1.5}
        .onboarding-nav{padding:var(--space-3) var(--space-5);padding-bottom:calc(var(--space-4) + var(--sab));display:flex;gap:var(--space-3);background-color:var(--bg);position:sticky;bottom:0}
        /* Progress */
        .progress-container{margin-bottom:var(--space-4)}
        .progress-label{display:flex;justify-content:space-between;margin-bottom:var(--space-2);font-size:.85rem;color:var(--text)}
        .progress-bar{height:8px;background-color:var(--border);border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background-color:var(--primary);border-radius:4px;transition:width .3s}
        /* Filter Tabs */
        .filter-tabs{display:flex;gap:var(--space-2);flex-wrap:wrap}
        .filter-tab{padding:var(--space-2) var(--space-4);border:1px solid var(--border);border-radius:var(--radius-xl);background:var(--surface);color:var(--muted);font-weight:600;font-size:.85rem;cursor:pointer;transition:all .15s;min-height:36px}
        .filter-tab:hover{border-color:var(--primary);color:var(--text)}
        .filter-tab:focus{outline:none;box-shadow:var(--focus)}
        .filter-tab.active{background-color:var(--primary);color:#fff;border-color:var(--primary)}
        /* Print */
        @media print{.header,.menu-fab,.modal-overlay{display:none!important}.app{max-width:100%;padding:var(--space-4)}}
        /* Mobile-specific fixes */
        @media (max-width:480px){
            .hero-value{font-size:2.5rem}
            .grid{grid-template-columns:repeat(3,1fr);gap:var(--space-2)}
            .grid-card{padding:var(--space-3) var(--space-2)}
            .grid-icon{font-size:1.4rem;margin-bottom:var(--space-1)}
            .grid-label{font-size:.75rem}
            .btn{padding:var(--space-3) var(--space-4);min-height:48px}
            .btn-sm{padding:var(--space-2) var(--space-3);min-height:44px}
            .speech-btn{min-height:56px}
            .record-btn{width:76px;height:76px}
            .form-input,.form-textarea,.form-select{padding:var(--space-4);font-size:16px;min-height:52px}
            .modal{max-height:90vh;padding:var(--space-4)}
            .menu-fab{padding:var(--space-3) var(--space-5);bottom:16px}
            .card-item{padding:var(--space-4);min-height:60px}
            .task-check{width:28px;height:28px;min-width:28px}
            .vas-slider::-webkit-slider-thumb{width:28px;height:28px}
            .play-btn{width:44px;height:44px;min-width:44px}
            .upload-area{padding:var(--space-5) var(--space-4)}
            .screen{padding:var(--space-3)}
            .header{padding:var(--space-2) var(--space-3);padding-top:calc(var(--space-2) + var(--sat))}
        }
        @media (max-width:360px){
            .grid{grid-template-columns:repeat(2,1fr)}
            .hero-value{font-size:2rem}
            .hero{padding:var(--space-4)}
        }
        /* Touch feedback - subtle */
        .btn:active,.grid-card:active,.card-item:active,.menu-item:active{transform:scale(0.98);opacity:0.9}
        .speech-btn:active{transform:scale(0.99)}
        /* Prevent zoom on input focus iOS */
        input[type="text"],input[type="date"],input[type="datetime-local"],input[type="tel"],input[type="number"],textarea,select{font-size:16px!important}
        /* Wound Timeline - Clean */
        .wound-timeline{display:flex;flex-direction:column;gap:var(--space-4)}
        .wound-day{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
        .wound-day-header{padding:var(--space-4);background-color:var(--surface-2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:var(--space-3)}
        .wound-day-badge{background-color:var(--primary);color:#fff;padding:var(--space-2) var(--space-3);border-radius:var(--radius-xl);font-weight:700;font-size:.85rem}
        .wound-day-date{color:var(--muted);font-size:.85rem}
        .wound-day-content{padding:var(--space-4)}
        .wound-day-photos{display:flex;gap:var(--space-2);flex-wrap:wrap;margin-bottom:var(--space-3)}
        .wound-day-photo{width:80px;height:80px;border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;border:1px solid var(--border)}
        .wound-day-photo img{width:100%;height:100%;object-fit:cover}
        .wound-day-note{padding:var(--space-3);background-color:var(--surface-2);border-radius:var(--radius-sm);font-size:.85rem;color:var(--text);line-height:1.5}
        /* Doctor Mode - Clean */
        .doctor-mode-card{background-color:var(--surface);border:1px solid var(--primary);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-3)}
        .doctor-mode-section{margin-bottom:var(--space-4)}
        .doctor-mode-title{font-weight:700;font-size:.875rem;color:var(--primary);margin-bottom:var(--space-2);display:flex;align-items:center;gap:var(--space-2)}
        .doctor-mode-value{font-size:.9rem;color:var(--text);line-height:1.5}
        .doctor-mode-list{list-style:none;padding-left:0}
        .doctor-mode-list li{padding:var(--space-2) 0;border-bottom:1px solid var(--border);font-size:.875rem}
        .doctor-mode-list li:last-child{border-bottom:none}
        /* Export Cards */
        .export-card{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-3);cursor:pointer;transition:all .15s}
        .export-card:hover{border-color:var(--primary)}
        .export-card:focus{outline:none;box-shadow:var(--focus)}
        .export-icon{font-size:1.6rem;margin-bottom:var(--space-2);opacity:.7}
        .export-title{font-weight:600;color:var(--text)}
        .export-desc{font-size:.8rem;color:var(--muted);line-height:1.4}
        /* Speech status indicator */
        .speech-status{display:flex;align-items:center;gap:var(--space-2);padding:var(--space-3);background-color:rgba(220,38,38,.08);border-radius:var(--radius-sm);margin-top:var(--space-3)}
        .speech-pulse{width:10px;height:10px;background-color:var(--danger);border-radius:50%;animation:recording 1s infinite}
        /* HTTPS warning */
        .https-warning{background-color:rgba(217,119,6,.08);border:1px solid var(--warning);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4);text-align:center}
        .https-warning-icon{font-size:1.6rem;margin-bottom:var(--space-2)}
        .https-warning-text{font-size:.875rem;color:var(--text);line-height:1.5}
        /* Language (legacy) */
        .language-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-2);max-height:200px;overflow-y:auto;padding:var(--space-1)}
        .language-option{display:flex;align-items:center;gap:var(--space-2);padding:var(--space-3);background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;min-height:44px}
        .language-option:hover{border-color:var(--primary)}
        .language-option:focus{outline:none;box-shadow:var(--focus)}
        .language-option.active{border-color:var(--primary);background-color:rgba(14,165,233,.05)}
        .lang-flag{font-size:1.2rem}
        .lang-name{font-size:.85rem;font-weight:600;color:var(--text)}
        /* OP Mode Toggle */
        .op-mode-toggle{display:flex;gap:var(--space-3)}
        .op-mode-btn{flex:1;padding:var(--space-4);border:1px solid var(--border);border-radius:var(--radius-md);background-color:var(--surface);color:var(--text);font-weight:600;cursor:pointer;transition:all .15s;min-height:48px}
        .op-mode-btn:hover{border-color:var(--primary)}
        .op-mode-btn:focus{outline:none;box-shadow:var(--focus)}
        .op-mode-btn.active{border-color:var(--primary);background-color:rgba(14,165,233,.05);color:var(--primary)}
        /* Clinic Call Button */
        .clinic-call-btn{display:flex;align-items:center;justify-content:center;gap:var(--space-3);width:100%;padding:var(--space-4);background-color:var(--success);border:none;border-radius:var(--radius-md);color:#fff;font-weight:700;font-size:1rem;text-decoration:none;margin-bottom:var(--space-4);cursor:pointer;min-height:52px;box-shadow:var(--shadow-2)}
        .clinic-call-btn:hover{background-color:#047857}
        .clinic-call-btn:focus{outline:none;box-shadow:var(--shadow-2),var(--focus)}
        /* Custom Day Input */
        .custom-day-input{display:flex;gap:var(--space-2);margin-top:var(--space-3);padding-top:var(--space-3);border-top:1px solid var(--border)}
        .custom-day-input input{flex:1;padding:var(--space-3);border:1px solid var(--border);border-radius:var(--radius-sm);background-color:var(--input-bg);color:var(--text);font-size:.9rem}
        .custom-day-input input:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus)}
        .custom-day-input button{padding:var(--space-3) var(--space-4);background-color:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;min-height:44px}
        .custom-day-input button:hover{background-color:var(--primary-2)}
        .custom-day-input button:focus{outline:none;box-shadow:var(--focus)}
        /* AI FAB - Subtle */
        .ai-fab{position:fixed;bottom:calc(90px + var(--sab));right:calc(16px + var(--sar));width:48px;height:48px;background-color:var(--surface);border:1px solid var(--border);border-radius:50%;font-size:1.3rem;cursor:pointer;box-shadow:var(--shadow-2);z-index:99;display:flex;align-items:center;justify-content:center}
        .ai-fab:hover{border-color:var(--primary);box-shadow:var(--shadow-3)}
        .ai-fab:focus{outline:none;box-shadow:var(--shadow-2),var(--focus)}
        /* Doc Checklist */
        .doc-checklist{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .doc-checklist-item{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) 0;border-bottom:1px solid var(--border);min-height:44px}
        .doc-checklist-item:last-child{border-bottom:none}
        .doc-checklist-check{width:22px;height:22px;min-width:22px;border:2px solid var(--border);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s}
        .doc-checklist-check:hover{border-color:var(--primary)}
        .doc-checklist-check:focus{outline:none;box-shadow:var(--focus)}
        .doc-checklist-check.checked{background-color:var(--success);border-color:var(--success);color:#fff}
        /* Hygiene Tips */
        .hygiene-tips{background-color:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .hygiene-step{display:flex;align-items:flex-start;gap:var(--space-3);padding:var(--space-2) 0;font-size:.9rem;color:var(--text);line-height:1.5}
        .hygiene-step-num{width:24px;height:24px;min-width:24px;background-color:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.75rem;font-weight:700}
        .shower-tips{background-color:rgba(5,150,105,.08);border:1px solid var(--success);border-radius:var(--radius-md);padding:var(--space-4);margin-bottom:var(--space-4)}
        .not-needed-ambulant{opacity:.5;text-decoration:line-through}
    </style>
</head>
<body>
<div class="app" id="app"></div>
<script>
const LOGO_BASE64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAABN9ElEQVR42n29e7jtWVUdOMZc67fPPufccx9169atKqoKUBCIIg8FBcT4DCAKiFGMxqTTsU2i3YlE09FOd/TrJD7y8PF9iflMop2oMZrPTgwF+AARFAERUEreVPGoB1VFve77nL33b83Rf8y11u+3T/H1/a5lUfeevX+Pteaac8wxx+B69bDlk0R2OVF/SQJAGi3+J/ofGQGgAIejXxuxGt1FF4ogUJAEYf6L8bME4g8IuGQ0I0jGR6/L9FOkCxBkoCADSEIAQVJxcfFl5FgvjS6ZO1L/UIfAuBqREImREEkgQSOxpCXRJdf2JQNxEwRp8bX1LhwiRMqITCRqkbibuEhIpEsAhelxtTuv996uHUTcFXIeTguEdOxnSItvVXuEBoC6NurS2q9suBpRJJGZ3CFl09dA3h87AdP21Qj1o+PSBJhIFIAUZCYAckJy1SWAuHC1JyXSBAok6pdJThGFMCADRYQIgnRJBrgAwoEEIIFpur2+atrDiWuLHwcV/1kCCVBCEUZJgG9cKok8MeDkwvYyQbg+18PffsEUQGbA+h8J6K86bklkffTQ5VGPrHRljeIkaJQRgAkSRLC4psfeloHVZz5dDlnX1PwSQdTFDjhFEZDIpHr7xzZVfX0S5UDStA9gcLAQGSggJJOpPn2ByAIEJIPBYkVbXbyzyyEI6ysE0AiQ8SjqwyJAsggFee26eqhHV2V/8Ot2eLBIAFzxCFkXj6utyynS5LYppNmXU23HAyQOR3/wyC+tTLJkyslboCEAihsot2+CRFD1I+SgteVEQoLFvU07nZIMMhlYYhkITpi1NWFAPCDOlggAj00dn24ECjyBiiAHZMABFxIFk4OWJKecXLT4hHab0vZWbUFzFlLqV7dAglF11SXSDK50caXLaz9Y+PndtExW5h/Hvs36W0GOV9ReP/sfuCsnknjgsDx0CPeUCLF9vaYLivha5NkMajtqfm5EELa+kXuUrJ8HWQIK3GuYTaIMoAx0i8deT6BY+wSkeNOx3WiEBJpJJASBBCkTnSwAhARQlBMZSGJ/4gSS0QUJTlAA4JLYn71U4xfZ7sLhRWx/vf7KZoBdWOnyxm/cLdcvs1r0YX/JZHuDyn05cfoWSMrGUX7vFT264oKW2nJRPat7XGGcYU4W90QjKDhm65T152KZ9v+urVO67RKrK5s9HsgFxpLh9lFSF5MkQ5GBUpzTAB0wSVSut4RCCHAYY0fMQmPfoXF2i7OYqXY+RMSPvyZBGmssR10K6qcsMuGye6/q6jjevG8Dk9ejBQTcp9WZSZtvvbioRK6Euy77tQ1zIuSaQoYBIhUpBllQz18UiFSKJKRFjBZl6gXS2gmxdUoBgoGx5noeochkyHioAERR9ecjUsYFi7GsMimwQIRQrJjqthVoqoFVlNEEgYhIWQ9XQdBshfScpR7GcdrF3hsFB6zdS/uYngOSZCYvrNKq+G0nyjIn13SitDO9Pk0Y6xoQkIiV9PGLfrhJQ5otk35YUkLkde2bQQkujF4fjbXIL9JJJ5xQori19tsG0ey4ltqmJmHGfoa0E0dbya5Ei7NgBOMNGxD/yQA6NZoXorC4wTnfhfVJcBapk2CCqa9Y1rSW064ukMtbqJXk7q6eu7bzQ1AyHI3prkt+OBbj7FztJ3nx0v666tN3fewSjkYlGqmsY2d37DQjtw4twuN1DpnGviTUj834dptnny081VVBjJJDEYCsXm0NDC7M8sJ2FY4N4CwgKVIUDKBJXnPQ+TWLpMAFsSAen/nP/6F6S1vrr8eYjWvKK9VvYzqm5z9mwCgllqecTsuUXGorSBJYSukHL4HRy8cv8erGksnhNCXQRCdSHE2cHloURdx+PWZK04YSADOaWkIclc2UDHtsk7jhAnkUYejv7PivXhxGarkBPDJqypwRDxkHiTmU45rVq0twmWB9AWwlOe2vcX4ERQRtxRqxVpyD8+zYt38GnJKzmkKsi5apPOV0ykxe3wAk2VS3CoA+dUVX15bYoyVdGiEHRqKw7rmRKhS2HlBPF+CCxXnb0ypJhINen1c/n4nZ6cT66G1aX2QcfTLKTKTHU4pPN4IFcIO3oqoAkpU4hkEniskhd8ldEQu9bviI6S2OEIKcKECkw5FMqZ0GIDb1/czqfRYBW0GiHi/zfB9GXd3w7kteYzfrP3JPd81w/9Xy6KENecoj5QS8YwBx7yVOZdoIRWbXdkELkS4zDvFVcZCxPd/IMKZynf1AEmBkqTklBPXkVf0W2/uYctF6fBoQqT4EB0AmodRyM37eLWJse/YizcDHhSHZdLrF/oQTJIvXbESKVW+clQmcl73zNUnI5ZIlPLzW3rVy036KgxNS7nvw2qbcd5XJGDWewHi8EAF3FynVXGuosABlAjkLtu1wjh+YH7QtAkToevyxMqU2UUQBcLnJWIuY+jfTVuBgIEYWQdliQ1Ewk0CU6RkYgajei2oKIhesF7cyp9dqeeuBKqo8Vyn9FGiBjoCsHg51kaKH67hNOVwyUcICvP+an9qxvcRYRh2n0WeuaXQzzuq/XkLI6Bb30GIcDTK12vfxR5pQvK1Ux3bqH4l2/QLMCpF683WJGsFYcuzXs11CsFeYrKtGhUUWqWchASRXRUtcbMelzwCaDu5FXIr/wuk7SQhFm8cjdv0ZN5xOkURIRe4uSa7Il+qCMaLI7r9a+smZA+C8uPaLa+4mjW2zC48retTRzFhTmXSgOCB6Rpo/INFGd7Jv53rnfZf2co6AzQ5Ciwc35aLA9v8fW8Ja8RM4HKIJztILb7gqWqcoyNxrlVffVA+PKg1bajkpFQVI39KOjeQKRK+nytNFRzVAqUQEqxia19xwHmqFgbiw4uW1HyyseEu+HzrE6OaExYE/lcbtugiIkVS0e5cDo0lUEqcjudWYDm56/NYUCWS9EI8HtLWy5kl6zfDqOopDgZwurG7hpNgAhJnH2R+5vNNkBsHjLJDNUkOb1yAdB4+Ci/RYJXJJYyCrMICB/rnqL/QUI6KGwSkSTm2IMX6bitU7LpEDwB48lNwJZCMOR11aKwUMj5ISvYVwclavcMKFVVEm1u1cK8qG2qieui6NziEOsTjqW+h01YBj20B4HL2ueFxe0QW0dDfCGulS1MEe4SKyFdIoej13nDJ4hGxRifVw70vSathTwywDRWrVNUTQgQb4xCOPd9Ris2bbkzLJo0L2qHncQfPArNpHg2a8vNFh0W5mBvHYSmu3wWpQdiVLkquUbeC+ome5r96KOBIFxRsIk2prIRIdG1Xr00iMW/UWWDy3C52av1l7nQ1racdtVBU0gmZEW4P1k2ESrO316QCVRT8n9bNVaNiGpsRlOvfq2WdGEZuiCQ5ijwlbmUGtIiFzOZOzDFKSF4PgBaQSCHCkEsBkcuHSBnsDzaXHjtqZQweSxOJIyXPuuGc/AzoMnYA0RXRBTo+s2uXw2LwSII6RuENkrd+nhtCsAAosbfa2HTLICqMEkRKV6sHPGXRbtxTptAK6RbFcU98Glk1Qfk2V4oI4teUItZy3QlejK6JXL2VEONw7SNT+qKA4NDIJNGUnR5MLUAahyHWUASZzAwi7uJKkfG3UYbEUEEEN8QLMXYkCS3HrjcN52SWAGIFcDxeWBhb2UtklM4OgIpmZ15KBHcrhtJqmhRsPtyGM9UCyeiprDt4HfgwkquVBEo01XLfYTMFsK6nwwGZngGGD1VjLLLK4is+2CFsFAUNtOBCk5IJcGZwOOyGpNU2p1A4eJou4Z4QOR1zdeL6y1uhcpIAVWkYveGB/tGQViJkDwtFRE/JU0RNUBstWBdIeSBEbBN8S/gjbtbKtu4lTJgJH+yj1RY9ez0VqLpBxR2JklPVQokd50v7ydqFa05+pu8K2S2qMISUUj2etaITXnlXrVnmsAXmpkNH8jBdQItq0HqCMSK3PB8qIjezK6PnqWEueduzWDjiVAqixqKPVMZKIoPPnpXqkgSbjtFymZnYAWDtTtkc3HkP2OUPnElhQWwskKUbOoGSUolxSrYQL3ASDq+JUKkZZSqhhPwrqYxSBilHTxe1GvAMU29OPu+gROO6nUJZEh0Z6imMoVnsFivsiaQm7yeqnlVaH0sijEXldxEjEp7VQzypzIzzARRKOqCEjgLQIXtdXLf0YW7v2fRtyCRDuYmHUsbFe1NEFaqp4elfUJEFJcAehEyeGnR1s1vNzGQB2SqZDDhEFyAmLAZuCy1fWbOnHPP5YfVothnXojjWpNaB4XdSQQxhr7UaAWaXdtxPGyLVEV0LHlXq6JxmRrT4H9WZza6SuC/NajXfCGrbZwqDXGrPGpWyka/QtPDl2CwRDMBK22qiRGvbINnqsyX6EiWbUjJKhqVSLHqMXLfeGnPGut7/7rW9620c//JHNem3JoPYe3eNf4mBc7u8/5Que+uKvfvHzXvg8OQ6vbswq/hrrLp5+i4INMo9l1ZL6UoEQbUaRHGqx5O4YHSCzRbjwJDqSt9Yqt1p8nohk1skoW+ceAXB08L2f3WwKj6GyZtZOlJJEsOejcGFTOFXL7KVswMmadeAD1vTWCBCgBC5mDb843zUD1DkdEdpsysGp4RN3fvqf/PA/feub/2BzdGTDRIBoT3Bq1UT/UqXknZ2v/Oqv+Mc//iNPfuoTL19a7wxpujHVs9RrA7iHmLoER5eUNu7F/bodXbebTi2twp7uFw7LY0e6uDZaqrcUsacTW2rY8WQwMgCJiQIyb6LQEsV3PzBWyEea57Zm1krXwihQY7UTRRgLFQ3CiK50wZOiZQg28DMiVUNea1W+MARzwWr3vB3hlcVTIWl3X55I73/fB777NX/rgfs+e/K602TgxBFnrYXLWXe33ry5dOmxi+dvPPfv/vPPP/f5z7p6eZOSzXhlNausXLJOMVF0hGxTHChPPLAzuxnQY1c2dz80LjJuOzfsLxeAHrk2fuqyHENiNH/YPo2AMpFs9h01gKsYcpm2OM1oxnc/MGpWavR3UNtYBnAkYDCbIrtcGD0YUSa6WKiUVF+VtwpRbfHXXnnLCRakzTpK7SW1Ni8hYWcHD372oVd93bd95jMPnTx9sqw3oqCxtbJrEiLI6jZX79gINgzDlcuXz5697r/99n+96Qk3rtbFaJh1P4g5LwPBayqyUQ6Mn3cyHezkex89/L9//fC33oMHLyCTN5/Sq1/IH37N3pkTy0ur9ccv0DkkTN14Eskio9V2de+SoieZ5A5zJgOyRut9ohZTew3ZiiZlB0donMBMkMgJiXK6QHoC6EyBXpM0i34JbQoYHX7jOEPiYsnHQeCsWaqknaX9qx/71/d+4t6DMwfrcR1ZNzgAA2GAkQYOYBaSkMn6W0gQN5vxxMmD+++7/1/82M8slyafs8FqS1ut7UZhdBRxlEvjkw7SwU760P1Xv+ofX/33b9i5/9LuYEtq5+6Hdv/FLw8v/v4Ld91/5eTO4oknpDJ6gy+MGpKMlLvL41crRSoM4PTR4JTqsiX/+P5xXuu2hViJWkbOtozy7KnFr9GxAU21tje4US4ktmc5J4eyAhUKYuWUDtaejep3+3KZ7v7U/S/7mlevx3Uybrdl2YgR8h5bNV1mK9ZAYnQl0+t/578/+Sm3rQ7HOIkqxFfLByB4ho4RhMYnHdjp3fTRBw9f9s+uffKBvYN9lI3bBiaaPDE/8hC+9Auv/P6/PL2/M3zk4fHimIcko1KN2dFUnfrFNWNnKixQij6FEFXxppHRhJqLaIsZ1gES1n4Hi83YhOBgXAT7LN4oPAJtjazkrHyrvSwK5nCfaq7OI4jDzN2XO3jfe/700mOPDkOuCEAlmNS/K8LbT1ZyUPyVqKwtYDkuFsOVC1fe+yfvXS7hFcjrxVmlmHglepIq8fQ//tDRy3/i8JMPLPf3yrr4rFmhUsZzZ/GeO3Z/8beukjy1g+KeTNaavEVWkCbUlSxGZ3IRngIHF4ZeRNnsXKrpe+e+RUOh0WcqrSlSVVc/xTAYFhZ0nV5oWs1mZ2TOFM+9vVQ5SsN1tyF/RWZ5332fQQEwAInM5EDkxJQs0RKZyAxlKhkylSo3iNG1T0QikiEB6b577ku2VQ3Xrq4kxyhuRMJvO8Dp3Xznw0ff8ONX7npgZ+8ExkKrNUpQHA2k3BdL+29vh1ROLjlYba3LvQgu0uHAyDQybWgmsENKLDMmHN1znvOfsY33qNdGldCBsXYYPMooMwZRKlGkikcjvJaMHawlIQV1pL/eSKzrGUjOyRy0KP09eC406+ia9T0d9N0OThikLSJ88L2DtG1lLI+nlrByiWztNIxPPODp3fzJRw+/8V9cu/P+5d6+yqaXtvVsi1DgwJBx78O8euT7u4ks7spGQZQnuJhGylAYDYCerCJRQy3W2qPI26gktqk+7GSxOX+68rt7xQcToreA0c2FFBsnTk2b9pQCU9t+1+xElSkbYAVcmUjrTWTruQumKM4Z77I3padPl0GWMO/sNzhK7uDajRpvO8nTu3b3hdXL/+XRR+9b7h9o3DjNgyIAuBst5hbMIxQn82QqjuKwVPn9UhJRWCw66iz0BNRMkvMCtrXK8nbKpM/FxJnoY/E6KgOqUgetEaplwMI01jpeYm+VoBWasaOPUY1xvAveKehMZOpgfKNsasa/hypxTnN6dy8vnMGS4/zrJMb+WhWTb5502s7spnsurl7+M0cfvm/YP0nfFEsIfCe4NLG8RaIYjauCpzxBuzv54qGPRQur1VxhMSUgyQpR1LFvGLYpsb36yMfb6RXlOv4upsIXgJJTNIfEaKlGa4wklQ0FcO9rMuCsBMBcDJChEnjdkeqbIacW91RKJ8Gcjs6kqds0aEeV/T5v1aH28dXaym1AZEYGFOTU0Uj3zZNO2ZndfO+l1ct/9ugDdw8nTqGMzlRz9zrNUWMxnVwuxQ1LGb/r6wbAHjsai6Ll0HI6BjsiAyX42CAQSBFBKgtlyniUi2hbxDpXh/SObYpKZa37wSZExyVW9EKIM35MtUmG2YyTYvao13NeWUWNYRO32U+JqOpysoqetCS189ujvbDFyqGiKa7OtQQSmWYsCAK+LnSVJ59O1+2m+y6vXv6vD//83uHgFEohrebiFiMj7oDJ4EW33qTzZ/n2d5Rv/MryLS8+GN0fuqZs1tjB8Fl548gTz5rqTQ/nRAwAkFdFyZCNAWT2k1DbJ3LLa9XimNpO4RxIrqMZwSiq4EN9UvHWC2rvNLjeTliwmSWz3s3oISmRVmcAZvQnHmsjcw74R4Bs5U9KSIkpTfQ8aeMsKk86bdct032X1y//t4d33DecOI2yEc1pVCElmrlkhiKUUU96Ap54U3rnHeNffM74n3/w1JDSJx5dXV7pYCcuMEBB9o3IYznN49moAIRcXKMwCplMAUzL2Q5LYU6m7lMZU3JzjInq8fQFes0ER7WBsY65Bc0hUKJWwQd1KT6yEYYMlsWECmJMT51E5y+3ula9rajgL9MBwjI4gFYEyVws8lHliafs7DLdf3XzTf/+6P335v2T0EhLlDskJqAYoWRwgxfd9gTecuPwzg9unnOb3/7Dpw+W+b5L6088WnYXyYkUdXXjR0yxkq3Bc2xCDBP4lSsvwLGO4TZjpvHYPJbahNAsty9IiT4bLtCxxyQXjdkw1qVXKwqCznnYUJCiitowjPqkUyYzJg5ZRa69o2hkZVy0zgoVscNqmawMLNwrl6SoFJVbT6azSz5wdfNNv7D607uHgwOU0jkMdClNYwMaxduewFvPp3fdsf6SJ5Q3/PCpg2W658LqAw+Oy0WukZfwTiTokD4n5F3bBOaeDUnI3krVoBOtS5zzyLM28ETaFlpArgxGo8XAWFveBnoJGJTIQhIH+qby0mZ9GM06MC4YVecXVQlmMKQkS63krRhRYDiaGE+5Yx4gFNw+L4zTkAmtlgqS0m0H6bqlPXBtfMX/c/TeT9nBCZUx2nimOggSnBI4WFbl1pt1643pj/98fN6Ty+0/cPJgme6+sP7zB8rukBfJzCyRhPkx6OHYap8IdL3vUDdsHqUUfaKKsUDCKBTIiIFbY5t9ejYGTljHWeNhxDtgtFKwtS9soI/1HSSis7XEObHPWKHzFoXA7Mxu3vYxZX3aYCJ3BS5K66MIksX4I9wMaQC4BkbgSSd43ZIPXtt803+89p5P28kDlE1FvkiXpeAQ1XlX6dZbeMs5e9cHyvNv89f//VP7O+nuC+s/u9/3chqSJWMmg29HgB55IBsOPQP/NGs1Sb1tCSDPxyPVCINRXrqwplJ0k42zCcXG959iXT8/63hdC0ISlAgKQ5wHvtWzr/Ncqn3sQiTTRDdWIgY06jkmPk/P9mulgTaBXeeyKywUAImJHIVbT+j6XXvwcHz5r1x7793YP8A4KiUEnbP2IFpKOBbddrM/4Xx61/vH59+q2197an8n3Xtxfcf9vpdtkWEJydi5tNMo1OPHPjRdbDur1MiDyghymabh24aRsbPfnUgeb6JyyzTNIm7HqYmrqs4dKwVmpCMB0VN3wkkJ48hM3xswpHqWr0ddW/tYYJZggyzDSxsTh3eGlzrDjjGX2YC/WiPGDZqZClZHR08YsEj28FF55a8dvvcenDipshnNTIo2B1FKhTSMZdStT/BbbrJ3/dnmeTf567//1ImddN/F9Z894LvZhgxLllI8fdahlRaip4KjPtYOg0/jwEG2KYJYsvoEvvpL0FTetw90mEulxGvoXIdetk01g8vbgEztEpliRLLic7JKO3CMZ/fs+l3b7y1DQPKHr7mIq0ejcYFgelskQt4AN0hVF4CwHiW9MRsJSZ5SOlyXE2dOffsrvmIBPbIeX/Ubqz++N504pbIeLZHucAS5L9gmMnf3W26xW25Mf3zH+nlP0Bv+11MHS7v34uqOB7RMtshmBstxSWos49m63u7usoM+AbsCwV1sIHXKnScTeZH7xI5VTILVhEl1GCXOSnkyU0ymHx+QmvUJ2ccHg7tmgkwaYRl+yyk7vZMBfPhw9f7DcS3dmvkl+4tze1nE5z/htB8BWBhHcp6Bte0MaZu93TgykpAsrzeF8v/yi3//q1/0xY+tj179m6s/uiedPGm+9gwDXRY9hYIAFCEvuPFm3nQ+v/uDqy+92d/wd04f1MhTdoa0k40JKYEkzRSU9A7SzNCtbVK3xqLIiydaYCvp83wg6/EjU7OI0sgxRilOVE91YJVpNtnbj+k0o9kEUNFniIDypDP5xJDuW69/+IHD37hcDscK0D55WP2jG3b+5nW73/fXX3L33Y/81M/89unzp901m92fIBE2gmivT4yU3OibtSD/9V987Td+/Zc8ujr81tet/uDTduKAGpEMnkOMIna3w8wdgm662c6fy3/y4aPn36w3fM+Zg4Xdd2nzgQc9nn7KsNRETHrvtkkNzOcVKDo1es+Y+8osQMAS9RWk73rtjwRo2DvjPZq2LTSfqwx80639t06dnKrtGIsIPiQx46ZX3GAtnN/jdct019H6JZ++9pYrYLJFtpyQUnp4k153oUjj155avOSrnn15tfr9t3xk52CvgqlRlwXH3Yww0mSJDJpCUF/TZkQpq1/7he975V963oXVtW99w+otn7T9/RAtMJva2/XuBJSim25KN92Y3/eRw+fdoDf8L2dO7qT7Lq3veKAscl4MKeWUE1MbwOUsA5nPVkbfYCNufCJ/NCrlFnob1Mn0Xa/9kbYSGpizFf0n/YiKkNg0nsOpTKvUTePEdGjAFDHRXzmCA3XLgQn6jnuvvvuIpxYmep2Fd8uEWXrLZd94+dqD9JKvetala4dve+uHlgd7LqPlKuNCoxmYYCZasAdiInMsXsb1r/783/6Wl33ZxfW11/zO+s132f6e3JXMSKv00ti8MIil+I3n043n859+7PA55/y3vvu6kzt276XxAw/4Ts6LbDkpZ0vWu320bbAyxseKWDwkD/j4XMhjKo3UTOIifdf3/2hd+o0/HA31RhmojMQ6rkyQsMrnDCxh2igOlvb+rHMq+ssinFwVnFro7F5648XVP310c2qRCjshqp5OIrKlt17xtY9feyK95GuedWW1euvvfWT3xH5rYsYlRpeLdT3LEllGrFerX/m57/62b/ryC6tr3/rm9Zs+lXd36V6Map3gOn9DSfJSdMM5O39uuOPOo2ef9Tf+jetOLe3ey+MHHtQip7o1c28LTXFBLdkZ3YvMZdNznw1JaEIJcIymKikHbSo4XrV9cHyEbs7J7WMGc+YrupaPgCIb3Q1KNksWjTF6sCnYyQLw21c3MFsQG9BBEzaMqQbKKWBI9uOfLdLhj9+89y//8WuSpX/+0797cP5syAolqrHJ69SpGTebcb1a/crP/c+vecWXX1pf+7a3rN/86bR7gloXS6wTeHIwh3rNSMJ1/gY7d/3w/o8dPee68vq/ft3pHX76sfWHHsIipZTqhpHDgWRkPUtV+lTMbMBNx0QYFGej6NGLao2pWbWQMU0UWz0128ttueSxBw25RX+wz600DIpexIEnTqbU3lsiMuAphgWRN9gdHMBnFQGcWVYEN2aHy0VG5VeEIaefeGgjXfuJm/d+8v/8y8n44z/9e/vnzwLF2VjHgOg0rTfjerX+pX/zN779FV92aX34bX+wedPdefcEx+I5k24wqTgksATa6K7zN6RzZ/Of37l6znX++u86c91uvuK4f51uPItFhhlSnI4JLly5itW6liI4rnfhQnp8Y5FdLCaaMjXd8Z7s5M7JV6N0NI4RcWzHbDHRKXnthUzVD06fsocePvy9N931gY989sLFa8VdamPpLjNeu3ztR/7uC7/yubft1ZAW8UoxtVLIEsVWAWDFtUjpJz/r0LWfeMLuj/0f30KzH/upt+6dPyPJKFFFxcw247heb3753/xPf+WVz7+wOnzN29e/++m8PMBYnKluGZZow5fWWPXz1/Pc2eGOO1fPOqPXf8eps3vDG9/20Z/+xfcsDg6MPqfPnTq1/6wvuumFL3rKdWeXly4VzmDOPtgnblH0NNOp6vMimiiM9alkTdPOdYoshQKMurgM6zxCkzSIZrkR86hGYn+f//X/ff+/+w9/fN89l/qgOZgmWkoCHr78tS+49Sufe9sLlvafrnj7vEisEfwBmBeQThZzcSeVn/xsIQ9//Obdf/ZD34yUf+yn3nri3GnJASVyLOPR0fqXfvav/pVXPv/i6vDb37H+3Xtsua8iWQaLGBPzrWRTgctvOJtuuC7fcefqOWfK7a85eXZv8Ttv//hf/t7XHV4uteVNm0fgX8Of3XLrme/+m89/1Su/+Nqhu1O01KJOgXltUvO4PNk05YhZDg0XXErf+f0/GgyFzg20Ofec1qkGnI9JBDW75eYi9vfsJ//VW372p/7o8piW+zuL3eWw3BmWO4vlzs5ysVguFsvFcjmMQ1qV8W+8+plPHviGK+N9zt2EsUl6VAL+PC2TCRyS3nZZK/nXnbCv/YpnbLT+vTd/dLG/B3B0X62Ofulnv+M7X/W8y+vD17xr/Tv3DMv92ElkRbFaLz7WRfHzZ9P11y0+8On1l5zx133ryev3F296x53f/Hf+x9rz3sEyDcNibzEsF4vlENe/s7uzs1xcvLx5y+9+9MKVa3/xxZ+3KVXKS6DDfM7+Oz7o27gljJFatelMAUjf+f0/Mktnq0RdPeWj5OzvAC1qdLiegWDh4GT6+V9453/4N+/evf5UstSGOOmixCKGsqKLtsif+vSFFz7vxi+67ewXJ73uysaZnrGbLhdfoyJhddt5b46ZgIXhrZf9mvvXH6Sv/Yqnjxx/7/c+bDvDZnX4n376NX/1lV96dXP47e/Z/NZ9i539VOQkYYnTY7GYZHHX+dN27szwwXtXzz3lt7/64Oze4k3vvPObv/f21ZgXO3n0qC4DPLAgaLrLHcNgOyd23/fOuz3pxS964uqoxBLxqVVCHJ/5bNy2iU0+R0jVX0Bffayjio2FFjTpLuhH9kFnkOby5W762Mce/j9+9M15b78uYCaBZKrUkjhtzaJacqW3vfvuV339k7/4+oPnZ73+yub0zuKGhV0Yx9J6sZVGUPNGI8zhQ0p/cNkvl/KSE/Y1L3raBpt3/uGHf/nnvus7vum51zZH3/He9evvW+7s2ahJlrHJEMWLdS84d9LOns4fum/1nNO6/RUHZ3cXb3rnXa/+3jccjcPOMimIBRY73NhFRKpoFJ3Me8v3/em9L/yyJ91448F6jDZCIELcAogxR+WPTdi1SUDQcgOcE9FmR0yxp44xhWZ8x8oScJTCnR3+t9s/sLmqYZFr14s0SwYzmqESBWlGJpft7O586r7Ny777Nz/9wIW/eGr3V29Y3H+4ugI+dW+x08C0oFpa6sMthJs7dsx+6kG99t4V5P/kB77hHb/z/d/+Dc8+HFd/9f3r192/s9jTaAVJIJFAFtLbY3R3XH/arj+TP3z/6tmn/XXfcHB2ufidd9z1zd/7hmvjsNjJY6HXbp0B5kxCcposwZLMAogYzMYj3f7GDy4GeAlOcU3DKx/XG2mK243FSeux9QRigoKU0RM80zNLhgYiMSWzZBbsso7ptb5u/YqU7Mplf8+fPcTdvaIEZkWzIKbVSaUsS7IMy7BES3I7OLn/kU9tXvLd/+OTn3nsRad2f+n6/Ojh6hB86t5i2fTmjEhVMcsrrczNZctkP/OgXnv3oUnPfcYTD8f1d9xx9N8/M+zseaGH2pWhQARTALIOd9f1p+yG0/kjDx4967S//qWnzu0ufvedn/iW7/vto3Gxsxi8BMZjBjMkMpqz2ZjJ1H4bZMXBxc573//ghUvOnIIP65ACTpI8ULrOmFfvw8yyV06T/n03TOppcf/BwEo0M2ZjTgy0JVEpyJhSMl68dPToxSMukmiwAbagLWgDc2bKTInJkEyW3BJsYMpFdnDmxEfvXr/sb7/+E5+58MKTu79yNl+4tjqEPW1/Z1Fnl+IZeOo0cg89CNsZ7Gce8B+4++jievOaDxz95v15Z8/H0KyhaLBoRFIyCqUAZ0+lG07lDz949MwTfvvXn7x+d3jTuz756u/73ZUvF8ulK1nKVimni0oIsxz/BBOYkLIsI2XR8iI/dmF99fLhIgXQ7Kj5dk2ZSm1GTR3JCazrlAlN2ag/ng/XFVBUNRx7vokUrW5ix7RjoclJMcmsyipZcjMl82RuVEpKhmRISSl5SkppLHbi9MFH7xlf+rfeeNd9j73g5O6vnB0uHB4dgU/bGxaIqcioEpBsQ5ZQtmM0kgb7qYf1vA8d3X7Bhn0rFAdndkvOVJQCoEiiSTp7YGdP5o88tHrmgd/+dadu2F28+d2ffvXfffOR7wzLRRGZsvIgG2BZibAkG8CknJEzc/KcZbGV6yupzfY2Np/MZtQHBZHDWvN0JhFWMZxelFlQl/qM9eM7ai4FQ1tAEdzhirnESRKUlsxyopmlZGYBTVqKKRyzKoPcLoc0Q07FeeLk3sfv3fyl73njx+559MtPLX/5bH742uE18ql7i4GhNEtWzSCZOawGQQMG4uObvLM05oIFYElWR3kQR06CqOtPDdefHD720OqLTvjrv+rk+d3hLe+559V/983Xyk7eW45MWAw+ZE/Z86C0gA1IA7Ipm8yQTDkzJURwMlP8pnUkLKgRxmnaTFMKtF0wTyyqSqk0TVO+M30GHZOymyAMCu7sE9H1L6ZBqcnHmsEIi8dWAQ6voaHCxvVvpjy6nTi5/4nP+Mv+9m9//J7HvvzU7q9cPzx6eLiiPW1/sSAkhA6mWRVMxowOtgzxkUEYpAWQcs2mY9yUfvaUXX9quPOR1Ref1Ou+8uDc7vD777v3Vd//+1fKYlgOLtAy43CixVN2S0opHn1Q3Nu4T4xptXfAOt45iT1zvs7m8NlczK+rvbSt0Af6u9T4THSxoz9bb7ZJpmma4U+JlmApzodgeMVvkTKjtbwu0xPc4CaZkDiKJ07uf+J+vOz73nTnfRdecGr3P58bHrl2dQU+Y28xBIRhYHD9rTB56FYTcjpSfD5ozuRIdRBYLKdP8OyJ/LFHj555wm9/0f753eH333ffq177B1c2i8XujmBMGSkgc7ZWi1mKsy7y5pAsNDGFDl78ppHJOJ+VjkdvPMYAmovhtdR0PrAa/Vp3l8vpMKeVUO0NobM2HDN1A9mlPae5DRAKUemUPYjbOSEoj8nqqW1STDAZFXs5FD8sjbITp/fuesBf+r+9+a7PXHjBwe6v3rDz8OHhIe3pJxaDSTWsORNkVW29isik0FuPFoGTBRmgn9q3Mwf5zgvrZ57Q61+4f353eOv773/VD/7R5c1isTs4TDnX1R3ZshEtA6rSZsZIpGP5xytBNuRIkDO3VRm2a+H5MO2MiBXahVVXy1FFHjtxvXXPFAhvFTeZg66MKSV1me5KgU2R7ViiWZIxFr4Yp1aCGZMhRyRNdUnHrIsly2mE7Z3av+t+f8nf+/0777/4goPlr92weOTw2jXa004shr7DDdNMsxlMMRgLpvguWnbZ6f185iB98sLqC3f9fzxv74bl8Nb33//KH3j7lXVe7GaHIaXpoSfISEvMrKE/G3JCig1tageAUj0VkJPMimN0bFyb4uvia9fatS7aSBsp/ueqaOW+cq//XrRyrIWNuHIeFbU3PFPF4yScOTtO3OcRLWQLooXioqJkqjWLGXPkkGbZLEWcpQ1kRmQXHBShNidk85SQc4HtnTpx1wP20tf+4cfvu/BlB8tfPTdcPLq2pj3jYJGbxnfirCFn7WprUIBQzuzb2RPpUxdXT1/67V+6e9NyeOsd97/qB//o8pEtlllgXcsRYczIgZaRyZSYIn2owYeWyYpKM9WTncy0DKgUl6O4F/eNa1O0Llq7Ns6NY12wGrVyrQpWjpXjqGgtrQpXnlaylbhyBLOBmgmnx7hbp5TWaRfAvcttVu2EEkTe3jaO9WmxEq2lDRlRSTK5JcVLSslSYk7ISSkrJ5kp5VG2e3Lvrgf40h98x8c/c+HLTu7+l3OLC0eHh2ZPP1gMoVNsstzYfYpTMmwzilif/icurZ+20BuevXvzcnjbHfe/6h+84+J6sbO3LIjVYGZRqtckF5aEFAWjc6i5f8qRWwfF2lOu+bRZg1vQ+fGmBlkIlKxpO8/q33ksV1MolNWVLbqrSCM0xqJuudAsJ6peHyHhAIfLxmiBWnLLSlk2uGVZ8sjBWXXb3LKnBMtIOTjPqn8/7ip7GpAy8mKU7R7sfuIhe8k/eNdH773wvIPlr14/XDw8WtGetj8MYbFh8SpDpMyNAoujnF7m6/bzJy6Nz1jgt56194Td4W1//sAr/uG7L26Wi73BVWsRpEGWxJb/WE11YsWQrAk0I0AlWFJK7WeTWL8+dILkXb2mlbuTpNwkxzvXYw/hEzCoYE1u0WeuCKVJXG0fKpy0umsPLooDCaaUC5NsYKAOaZANbgulQbaADeACNpALcAAH2ACkKJXNjME0SwPzosCWJ5affMhe+g//+KP3XXzewfLXzuaLVw+PzJ5+YlgQVCZlqZgZlYQi+HXLfG4/feLi5gsHf8MX7t68zG//4IOv/IfvvrTZWexm96RhYBpiwyENVhGeLMswU0piFPNRUSalrJQ9JaUsDq3STEixcVPDHSrcMYmHzfg/s5FfHuP7xAFsVZKlA6KtbeFkmaveHDOYmZHmUkppZwHLjFUc4d4GpIGWLe3EVKnZYLagDRb4hBnzYPUv5+lATtnyIKTdg91PPZJf+r+/+yP3XPzSk8tfv2G4cni0on3BiTRA9GTVRwYCzu6mG/bTXRfXX5T9jc/YvXmZ/+jDD73ih993cb1c7A5SZs5ICTlbSmRiimQ/gclpHmd4wA8WZ72pFpIRQi3m8YUEy7LE6BeDTqtGN13wdLstPGlht0FfV5JbqLpZE3hsPLb2KoI1eWz6ZEKV2hYbi07sDddft0s32gDLsKy0UIDQiaSiPqaRNBgqyBmxyDJsgA20BdOCcTakBfOOK+2eWH7qEb7kh/74I/dc/JKTy1+7IV86Wl2lPfUg7xnghMvo53ftpr1054XVFyZ//dN3zy/zH37os9/0Q+99bL3c2d9xJOTMnGkZKbklpsw2bBxHMWu9XrN+MNU0KSWmBCbUuBS/syudu/7EwandsbhpJkYaUYFBft1SVW+6HRbio6EmWP8PjePoDSliHUWPPqf1rMjFImykURqlIq3GMiz4ZV94VhtZqnNcdUyi4kKQRR1AmWIj06x1F2qZS0Pcnlp+wrRw2e7B3t2P5Zf+8J98+J6LX3Jy+es3DkdHq0fEp5zMn7+fnrRnX3DKzu7ZBy6svjD77U/fvXGZ//DDD7/iH73/sfVyZzcXGdPAlJEycg5kXKRHLVILrsQUaz/KyawUOWiGZdLMWpVlycxSTtroS595bm8vrb3LJvT0hZHMC3NpmjhO03xQvxKZukpHn9Ct8V0UOIorx1HBYeFhiQQWozA2TXgar630jV/5hIMztlmL2WqGTk06hZwg1/D5ir+gWebbvtPbnyZYsrRwpd0Tu59+LL/kH73nQ/dc+JITO//9xuFp49Hd1zYPuD8mv+fI7764+tYD/tYX7N60k9/2oYdf8X/dcXG9s7M3OMyyMTEiiVnuWmshgRR4N4wBMEy1mMWqt8A0IuxEQ4kpbQoOTqeXf82th+s6DjIJYW2XXpidlKpPY4uXIiXe/snSJfBb44xzTl1Tw6p/mprgOC3ko1GKnzyRf/Mt9/zEz398eXJphuKtB+cx5K2KY9r24CsTq36qq3c7a63FvjPloyUdXl3fcqa87kee9ZzPOwPojy6t33nNL7nOGV98Ij37xALAb//pg9/+Yx++dJQWy+yhFojU5FgJkL7ZKnYwc1JqyGIdQq5KUmxinAKQDC4cXj76we95+iu++pZLVzw3byLV2kjYEh2eGgSEdcCt07QE8TfuGieTstBamOt11HNAXRZregGkAUEGK+4nT+Rf+a1P/utf/ZSQF7tW+2td2s9sMgsIXlc0Dxq1OwaPOBO/qiYJFLxIxZKOrm1O72x+9Ntv+etfc/Ppg+U8L/jMhaOfe+Nn/vlv3FuUh5001rnXPBFVQ5jOC1HqAGyt94Ol2Ag2gQBUjwM6zVS6Bsq1VYHK33nNk//Ky554+apbV7uDSh8eVxU6jPFhFxwlhlSOTW/UMYtfv3NTKSNkXKUdz3gqphlXbeQ0xBEDkQ2WONi3P7rj4f/0urs/+InL41GZ2C/dDK4fD5UJlueRcMaqMYDYsWG5AyDsF1AK6avRdeXw1pvyVz3z9Bc9ae9gNz98pbzvk9fe/pGrDz+wyXvZjEJqghWAi0ybo4JViTZJdfmjRaOs4ix1kimaN5oR7K1ivkRepKc9af+vvfK2Fz7z7OWr3rjMEDyy0CoerQZ2cvL14TZPaG4KyP/ysXXnDcUAzLapTS32QvPSuOWjxkDYar9KxbG3TBv3j33q0kc/eeXClVETG2/erKh6TjHjiPbi4xwzUMTujr37zqt/cufRMGQp7AGEMoao/eG6YFUgR3CUmLBMy0VMylkdy67kmzKu/LlP3XvB009eWY3WCE+tI9ttgFhgPVXh3L6Notmpg+Hzbtt/2pMPltkuX3Wb7BvgbcDatWVsVKc/t+iiTSMnFDyqVAFYHXkQjouc0+EmE616fDWZjqZQXlXTA7g3XjsqEJ7xpNNf/PmnO0+pamB34wzOBFqbjuzkMQCMBWcO8DOvu//dH7lmS7in5sxnUinAcse4u5jqSyWP8bZkE2YeGrc5r6+unvOU/b/3LTc/cllmjawZE5Gc5ns8Cv02ddBNPgJlGYF1weqoXF6VPtNeHSqbPWm4Js2Hq317OG/+VNVE+3NziiSaiK1N0lWYHyptOmzGHK2anOruGMkgx2pdroW+o7X9KM2LibrT2iGfGtHULRAOkHa0qb0zq+4TkFmMEnvTGa2dDKqy5jsVpW04GpHL0UaPXvHHrpWUTCEO2hgehXPEsV4q5iKfnPTAc1jShIfPfDircoTVhWx9MiGbfTqqhrXaaLkBuc3tVmO/As2MHreKCLb5ltpIs9BKmTTM2uiBjLTFJN9MbllATrra4Syr+ZcRGe7a2WE0SGKdWh0fkCebK45VdWb37ntVca02FScDck5DyomWbEEYm4FBO6O6zcs0XLclgDARbdUkOajqZ6Spcq2itz6D7zV3NppZps6BnFy9G2sGpljPzjZWw63J7mpCwbBTiMejPkrfshiqau47pG6Li21x1ijBkmaqb/XCPCBIViTV5v0gwoQ6aDnde0rbVigzjbnoD0froXrxdKxli7nTNmtV09QxP2Q1tbrwHSUSMFZ+Zw3oc42Nrlw3zXdxrq/ZdIahrOqbhmbcG57Fx9TSHT0dbZoc8c5LMy5FMzHtBUlqhrAzLaX5sE3Ndx0QK79sUtYGAoX3hHGKVT1/tiqi2BS7Z1XkTOQufqyK6VWgs5BlkhLYErFssyhVeVTHxaswJ/ZE4FgEHNlfBmbz05Oy9vRBTfGh6xwjqx6RRq9rQ32we2KCWpCFuxvj7HUTtTnT1Nebu5Omxdi9IZtVrkiy2WoIrLLSnMpi0IiUwGzmmqYY2phVt1rqrEyb8K5ensqATFnStthuUTXq7lYYM9Zmp+g/zmObM48wD5emaAphYJ0Oi9+1g8JOCN4KWJPweJUs09xMpY42Guf+VJ2y7J+Dt9Iov3O5p/pWhWPaMtr2KQ1vczSbdJvffXVnUPXDYp9uqOYC0+BfG6KavGJV5bWsecLUNka7/up47jKb7FE6j1kTKqBuue0wnyI8m1fzNKfJyp2DUy64b2vVeIj+NVmPamCt3FTQwgJEQaSv3kSVlTPn/JoCbhIEhJB3V7/eBmHDZqwOcW5hEI2X4dUEqU9fh6olXCylJmS1SFCD+TDZrGt20nHyjajCXVW1pg2vuMPlae43J8gVnnP1Hog2GlGNEqtlRnWVqeKvc3chqDmXTWINrcq0JmGA9plstt71Vs3DxiquNwZ6OVfWdMi6PXxTwqlD7lPTgdMcqqtaSkQ8qD9SjRapyexH8jaFMJPunU02exUFbySmaeD/mGvjXF/Q2uLqBH1T9xx+nGFeGz72UdGgrHzO8A2rLiWTZyFnAlVz1rPPjI5qOHNzOeiQWdexkIfZhtfwY4FW5v5sorcW7mlqNzOl7wwVlQCWwsKt1a/Vehy1jFMIMLm12BYKG/ImcQOX+5apZz++4i8XuJrLrsWVYDqjJ8Os+r2mGWuD7Nn4hDlC1RtySjbr7ELnNicPD9JqGIZ6Nk4BtObrreOiZtE4bcP6c20kWG3gMVBgWMBPBShCqQodJXsTd6yktwgcsLC1rLtfGF1js/qxGonq4nf3yU+nFgwWB3ZVsZB1ZeSqqEcKHuIzcxufaopUQ04lXRL9sWrm0ao2dtHqGs10Q5t1XshpMzEG4tspIrW31jhp2AhjUQ4vphC9qCud6Fxyb7ZNrCqVEucN83ip/Byih2oDFsxQgiX6KBQx10VelVQsRPWFOgM3QmU2+8R2PSM9yRq83mJ585iaD+k4q7KQhCKlJmMJyeEGYx9cruIs9Zk4ghfFpoI/bYDuGjGT+uV8ihCamXEOVQ7JVefIy5StT0Y/8UNrdZm6yqKCN0u0meVlNYOpnUMGbadyIThjePZTnZxZDNSeRIZMzLOdtSW66a5xpj+P5jY+1zuf12lRFzhC7MMm8UtV8SNvCvsJWwqSmNnFx32oEymTqXpp+aQt3uWzZlP8akO65GTQh+qopD4aVNDN2rp4jLb4tNAIGqpKiT+uJ65JTtu67oDC6X3LE2jmWs72Lru9IXukUg481eu8WU0HvY1hWFcBjjVp9SjiNKXBuahlDEyFY2FX6munHSIBDwNTtnIOrOS2sNdTSwVkQpZMEeEmw/l2LG/3vtnEjHsRaQyJrlz9ic1Qz8CwH2/YV01x1JDzUBlUnRDecgZueiXVXMtnOh3bCqtiz9Jm/PSu5uLd/pC5rhvWEDH11Jr2VINuOIme8dj3ssNJs5VisRSKoysktncABV4UO88RGm2jEOugLkoDkmQe+lzsiSfnvgP14TadrLY8WGMizWDOKhULI4p7k3RSLaoRGjpt/KdlF6Ugb9vPKw4GQUhbDAh+jrk8zQzXKgLee7B1iMYE5pijHt3b/lXa0jWoxbFxMhVgg0TrNI0mp4C5lUiY1HhYGbFLKTVx2O2/6ooTrG7P7h/ulFsY0TEG9CuaXPeOh4enahSYGLD17Kdg8PCkL7IUFizWA4c6eDoZFKO9CIylto07yOPdbkTHJRA5C/vH7Bkr7h2ZlUoVRI5Jk024YcbVd8PsrjXbqr12BSHcZKi6viG8yplB9iQwWqYZqeA+Wvt3NRf2aWuOUweVAr1FX5kEL9bcWqPUCPJf+EdGJuVVDlpt66IbY7HCNZuYSCGiUpk07qZKBJobxjWJzOJq3EdJj3PY1aQlVYPqTElVU0KgPnrvNY51sQ5xzviJnpTPNXRZoZf6qD36wTOvZU4spLr/3R+ncsBWExQ21E/V2Ks/hMBiGYrZ0cfWthykLPzFLR4dQZfDYB3aUd+pIShW4wak4jLSgNGbaOZWnwTbvpnRmwCEEQqW05Y6ybaBOTmXfK7y/GqiofTpfTi69C1ypDfe9YRqjsCwKfPJewfHJVRm9nKtY1XXf9Gc1Lht8VRngBUZQWRLpfv3YKbRG5PWlhCiutbkCeOXtTNnGkrpX2hdSyYQPp96olNtMJbJulLHJnhbJPOa6FPNBG2wY0oEk3ahtlRmQl+lGchqsnVvLuuBfTJryuMnre/am22OtTXyhoh/lxdu9r6ULFCvbq5R1RGjXLaJXNfKkdqlDOPt+LZJNLoRDYDgzCZHyHkwch82vK6LGPUsu41o14I3KIODixhj31UTGSahUNttun561jjjUKm5YuXAbwB3LawefL0XpW6p7j1J9U5li6hUKAhFyeGkN3Nu5Plr8/6Zahqdqol9ql5y6kTTRmUIqQpRFi890KdSVYrjFDTrwWxrQLMOGdjWFFslosCAlJKl0tMsm01YTRpyjS4wIT+91iFRYlLKG+BhFdTxRAubeM5KGZ/ZCofCwtzyJDzUjornmEDvOFgXOu4iwo3B77DJ+DPaDC2+RT8rY6sxNLkHOIyS0aVqnxiNVp/OHBnVPYvGUhVVVM1hOwIXOrQ1m22eoLX7X1wBSrSaMU4Qc+e5/UpVS+3LMJMJo4IUONMQiQ9pHzjBFRnXH6RS4B4VbtvqkJnWLgsAcaYJr4aL9fqw90Hi6axdRmRWESbM5PK9D2/VeFpashdUmQIQnisgSeTuYFtFw5rT02y8Ve6qUwm9mVBXSirV4qM2yhvwWfdsnaWUO20Lewspe1eHELq+ZVSMRyOfcW6xt3dtLMhWG81zc1Z2rl6TGhcKqQBTILNaQHN3177o/LAee+lnvVUeU3VF4YEUzEgpOsxI2u6ioKFvrCJxdCI3D9ue2zR6luGYYkFjxEwgieo851ZJ3gsA1W6neTM696Yr7zMDOglj8VIdtNvaaeQ/STWR7EBhEzsbi0aXy71lC5gREo82fuvJ5QtuHdajLMErY9zYpurqFGMCzZEEU7CvmVKMJsOYEg83et4ti887MxyNrScxn1lpA0/FrYhFzYAeSUJAk3EWu4c51IzrKcmxLhjVbaHCQlDq/UFBiol9TAlsl05h1b3r3F42SkWnAqE7WscgRpvZk1oLonSn75mAROcVNNiQXUe6y3uNXjPRInfJOx2wzR+sC7/zmSevO/CrhXmu5d5PoRgYS5VfXLnjwbolc7JrRdft6689+0TxiUQ7Ve61ZYbM6NhIW8lUtWfvo7utWvQytWAFYe1Yee0YeWuwY9t6rvfyZthSbaAaQ35ZFlo6YchWhRnVYuOc3WUVQy7CxuWPU2Pp4tKTaLVMMo+he7lDG6e3kVe29aPqKVc37br4dbvDD77o4GDpV1YiLac+qg5r4qFhDV3VPFmHeZF0adTJpX7oxSdv2l+sNl2vYVqHLno9hJTCcqDaCQufy+wiQn2ZCu1pXW+EVQkpxrw93V4bC5o1bKpoa2U1gP/2g5ujETF5BpXKxnU3SwiXHMjaSWhB5m+7IXpWqcbdyRB7Jo/PSV6rt5WF4rRaUtXIEPSVNFNHF3Bt1O7C7r2y+Y/vv/LnD3tRKEf0vkp/x5wgoZhfp5593r7n2fu3nhiurqq36ew4nZcbNYtcuwWVO04j75R/zXhPoSI1UdY6WaBedYKlhoE2VCWwcEPTvojdIrKIGeIvfHhzYRXMeRjHKiAqj1PXAq+yph5HkhaS17UmjsZtHG2TZTTnTuVNbLYmgJsyZ6gL5k0AlkY05zBshI3TpZ1MEh96ZH3HQ5tPXxpLUX1MbSK/emVQDiTypoP83POLZ10/ELy28aldwLmcc6StLVRSDo5lYpi5T0hV4TYAsYVDeBcMDgftBAzsAvNz4YG5TYCi7XpiQD4Y9MghBusJtFDn9jUxPKIFCQgqRS5azdEMlCsYhTORQMxxlUm0wprvNbZGqqz6R7TeoQOpic8mcD0K4jOv23nOuZ1N6bKlTnCZmLaGsOr7Lo5rG0EawLV7Tco6Xqf68J1l3u42w+i1F9PrlT63FUmNqtFTl2lIvSYMoaOC8DLt8GPTJ6H5bHQvUK29VPKZHdylURi4VVpPXg0hBFDP4SBuTuTqY468PVGd4OJ2ihugovmtzZktlVlSObIVSdXMfhxX135cPpPYFOVa4guTbUuwXTrnPWTSZyaKjYZV8/jqkVUvbKxt9tlqlWnG2mnLzNWdxKFAJSMiFaB4FS+JIGWTPPrUSR6Bkwvl87szQnUQsOCQKzpXnDQWi9C3iJMW8wfyYCuaphRFc54Tp2GQ0Vu0npNDOveUxpakhy7OvA38eG+/yNBEnyVXtZSz2tStTJCiuQPazG5y5mhXRe8ZM9JN2jjGprTFUp76FQ2Xji3mXaW4tT2SNBibjU99GC3RoOjn9i0/YZ/LjOLMtUqcmMdRbksYo55TNaxg7b/Fp8Y0CEVPHXitmLW1wQQK2HjQXCpSOScGdsvQxmWge+MvRHOpbbB+ynTYZqR3Hq00X+d1MRg5epfu3DLz7OZwfYFTyMaVz3UbgrHThCmrKnzvxjQ34CnkoNVCcNJdg9URrQn6cxT5jvmNeymf2cENu/7pKzYc50THQgi5yTbi0wDfaN9Yx6FdohX61Cft4tVsjskT6w8G0edpeWg+eO+yF81tgLZxYnRmw5THxojAlvMcJtdsERKTqA60hg6J++QmXs2HQCFRm6jkVavO5p5QIwydvWvrcfPW+AnSFKFlI+UFA5CM0xw3tHbctMczO5ZJ+4LT5VOX1Rk36kIGzeHLujjT5IWCAjlrEdqAXsXYoHWdurbo1jOSjs/pI3XxlKrj742FK4ZHCdtb3JIcrw8qOC6muq27KdlUbhVZaCu5swQDqE0MdUxXlbICbz+ZjGPRpqp263ipQ9X6VLLeR5SH/9JkCysLlNSNK1dGhbIjay7AE0/AjCbhC07ZycHdCaU4PEAGKVPu5mhN8wnpY4VKWYgZXTJFP6unyMUlYRPH6VSZoBeY6gYrcrVSfJTa/JFGaYSPUGFlC3iN3R51f5F7855WACIaK7fKJcFLJU24VKBicHqpjb/aFKpj0k3p0F25Ns5AHeO7xBtuDcOm0F9pSHVupolUTwMaHB2rUlM7F3YTPv+kKawMTy7sqafG9z/E3cF7P1RCZa6za+oG2M+a9zcCU+lu4w0gE5M3x9uNOHap3cYWbMtPk5ewplSq22y3xkCi6Jqa0oG2x7SfzQ79hpyl1t1pDTIL2fqZ7zxbR2JWJoT5pbU0dCBWXu3q2unIrnPSqF194kzz6N8Og4rfmsd9Ye0Ykm3kX3DSz+yksShwUT77enz40bFl0+alnSKBVnUnzIiKVcdbUEL4RdTTtVvL9p3JVcUxvOL1M0OnEbDq2zcdOVL409cUtpJVZv2cri7oM2pbo+/X+rybttSj19F0+aO238bx2yHaWZTV2g1IxBj+ip4657izb+tqr4DuROcgthzFgmsSPSuHjgoBPetsnXwyQsV1fi990VlfjQaat7hQE+I2gh94YHvPHohrJ2eUSjOrXWwVSVx78CBVbaekNhkay4dFKl76bKJLRVFtmES5xbSwO0oknX2s2hlXEQCse6d9RgdYLkU1GwVU6vhuMKXd3Olu8kg0rdIqK94Wpp4hsODdbzH+tKG+3sBOTPOozb64daYVIwKlwcQJPCx6ykndsGtjDFYFxu6FL7jRTi585Vv0nmaANKP+hTYkHmfWul0lCRxdY0svi1iF6apEnSqRD6H14976gaNQZuru9SYEuUZU1LtrhfQa2NBmP2fqs4wyHe7NMSl8Y12oGsPBBGvWoFW7qo/p1en4LgA0IXl9UKBaMBOFlQo/ayHQJ7ZOzaLW0l4uLzzf2gZRFUVTYj/bi29WKZWBIyYy9aFxJ0bDWPGg+Hlp9mVVXVCTEvumFUjRrgl7+84frg8S5rAgycQa37h7UwIpqhvI6R7NEoNz3var9+bWPSTqRKX6GFZtg6kxn+mk9xGPaiCkmOMurKycaGyFiFKi5DO4sWlhiXKikN6GR7oZg1ukXB3xrdjnUfEX3aDTSyuOyUM1SMabgr9wxp59/Xi0iVFCudEZNKjYBOp+2BXfD4167+aVEy6xmRiv1fUh3CEKVSy0PiimanNLiySkrdC2S6KdJsUm8HbITb8141XPmV6qSdTc3SxN2oRqBjSTRgy29KpiBQSjq6tLzm4wQiAno902hdfP6QldEIOiY1c3+Auny3POpXFEn1jJDfIhoeL86lvskdV47+VhOahULHvm3Mzov/fBmDouVOvwoAIGaM4gTcQSDMPViVQe/xIpRqozRSQ4tkyDW48TanMO1Sub3QwTm05bjGTF2xwJiqnShTpPyBgt2sokLX3Wp9biaZoXnsE2gdN5RT4bnjQ1bdUBt3ivrslXtY4bEkcFN+1t/tKtdN/ySDJu6ZFhQPqmJ/Hc3no1wgwen7htohQlWNXGqfl8CsTUiWIM1EiTq0Sd1qrUBuSZyXvP60NtJIrOxj+t+71u4DYmzj5X55KHlofk4Ag6WKgCh1DAEXD3Ii8huTypn7b+TFOsxTQxQA/Bzhk7CJAlOeXzdV6TehW4mwrlMcDbRgHj5w06GnV6Z/PKJ3OZcvf6aWMIUQQ2+rsLQ+Klzfgbn9SDR8NursLR/QVYqNLPyRqAWMLqgWGQWSnOcVJ5k5a15iPSRuea1Xkcxw6uHNF+JWZzeces43vtCU9WmRLcJgQ2KK3z0hlMJwc2aqy1CjKnWg80Pe5+s1YhjKb0bBzlY2HHXKfp64n9T25ZLNGgQ9fZXf/Wz+N1O8PGxZnJLQCWUki6JqqNhCHxylhed7c+eXnYTT5NFgPJ50znGT5pblaxQ3Yhu34EMsSQ2MqoeB3OxqoiMAqbMbDHep4GzspZm5bbHZGc3Orw+nxEt0Oc3l7kNKm8Du/n2DMwVPc1bSOdrTtNb7zXFKzSscSK1HFW+hYkP02CXi245WD85ielU4u8Ka0vNGNa1BegmjVPsFc2jvI33ac/fSQtErNJUirk40iK00w64+LYj+aZRxbYXBBnnPYygdZgKRxdnf3Rr8TE1IaA5y9AUDZZj6LVG297eCOGkXqlS6yFUaRKB4Q6TUiYMYSDTMwZLbNNNW9KmMbPJ9/n7feK6600roq++Kxedlvesbxp5dW0SeI0GcfSZl0nEkuMNoam6QceLW+9H5fWeWlc0Ldd07fMTcdKZZVmbIhOkSezzazOmmtltOIB2abQIX0uT/Yg8HQv5+aKVF9AO0pi0tadk2HaDFGtjU83WxWYvM6YCE2uotcEqJbJM8mOLiQVB8/omjnGEDOymxEuHo6+P2y+8mZ77rlcnHP64TzQCeI4jk12JAwCUC1KW6U+JFxa+zse8A8+mjZuuyk6B9tapGCBiny2iVm1qCodN6YpaZxQ70YaLgBdtp7GsI5tbc6Xoc1svwcqiGTskgxbc+B14UZS2vRnbFXCRL6wjUuiNhVsgrubFAKbDXVrSHigC0WPE+kmXVwVDan8hTP+opvyqZ20GX3uqH0MYI8dMM7AnhFivP85zycbaXjw6uZPH8adF9K10Yw0arCpr7TxSXmgdcDANvbdNp9Fl6b2QABwjNAxeh0RwJY+Tquqp9hYHW3iFSysuvzQZ0Z2tfTwacLN+3FKkBtH8cloE3W4KbpnNsN61FXt2tHvHVIavcqThCZcWAcvsz7/lD//Bt58Iss5+taE+tYL6INH4zgG5t8ggFnTsFucdxIZcWlV7rzgd13iZ6/xymgFNB9HKOVhaEP0nX94TKYjUDybnCTESgXixukze0BrhO4t1RxWv4k+arOwWCw1pzHMtbl6YhT9t8KaArBIYZi13YEKvNO2Ah+tIbfB2rB+yLqwHit1bifp3K6efh2fcsrOLg3i6FuR+nP+qnttM47cwnC2J9BnysUd6o0s5+Jan7mGz1zR/Z999JGSx53Ts2q90rmqLtVMDyOsHKazqKm3jS2tiFMmNk72rgwy9wJvAyXEjimF1lOjAQg0d00vBT6fHGiZzqaoMf+wra3JGc+HVXaiLarKeqQnYi9jP/t+8pv37eZ9XL8bkx9VMfIY7+D/59f/B4yj++rYYmlUAAAAAElFTkSuQmCC";
const APP_KEY='operationsbegleiter_v3';
const DB_NAME='operationsbegleiter-db';
const DB_VERSION=1;
const MEDIA_STORE='media';
let db=null;
const mediaUrlCache=new Map();
const MAX_CACHE_SIZE=50;

function openDB(){return new Promise((resolve,reject)=>{if(db){resolve(db);return;}const request=indexedDB.open(DB_NAME,DB_VERSION);request.onerror=()=>reject(request.error);request.onsuccess=()=>{db=request.result;resolve(db);};request.onupgradeneeded=(e)=>{const database=e.target.result;if(!database.objectStoreNames.contains(MEDIA_STORE)){database.createObjectStore(MEDIA_STORE,{keyPath:'id'});}};});}

function putMedia({blob,mime,meta={}}){return new Promise(async(resolve,reject)=>{try{const database=await openDB();const mediaId='media_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);const tx=database.transaction(MEDIA_STORE,'readwrite');const store=tx.objectStore(MEDIA_STORE);const record={id:mediaId,blob:blob,mime:mime||blob.type,createdAt:new Date().toISOString(),meta:meta};store.put(record);tx.oncomplete=()=>resolve(mediaId);tx.onerror=()=>reject(tx.error);}catch(e){reject(e);}});}

function getMedia(mediaId){return new Promise(async(resolve,reject)=>{try{if(!mediaId){resolve(null);return;}const database=await openDB();const tx=database.transaction(MEDIA_STORE,'readonly');const store=tx.objectStore(MEDIA_STORE);const request=store.get(mediaId);request.onsuccess=()=>{const result=request.result;if(result){resolve({blob:result.blob,mime:result.mime,meta:result.meta});}else{resolve(null);}};request.onerror=()=>reject(request.error);}catch(e){reject(e);}});}

function deleteMedia(mediaId){return new Promise(async(resolve,reject)=>{try{if(!mediaId){resolve();return;}const database=await openDB();const tx=database.transaction(MEDIA_STORE,'readwrite');const store=tx.objectStore(MEDIA_STORE);store.delete(mediaId);tx.oncomplete=()=>{revokeFromCache(mediaId);resolve();};tx.onerror=()=>reject(tx.error);}catch(e){reject(e);}});}

function clearAllMedia(){return new Promise(async(resolve,reject)=>{try{const database=await openDB();const tx=database.transaction(MEDIA_STORE,'readwrite');const store=tx.objectStore(MEDIA_STORE);store.clear();tx.oncomplete=()=>{mediaUrlCache.forEach((url)=>URL.revokeObjectURL(url));mediaUrlCache.clear();resolve();};tx.onerror=()=>reject(tx.error);}catch(e){reject(e);}});}

function dataURLToBlob(dataURL){try{const parts=dataURL.split(',');const mime=parts[0].match(/:(.*?);/)[1];const bstr=atob(parts[1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n);}return new Blob([u8arr],{type:mime});}catch(e){console.error('dataURLToBlob error:',e);return null;}}

function getCachedUrl(mediaId,blob){if(mediaUrlCache.has(mediaId)){return mediaUrlCache.get(mediaId);}if(mediaUrlCache.size>=MAX_CACHE_SIZE){const oldest=mediaUrlCache.keys().next().value;URL.revokeObjectURL(mediaUrlCache.get(oldest));mediaUrlCache.delete(oldest);}const url=URL.createObjectURL(blob);mediaUrlCache.set(mediaId,url);return url;}

function revokeFromCache(mediaId){if(mediaUrlCache.has(mediaId)){URL.revokeObjectURL(mediaUrlCache.get(mediaId));mediaUrlCache.delete(mediaId);}}

async function migrateMediaToIndexedDB(){if(state.migrations&&state.migrations.mediaToIndexedDB)return;let migrated=0;try{await openDB();const newPhotos=[];for(const p of state.photos){if(p.data&&!p.mediaId){try{const blob=dataURLToBlob(p.data);if(blob){const mediaId=await putMedia({blob,mime:'image/jpeg',meta:{category:p.category}});newPhotos.push({id:p.id,mediaId:mediaId,category:p.category,date:p.date,note:p.note||'',mime:'image/jpeg',size:blob.size});migrated++;}else{newPhotos.push(p);}}catch(e){console.error('Photo migration error:',e);newPhotos.push(p);}}else{newPhotos.push(p);}}state.photos=newPhotos;const newDocs=[];for(const d of state.uploadedDocs){if(d.data&&!d.mediaId){try{const blob=dataURLToBlob(d.data);if(blob){const mediaId=await putMedia({blob,mime:d.type,meta:{name:d.name}});newDocs.push({id:d.id,mediaId:mediaId,name:d.name,size:blob.size,type:d.type,date:d.date});migrated++;}else{newDocs.push(d);}}catch(e){console.error('Doc migration error:',e);newDocs.push(d);}}else{newDocs.push(d);}}state.uploadedDocs=newDocs;const newMemos=[];for(const m of state.voiceMemos){if(m.data&&!m.mediaId){try{const blob=dataURLToBlob(m.data);if(blob){const mediaId=await putMedia({blob,mime:blob.type||'audio/webm',meta:{title:m.title}});newMemos.push({id:m.id,mediaId:mediaId,date:m.date,duration:m.duration,title:m.title,mime:blob.type||'audio/webm',size:blob.size});migrated++;}else{newMemos.push(m);}}catch(e){console.error('Memo migration error:',e);newMemos.push(m);}}else{newMemos.push(m);}}state.voiceMemos=newMemos;state.migrations={...(state.migrations||{}),mediaToIndexedDB:true};saveState();if(migrated>0)showToast(`${migrated} Medien zu IndexedDB migriert ✓`);}catch(e){console.error('Migration error:',e);showToast('Medienmigration fehlgeschlagen');}}

const LANGUAGES={de:{name:'Deutsch',flag:'🇩🇪'}};
const T={de:{welcome:'Willkommen!',subtitle:'Ihr persönlicher Begleiter für die OP-Vorbereitung.',medicalNote:'Medizinischer Hinweis',medicalNoteDesc:'Diese App ersetzt keine ärztliche Beratung.',privacy:'Datenschutz',privacyDesc:'Alle Daten bleiben lokal auf Ihrem Gerät.',next:'Weiter →',back:'← Zurück',letsGo:'Los geht\'s! 🎉',yourOp:'Ihre Operation',whenWhat:'Wann und was wird operiert?',opDate:'OP-Datum',opType:'Art der OP',opTypePlaceholder:'z.B. Kniearthroskopie, Gallenblasen-OP',contacts:'Kontakte (optional)',contactsSubtitle:'Für Ihre Unterlagen.',forEmergency:'Für den Notfall.',clinic:'Klinik',clinicPlaceholder:'Name der Klinik',phone:'Telefon',emergencyContact:'Notfallkontakt',allReady:'Alles bereit!',timelineCreated:'Ihre Timeline wurde erstellt.',daysToOp:'Tage bis OP',quickAccess:'Schnellzugriff',nextTasks:'Nächste Aufgaben',all:'Alle →',timeline:'Timeline',questions:'Fragen',photos:'Fotos',woundDiary:'Wundtagebuch',doctorMode:'Arztmodus',voice:'Sprache',menu:'Menü',settings:'Einstellungen',language:'Sprache',selectLanguage:'Sprache wählen',ambulant:'Ambulant',stationary:'Stationär',opMode:'OP-Art',opModeDesc:'Wird die OP ambulant oder stationär durchgeführt?',packingList:'Packliste',medications:'Medikamente',appointments:'Termine',documents:'Dokumente',pain:'Schmerzen',vitals:'Vitalwerte',assistant:'KI-Assistent',warning:'Warnzeichen',export:'Export',darkMode:'Dunkler Modus',largeFont:'Große Schrift',notifications:'Erinnerungen',data:'Daten',legal:'Rechtliches',impressum:'Impressum & Datenschutz',adFree:'Werbefreie Version',adFreeDesc:'Zur werbefreien Version wechseln',transport:'Transport',transportSubtitle:'Planen Sie Ihre Anfahrt.',departureTime:'Abfahrtszeit',travelDuration:'Fahrtdauer (Minuten)',transportAlt:'Transportalternative',transportAltPlaceholder:'z.B. Taxi, ÖPNV',fastingAlarm:'Nüchtern-Wecker',noEating:'Ab jetzt nichts mehr essen',clearFluidsOnly:'Nur noch klare Flüssigkeiten',woundAlarm:'Wunddoku-Wecker',setAlarm:'Wecker stellen',alarmTime:'Wecker-Zeit',alarmDays:'Wecker-Tage',documentChecklist:'Dokumente-Checkliste',referral:'Einweisung',transfer:'Überweisung',medicationList:'Medikamentenliste',allergyPass:'Allergiepass (falls vorhanden)',anesthesiaPass:'Anästhesiepass (falls vorhanden)',jewelryNote:'💍 Schmuck zuhause lassen',punctual:'Pünktlich erscheinen',woundHygiene:'Wundhygiene-Empfehlungen',hygieneStep1:'1. Hände gründlich waschen',hygieneStep2:'2. Trockener Pflasterwechsel',hygieneStep3:'3. Wunddoku: Trocken? Nicht rot? Keine frische Blutung?',hygieneStep4:'4. Keine Berührung der Wunde, keine Manipulation, keine Cremes/Salben',hygieneStep5:'5. Pflaster ohne Berührung der Auflage erneuern',hygieneStep6:'6. Erneut Hände waschen',rednessWarning:'Bei Rötung bitte Praxis kontaktieren',showerHints:'Dusch-Hinweise',showerHint1:'Kurz duschen',showerHint2:'Duschpflaster verwenden',showerHint3:'Im Anschluss Pflaster wechseln (keine feuchte Kammer)',notNeededAmbulant:'(Bei ambulanter OP nicht nötig)',task1Title:'📋 Unterlagen sammeln',task1Desc:'Einweisung, Vorbefunde zusammenstellen',task2Title:'💊 Medikamentenliste',task2Desc:'Alle Medikamente und Allergien notieren',task3Title:'🚗 Transport organisieren',task3Desc:'Abholung und Heimweg planen',task4Title:'❓ Fragen notieren',task4Desc:'Fragen für Anästhesist und Operateur',task5Title:'🏠 Haushalt vorbereiten',task5Desc:'Einkaufen, Mahlzeiten vorbereiten',task6Title:'👕 Kleidung bereitlegen',task6Desc:'Bequeme Kleidung für OP-Tag',task7Title:'✅ Letzte Absprachen',task7Desc:'Uhrzeit, Ort, Nüchternheit bestätigen',task8Title:'🛁 Körperhygiene',task8Desc:'Duschen, kein Nagellack/Make-up',task9Title:'⏰ Pünktlich ankommen',task9Desc:'30 Min. vorher da sein (nach Anweisung des OP-Teams)',task10Title:'💍 Schmuck ablegen',task10Desc:'Schmuck, Piercings zu Hause lassen',task11Title:'🛋️ Schonung',task11Desc:'Ruhen und Warnzeichen beachten',task12Title:'💧 Flüssigkeit',task12Desc:'Ausreichend trinken',task13Title:'🏥 Kontrolltermin',task13Desc:'Nachsorge/Verbandswechsel prüfen',task14Title:'✂️ Fadenzug',task14Desc:'Fäden/Klammern entfernen (falls nicht resorbierbar)',sutureGuideTitle:'Anleitung Fadenzug',sutureGuideIntro:'Der Fadenzug erfolgt je nach Nahtart unterschiedlich. Hier eine Übersicht:',sutureEinzelknopf:'Einzelknopfnaht',sutureEinzelknopfDesc:'<strong>So wird\'s gemacht:</strong><br>1. Knoten mit Pinzette anheben<br>2. Faden unter dem Knoten durchschneiden<br>3. Faden vorsichtig herausziehen<br><br><em>Häufigste Nahtart, jede Schlinge einzeln entfernen.</em>',sutureDonati:'Donati-Rückstichnaht',sutureDonatiDesc:'<strong>So wird\'s gemacht:</strong><br>1. Knoten anheben<br>2. Faden dicht am Gewebe durchschneiden<br>3. Am anderen Ende herausziehen<br><br><em>U-förmige Naht, besonders wundrandnah.</em>',sutureIntrakutan:'Intrakutannaht (fortlaufend)',sutureIntrakutanDesc:'<strong>So wird\'s gemacht:</strong><br>1. Knoten/Ende anheben<br>2. Faden am Knotenende kappen<br>3. Langsam herausziehen (wie Reißverschluss)<br><br><em>Kosmetisch beste Naht, ein langer Faden unter der Haut.</em>',sutureKlammer:'Klammernaht',sutureKlammerDesc:'<strong>So wird\'s gemacht:</strong><br>1. Klammerentferner unter Klammer setzen<br>2. Zusammendrücken – Klammer öffnet sich<br>3. Klammer nach oben abheben<br><br><em>Metallklammern, schnell gesetzt, schnell entfernt.</em>',sutureResorbierbar:'Warum Fadenzug auch bei resorbierbarem Material?',sutureResorbierbDesc:'Auch wenn der Faden sich auflöst, kann ein Fadenzug sinnvoll sein:<ul style="margin-top:8px;padding-left:16px;"><li>Beschleunigt die Heilung bei bereits geschlossener Wunde</li><li>Verhindert Fremdkörperreaktionen (Rötung, Juckreiz)</li><li>Reduziert Narbenbildung</li><li>Kürzt die Entzündungsphase ab</li></ul><p style="margin-top:8px;"><em>Ihr Arzt entscheidet individuell!</em></p>',acceptBothNotices:'Beide Hinweise akzeptieren',selectOpDate:'OP-Datum wählen',defaultOpType:'Allgemeine OP',noDate:'Kein Datum',todayOpDay:'Heute ist OP-Tag!',dayToOp:'Tag bis OP',yourOpDefault:'Ihre OP',allDone:'Alle erledigt!',progress:'Fortschritt',filterAll:'Alle',filterOpen:'Offen',filterDone:'Erledigt',fasting:'Nüchternheit',beforeOp8h:'8h vor OP',beforeOp2h:'2h vor OP',today:'HEUTE',opDayLabel:'OP-Tag',afterOpLabel:'Nach OP',daysBefore:'vorher',editNote:'Bearbeiten',addNoteBtn:'Notiz',opInfosTitle:'OP-Infos',tabProcedure:'Ablauf',tabPreparation:'Vorbereitung',tabAftercare:'Nach OP',tabFaq:'Fragen',procedureTitle:'Ablauf',preparationTitle:'Vorbereitung',aftercareTitle:'Nachsorge',faqTitle:'Häufige Fragen',important:'Wichtig',followInstructions:'Folgen Sie den Anweisungen Ihres Behandlungsteams.',warningSignsTitle:'Warnzeichen',emergencyTitle:'Notfall?',lifeThreatening:'Bei lebensbedrohlichen Symptomen!',call112:'112 anrufen',contactClinicFor:'Bei diesen Zeichen Klinik kontaktieren:',callClinicBtn:'anrufen',saveClinicPhoneTip:'Kliniktelefon in Einstellungen speichern.',questionsTitle:'Fragen',noteQuestionsText:'Notieren Sie Ihre Fragen für die Arztgespräche.',anesthesiologist:'Anästhesist',anesthesiaQs:'Fragen zur Narkose, Betäubung & Risiken',conversationOpDay:'Gespräch: Am OP-Tag oder 1 Tag vorher',noQuestionsYet:'Noch keine Fragen notiert.',addQuestionBtn:'Frage hinzufügen',surgeonTitle:'Operateur / Chirurg',surgeryQs:'Fragen zur OP, Ablauf & Nachsorge',consultationBefore:'Aufklärungsgespräch: Tage/Wochen vor OP',followUpAfter:'Nachgespräch: Nach der OP',questionTip:'Tipp: Notieren Sie Ihre Fragen im Voraus, damit Sie im Gespräch nichts vergessen!',woundHealingTitle:'Wundheilung',takePhoto:'Foto aufnehmen',opConsents:'OP-Aufklärungen',photographDoc:'Dokument fotografieren',otherPhotos:'Sonstiges',morePhotos:'Weitere Fotos',documentsTitle:'Dokumente',uploadDocsText:'Laden Sie wichtige Dokumente hoch (PDFs, Arztbriefe, etc.)',uploadDoc:'Dokument hochladen',pdfWordImages:'PDF, Word, Bilder',noDocsYet:'Noch keine Dokumente hochgeladen.',voiceTitle:'Sprache',httpsRequired:'HTTPS erforderlich',httpsExplain:'Die Sprache-zu-Text-Funktion benötigt eine sichere Verbindung (HTTPS).',speechToText:'Sprache zu Text',speechExplain:'Arzt-Gespräche direkt in Text umwandeln.',stopAndSave:'Aufnahme stoppen & speichern',startRecording:'Aufnahme starten',recordingActive:'Aufnahme läuft',speakNow:'Sprechen Sie jetzt',speakSlowly:'Tipp: Sprechen Sie langsam und deutlich.',savedTexts:'Gespeicherte Texte',voiceMemosTitle:'Sprachmemos',memoExplain:'Audiomemos aufnehmen und abspielen.',tapToRecord:'Tippen zum Aufnehmen',recordingInProgress:'Aufnahme läuft...',savedMemos:'Gespeicherte Memos',painTitle:'Schmerz',currentPain:'Aktuelle Schmerzen',painScale:'0 = keine, 10 = unerträglich',noPain:'Kein',saveBtn:'Speichern',courseTitle:'Verlauf',lastEntries:'Letzte Einträge',vitalsTitle:'Vitalwerte',newMeasurement:'Neue Messung',systolicLabel:'Systolisch',diastolicLabel:'Diastolisch',pulseBpmLabel:'Puls (bpm)',measurementsTitle:'Messungen',medRecordsTitle:'Medikamenten-Doku',documentIntake:'Einnahme dokumentieren',medicationLabel:'Medikament',doseOptional:'Dosis (optional)',documentBtn:'Dokumentieren',intakesPerDay:'Einnahmen/Tag',lastTitle:'Letzte',appointmentsTitle:'Termine',addAppointmentBtn:'Termin hinzufügen',upcomingTitle:'Kommende',noAppointmentsText:'Keine Termine. Nachkontrollen hinzufügen!',pastTitle:'Vergangene',medPlanTitle:'Medikamentenplan',addMedicationBtn:'Medikament hinzufügen',noMedicationsText:'Keine Medikamente. Plan erstellen!',tapTimeToggle:'Tippen Sie auf eine Uhrzeit um die Erinnerung ein/auszuschalten.',whatToBring:'Was Sie für die OP mitnehmen sollten:',ambulantOpNote:'Ambulante OP',addOwnEntry:'Eigenen Eintrag hinzufügen',printList:'Liste drucken',aiAssistantTitle:'KI-Assistent',medAssistant:'Medizin-Assistent',opPrepQuestions:'Fragen zur OP-Vorbereitung',yourQuestion:'Ihre Frage...',aiDisclaimer:'Dieser Assistent gibt nur allgemeine Informationen. Bei medizinischen Fragen wenden Sie sich an Ihr Behandlungsteam.',woundDiaryDesc:'Chronologische Übersicht Ihrer Wundheilung mit Fotos und Notizen.',addPhotoBtn:'Foto hinzufügen',noWoundPhotos:'Noch keine Wundfotos',documentWoundHealing:'Dokumentieren Sie Ihre Wundheilung mit Fotos.',takePhotosBtn:'Fotos aufnehmen',doctorModeTitle:'Arztmodus',compactOverview:'Kompakte Übersicht für das Arztgespräch.',opInfoLabel:'OP-Information',typeLabel:'Art',dateLabel:'Datum',daysPostOpLabel:'Tage post-OP',noticesLabel:'Hinweise',painCourseLabel:'Schmerzverlauf',average7Days:'Durchschnitt (7 Tage)',trendLabel:'Tendenz',lastVitalsLabel:'Letzte Vitalwerte',bloodPressure:'Blutdruck',pulseLabel:'Puls',noMeasurementsText:'Keine Messungen',currentMedicationLabel:'Aktuelle Medikation',noMedicationsLabel:'Keine Medikamente',woundDocLabel:'Wunddokumentation',photosDocumented:'Fotos dokumentiert',openWoundDiaryBtn:'Wundtagebuch öffnen',exportReportBtn:'Bericht exportieren',exportTitle:'Export',exportExplain:'Exportieren Sie Ihre Daten für Arzt, Physiotherapeut oder eigene Unterlagen.',pdfPrint:'PDF / Drucken',pdfPrintDesc:'Übersicht aller Daten als druckbare Version',saveHtml:'HTML-Datei speichern',saveHtmlDesc:'Vollständiger Bericht zum Speichern',exportContent:'Inhalt des Exports:',opInfoDate:'OP-Information & Datum',painCourseChart:'Schmerzverlauf',vitalsValues:'Vitalwerte',medicationList2:'Medikamentenliste',appointmentsList:'Termine',woundPhotoNote:'Hinweise auf Wundfotos',opDataSection:'OP-Daten',clinicContactsSection:'Klinik & Kontakte',clinicNameLabel:'Klinikname',clinicPhoneLabel:'Klinik-Telefon',surgeonNameLabel:'Operateur',lessEyeStrain:'Weniger Augenbelastung',betterReadability:'Bessere Lesbarkeit',forTasksMeds:'Für Aufgaben & Medikamente',exportDataBtn:'Daten exportieren',deleteAllDataBtn:'Alle Daten löschen',legalInfoText:'Rechtliche Informationen',dataStoredLocally:'Alle Daten bleiben lokal auf diesem Gerät gespeichert.',notSet:'Nicht gesetzt',unknownText:'Unbekannt',changeBtn:'Ändern',savedToast:'Gespeichert',featureNotAvailable:'Diese Funktion ist noch nicht verfügbar.',impressumTitle:'Impressum & Datenschutz',aboutAppTitle:'Über diese App',aboutAppDesc:'Der Operationsbegleiter ist eine App zur persönlichen Dokumentation rund um Ihre Operation.',medicalNoteTitle:'Medizinischer Hinweis',medicalNoteContent:'Diese App bietet keine medizinische Beratung, Diagnose oder Behandlung.',privacyTitleLong:'Datenschutz',privacyContentLong:'Alle Ihre Daten werden ausschließlich lokal auf Ihrem Gerät gespeichert.',contactTitleLong:'Kontakt',contactContentLong:'Bei Fragen oder Anregungen zur App können Sie uns kontaktieren.',versionInfo:'Version 1.0 - Stand Februar 2026',or:'oder',transcript:'Transkript',acceptTerms:'Durch Anklicken der Checkboxen stimmen Sie den Bedingungen zu:',ambulantExplain:'Sie gehen am selben Tag nach Hause.',stationaryExplain:'Sie bleiben mindestens eine Nacht in der Klinik.',iDontKnow:'Ich weiß es nicht',nameAndPhone:'Name und Telefon',letsGoSubtitle:'Los geht\'s!'}};
function t(key){return T.de[key]||key;}function getLocale(){return 'de-DE';}
const DEFAULT_STATE={currentScreen:'onboarding',previousScreen:null,onboardingStep:0,language:'de',profile:{opDate:'',opType:'',opMode:'stationary',hospitalName:'',hospitalPhone:'',emergencyContact:'',surgeon:'',disclaimerAccepted:false,privacyAccepted:false,departureTime:'',travelDuration:'',transportAlt:''},tasks:[],documents:[],customDocuments:[],uploadedDocs:[],theme:'light',setupComplete:false,menuOpen:false,photos:[],voiceMemos:[],transcripts:[],painRecords:[],medicationRecords:[],vitalsRecords:[],appointments:[],medications:[],questions:{anaesthesist:[],operateur:[]},chatMessages:[],woundNotes:[],largeFont:false,notifications:true,fastingAlarms:[],woundAlarms:[],documentChecklist:{referral:false,transfer:false,medicationList:false,allergyPass:false,anesthesiaPass:false}};
function getDefaultDocs(){return [{id:'d1',label:'Personalausweis',icon:'🪪'},{id:'d2',label:'Versicherungskarte',icon:'💳'},{id:'d3',label:'Einweisungsschein',icon:'📄'},{id:'d4',label:'Medikamentenliste',icon:'💊'},{id:'d5',label:'Vorbefunde/Röntgen',icon:'🩻'},{id:'d6',label:'Allergiepass',icon:'⚠️'},{id:'d7',label:'Bequeme Kleidung',icon:'👕'},{id:'d8',label:'Hausschuhe',icon:'🥿'},{id:'d9',label:'Handy & Ladegerät',icon:'📱'},{id:'d10',label:'Brille/Kontaktlinsen',icon:'👓'}];}
function getTimeline(){return[{day:-14,tasks:[{id:'t1',title:t('task1Title'),desc:t('task1Desc')},{id:'t2',title:t('task2Title'),desc:t('task2Desc')}]},{day:-7,tasks:[{id:'t3',title:t('task3Title'),desc:t('task3Desc')},{id:'t4',title:t('task4Title'),desc:t('task4Desc')}]},{day:-3,tasks:[{id:'t5',title:t('task5Title'),desc:t('task5Desc')},{id:'t6',title:t('task6Title'),desc:t('task6Desc')}]},{day:-1,tasks:[{id:'t7',title:t('task7Title'),desc:t('task7Desc')},{id:'t8',title:t('task8Title'),desc:t('task8Desc')}]},{day:0,tasks:[{id:'t9',title:t('task9Title'),desc:t('task9Desc')},{id:'t10',title:t('task10Title'),desc:t('task10Desc')}]},{day:1,tasks:[{id:'t11',title:t('task11Title'),desc:t('task11Desc')},{id:'t12',title:t('task12Title'),desc:t('task12Desc')}]},{day:7,tasks:[{id:'t13',title:t('task13Title'),desc:t('task13Desc')}]},{day:12,tasks:[{id:'t14',title:t('task14Title'),desc:t('task14Desc')}]}];}
function getWarnings(){return [{title:'Starke Blutung',desc:'Blut durchnässt Verband schnell',icon:'⚠️'},{title:'Hohes Fieber',desc:'Temperatur über 38,5°C',icon:'⚠️'},{title:'Atemnot',desc:'Schwierigkeiten beim Atmen',icon:'⚠️'},{title:'Starke Schmerzen',desc:'Trotz Medikamenten nicht besser',icon:'⚠️'},{title:'Rötung/Schwellung',desc:'Zunehmend um die Wunde',icon:'⚠️'},{title:'Brustschmerzen',desc:'Druck in der Brust',icon:'⚠️'},{title:'Verwirrtheit',desc:'Plötzliche Orientierungslosigkeit',icon:'⚠️'},{title:'Übelkeit/Erbrechen',desc:'Anhaltendes Erbrechen',icon:'⚠️'}];}
function getOpInfo(){return {ablauf:['Sie kommen nüchtern in die Klinik','Aufnahme durch das Pflegeteam','Gespräch mit dem Anästhesisten','Die OP wird durchgeführt','Aufwachraum zur Überwachung','Verlegung oder Entlassung'],vorbereitung:['Nüchtern erscheinen (nach Anweisung)','Medikamente nur nach Absprache','Kein Alkohol 24h vor OP','Nicht rauchen (mind. 24h)','Alle Unterlagen mitbringen','Begleitperson organisieren'],nachsorge:['Wundpflege nach Anweisung','Schmerzmittel wie verordnet','Körperliche Schonung','Kontrolltermine einhalten','Bei Warnzeichen melden','Krankschreibung einreichen'],fragen:[{q:'Wann darf ich duschen?',a:'Nach 24-48h mit wasserfestem Pflaster.'},{q:'Wann darf ich Auto fahren?',a:'Frühestens 24h nach Narkose, ohne Schmerzmittel.'},{q:'Wann kann ich arbeiten?',a:'Abhängig von OP und Beruf – mit Arzt besprechen.'},{q:'Wie lange muss ich nüchtern sein?',a:'Mindestens 6-8 Stunden vor der OP nichts essen, 2 Stunden nichts trinken (klare Flüssigkeiten).'},{q:'Welche Medikamente muss ich vorher absetzen?',a:'Blutverdünner wie Aspirin/Marcumar oft 5-7 Tage vorher – immer mit Arzt absprechen.'},{q:'Was passiert wenn mir nach der Narkose übel ist?',a:'Übelkeit nach Narkose ist häufig. Medikamente dagegen sind verfügbar. Langsam trinken beginnen.'},{q:'Wie lange dauert die Aufwachphase?',a:'30-60 Minuten im Aufwachraum, vollständige Erholung kann mehrere Stunden dauern.'},{q:'Wann werden die Fäden gezogen?',a:'Je nach OP und Nahtmaterial nach 7-14 Tagen, oft beim Hausarzt.'},{q:'Darf ich nach der OP Sport machen?',a:'Leichte Aktivität meist nach 1-2 Wochen, Sport je nach OP erst nach 4-12 Wochen.'},{q:'Was soll ich bei Fieber tun?',a:'Bei Fieber über 38.5°C nach OP sofort Klinik kontaktieren – kann auf Infektion hinweisen.'},{q:'Wie lange werde ich Schmerzen haben?',a:'Akute Schmerzen 3-7 Tage, danach abklingend. Schmerzmittel nach Anweisung nehmen.'},{q:'Kann ich nach der OP normal essen?',a:'Erst klare Flüssigkeiten, dann leichte Kost. Bei Bauch-OPs spezielle Ernährung beachten.'}]};}
const AI_RESPONSES={greeting:'Hallo! Ich bin Ihr medizinischer Assistent. Ich kann Ihnen allgemeine Informationen zu Ihrer OP-Vorbereitung geben. Wie kann ich helfen?',narkose:'Bei einer Narkose werden Sie in einen schlafähnlichen Zustand versetzt. Der Anästhesist überwacht dabei Ihre Vitalfunktionen. Wichtig: Halten Sie sich an die Nüchternheitsregeln!',schmerzen:'Nach einer OP sind leichte bis mittlere Schmerzen normal. Nehmen Sie die verordneten Schmerzmittel regelmäßig ein. Bei starken, zunehmenden Schmerzen kontaktieren Sie Ihre Klinik.',wunde:'Halten Sie die Wunde sauber und trocken. Verbandswechsel nur nach Anweisung. Bei Rötung, Schwellung oder Eiter sofort zum Arzt!',essen:'Vor der OP: 6-8 Stunden nichts essen, 2 Stunden nichts trinken. Nach der OP: Beginnen Sie mit leichter Kost, wenn Sie sich bereit fühlen.',medikamente:'Besprechen Sie alle Medikamente mit Ihrem Anästhesisten. Blutverdünner müssen oft pausiert werden. Nehmen Sie Dauermedikation nur nach Absprache.',angst:'Angst vor einer OP ist völlig normal. Sprechen Sie mit Ihrem Behandlungsteam darüber. Entspannungstechniken und gute Vorbereitung können helfen.',default:'Das ist eine gute Frage! Für spezifische medizinische Beratung wenden Sie sich bitte an Ihr Behandlungsteam. Ich kann Ihnen allgemeine Informationen zur OP-Vorbereitung geben.'};
let state=loadState();
let mediaRecorder=null,audioChunks=[],recordingTimer=null,recordingSeconds=0;
window.isDictating=false;
window.speechFinalText='';
function escapeHtml(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
function loadState(){try{const s=localStorage.getItem(APP_KEY);if(s)return{...DEFAULT_STATE,...JSON.parse(s)};}catch(e){}return{...DEFAULT_STATE};}
function saveState(){try{localStorage.setItem(APP_KEY,JSON.stringify(state));}catch(e){showToast('Speicher voll!');}}
function setState(u){state={...state,...u};saveState();render();}
function id(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function formatDate(d){if(!d)return'';return new Date(d).toLocaleDateString(getLocale(),{weekday:'long',day:'numeric',month:'long',year:'numeric'});}
function formatShort(d){if(!d)return'';return new Date(d).toLocaleDateString(getLocale(),{day:'2-digit',month:'2-digit',year:'2-digit'});}
function formatDT(d){if(!d)return'';return new Date(d).toLocaleDateString(getLocale(),{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});}
function formatTime(s){const m=Math.floor(s/60),sec=s%60;return`${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;}
function getDaysUntil(){if(!state.profile.opDate)return null;const t=new Date();t.setHours(0,0,0,0);const o=new Date(state.profile.opDate);o.setHours(0,0,0,0);return Math.ceil((o-t)/(1000*60*60*24));}
function getDateFor(off){if(!state.profile.opDate)return null;const d=new Date(state.profile.opDate);d.setDate(d.getDate()+off);return d;}
function showToast(m){document.querySelector('.toast')?.remove();const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}
function genTasks(){const tasks=[];getTimeline().forEach(p=>{p.tasks.forEach(t=>{const ex=state.tasks.find(x=>x.id===t.id);tasks.push({...t,day:p.day,completed:ex?ex.completed:false,note:ex?ex.note:''});});});return tasks;}
function nav(s){setState({previousScreen:state.currentScreen,currentScreen:s,menuOpen:false});}
function goBack(){setState({currentScreen:state.previousScreen||'dashboard',previousScreen:'dashboard'});}
function toggleMenu(){setState({menuOpen:!state.menuOpen});}
function applyTheme(t){
    document.documentElement.setAttribute('data-theme',t);
    document.body.style.backgroundColor=t==='dark'?'#0f0d1a':'#f0f4ff';
    document.body.style.color=t==='dark'?'#f1f5f9':'#1e1b4b';
}
function toggleTheme(){
    const t=state.theme==='light'?'dark':'light';
    applyTheme(t);
    setState({theme:t});
}
function toggleTask(tid){const tasks=state.tasks.map(t=>t.id===tid?{...t,completed:!t.completed}:t);setState({tasks});showToast('Aktualisiert ✓');}
function updateNote(tid,n){const tasks=state.tasks.map(t=>t.id===tid?{...t,note:n}:t);setState({tasks});}
function toggleDoc(did){const docs=state.documents.includes(did)?state.documents.filter(d=>d!==did):[...state.documents,did];setState({documents:docs});}
function addCustomDoc(label){if(!label.trim())return;setState({customDocuments:[...state.customDocuments,{id:id(),label:label.trim(),icon:'📦'}]});showToast('Hinzugefügt ✓');}
function delCustomDoc(did){setState({customDocuments:state.customDocuments.filter(d=>d.id!==did),documents:state.documents.filter(d=>d!==did)});}
function addAppt(data){setState({appointments:[...state.appointments,{id:id(),...data}]});showToast('Termin gespeichert ✓');}
function delAppt(aid){setState({appointments:state.appointments.filter(a=>a.id!==aid)});showToast('Gelöscht');}
function addMed(data){setState({medications:[...state.medications,{id:id(),...data,asNeeded:data.asNeeded||false,alarms:(data.times||[]).map(t=>({time:t,enabled:true}))}]});showToast('Medikament gespeichert ✓');}
function delMed(mid){setState({medications:state.medications.filter(m=>m.id!==mid)});showToast('Gelöscht');}
function toggleAlarm(mid,i){const meds=state.medications.map(m=>{if(m.id===mid){const a=[...m.alarms];a[i]={...a[i],enabled:!a[i].enabled};return{...m,alarms:a};}return m;});setState({medications:meds});}
async function handlePhoto(e,cat){const files=e.target.files;if(!files.length)return;for(const f of Array.from(files)){if(!f.type.startsWith('image/')){showToast('Nur Bilder');continue;}try{const dataUrl=await new Promise((resolve,reject)=>{const r=new FileReader();r.onload=ev=>resolve(ev.target.result);r.onerror=reject;r.readAsDataURL(f);});const img=await new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=reject;img.src=dataUrl;});const c=document.createElement('canvas');const max=800;let w=img.width,h=img.height;if(w>h&&w>max){h=(h*max)/w;w=max;}else if(h>max){w=(w*max)/h;h=max;}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);const blob=await new Promise(resolve=>c.toBlob(resolve,'image/jpeg',0.7));const mediaId=await putMedia({blob,mime:'image/jpeg',meta:{category:cat}});setState({photos:[...state.photos,{id:id(),mediaId:mediaId,category:cat,date:new Date().toISOString(),note:'',mime:'image/jpeg',size:blob.size}]});showToast('Foto gespeichert 📷');}catch(err){console.error('Photo error:',err);if(err.name==='QuotaExceededError'){showStorageFullModal();}else{showToast('Fehler: '+err.message);}}}e.target.value='';}
function confirmDelPhoto(pid){showModal('⚠️ Foto löschen',`<p style="color:var(--muted);margin-bottom:16px;line-height:1.5;">Möchten Sie dieses Foto wirklich <strong>unwiderruflich löschen</strong>?<br><br>Diese Aktion kann nicht rückgängig gemacht werden.</p><div style="display:flex;gap:10px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-danger" style="flex:1;" onclick="execDelPhoto('${escapeHtml(pid)}')">🗑️ Löschen</button></div>`);}
async function execDelPhoto(pid){closeModal();const p=state.photos.find(x=>x.id===pid);if(p&&p.mediaId){await deleteMedia(p.mediaId);}setState({photos:state.photos.filter(p=>p.id!==pid)});showToast('Foto gelöscht');}
async function delPhoto(pid){confirmDelPhoto(pid);}
async function viewPhoto(pid){const p=state.photos.find(x=>x.id===pid);if(!p)return;let imgSrc='';if(p.mediaId){const media=await getMedia(p.mediaId);if(media){imgSrc=getCachedUrl(p.mediaId,media.blob);}else{imgSrc='';}}else if(p.data){imgSrc=p.data;}const v=document.createElement('div');v.className='photo-viewer';v.innerHTML=`<div class="photo-viewer-header"><span>${formatDT(p.date)}</span><button class="photo-viewer-close" onclick="closePhotoViewer(this,'${escapeHtml(p.mediaId||'')}')">✕</button></div><div class="photo-viewer-content">${imgSrc?`<img src="${imgSrc}">`:'<div style="padding:40px;text-align:center;color:var(--muted);">Bild nicht verfügbar</div>'}</div>`;document.body.appendChild(v);}
function closePhotoViewer(btn,mediaId){btn.closest('.photo-viewer').remove();if(mediaId)revokeFromCache(mediaId);}
async function handleDocUpload(e){const files=e.target.files;if(!files.length)return;for(const f of Array.from(files)){try{const blob=f;const mediaId=await putMedia({blob,mime:f.type,meta:{name:f.name}});const doc={id:id(),mediaId:mediaId,name:f.name,size:f.size,type:f.type,date:new Date().toISOString()};setState({uploadedDocs:[...state.uploadedDocs,doc]});showToast('Dokument hochgeladen 📄');}catch(err){console.error('Doc upload error:',err);if(err.name==='QuotaExceededError'){showStorageFullModal();}else{showToast('Fehler: '+err.message);}}}e.target.value='';}
function confirmDelUploadedDoc(did){const d=state.uploadedDocs.find(x=>x.id===did);const docName=d?d.name:'Dokument';showModal('⚠️ Dokument löschen',`<p style="color:var(--muted);margin-bottom:16px;line-height:1.5;">Möchten Sie "<strong>${escapeHtml(docName)}</strong>" wirklich <strong>unwiderruflich löschen</strong>?<br><br>Diese Aktion kann nicht rückgängig gemacht werden.</p><div style="display:flex;gap:10px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-danger" style="flex:1;" onclick="execDelUploadedDoc('${escapeHtml(did)}')">🗑️ Löschen</button></div>`);}
async function execDelUploadedDoc(did){closeModal();const d=state.uploadedDocs.find(x=>x.id===did);if(d&&d.mediaId){await deleteMedia(d.mediaId);}setState({uploadedDocs:state.uploadedDocs.filter(d=>d.id!==did)});showToast('Dokument gelöscht');}
async function delUploadedDoc(did){confirmDelUploadedDoc(did);}
function formatFileSize(bytes){if(bytes<1024)return bytes+' B';if(bytes<1024*1024)return(bytes/1024).toFixed(1)+' KB';return(bytes/(1024*1024)).toFixed(1)+' MB';}
async function startRec(){try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});const mimeType=MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':MediaRecorder.isTypeSupported('audio/mp4')?'audio/mp4':'audio/ogg';mediaRecorder=new MediaRecorder(stream,{mimeType});audioChunks=[];mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};mediaRecorder.onstop=async()=>{if(audioChunks.length===0){showToast('Keine Audiodaten');stream.getTracks().forEach(t=>t.stop());return;}const blob=new Blob(audioChunks,{type:mimeType});try{const mediaId=await putMedia({blob,mime:mimeType,meta:{duration:recordingSeconds}});const memoName=`Memo ${state.voiceMemos.length+1}`;setState({voiceMemos:[...state.voiceMemos,{id:id(),mediaId:mediaId,date:new Date().toISOString(),duration:recordingSeconds,title:memoName,mime:mimeType,size:blob.size}]});showToast('Sprachmemo gespeichert 🎤');}catch(err){console.error('Memo save error:',err);if(err.name==='QuotaExceededError'){showStorageFullModal();}else{showToast('Fehler beim Speichern');}}stream.getTracks().forEach(t=>t.stop());};mediaRecorder.start(100);recordingSeconds=0;recordingTimer=setInterval(()=>{recordingSeconds++;const el=document.getElementById('recTimer');if(el)el.textContent=formatTime(recordingSeconds);},1000);render();}catch(e){console.error('Mic error:',e);showToast('Mikrofon nicht verfügbar: '+e.message);}}
function stopRec(){if(mediaRecorder&&mediaRecorder.state==='recording'){mediaRecorder.stop();clearInterval(recordingTimer);mediaRecorder=null;render();}}
async function playMemo(mid){const m=state.voiceMemos.find(x=>x.id===mid);if(!m){showToast('Memo nicht gefunden');return;}try{let audioSrc='';if(m.mediaId){const media=await getMedia(m.mediaId);if(media){audioSrc=getCachedUrl(m.mediaId,media.blob);}else{showToast('Audio nicht verfügbar');return;}}else if(m.data){audioSrc=m.data;}else{showToast('Audio nicht verfügbar');return;}const audio=new Audio(audioSrc);audio.play().then(()=>showToast('▶️ Wiedergabe gestartet')).catch(e=>{console.error('Play error:',e);showToast('Wiedergabe nicht möglich');});}catch(e){console.error('Audio error:',e);showToast('Audio nicht verfügbar');}}
async function delMemo(mid){const m=state.voiceMemos.find(x=>x.id===mid);if(m&&m.mediaId){await deleteMedia(m.mediaId);}setState({voiceMemos:state.voiceMemos.filter(m=>m.id!==mid)});showToast('Gelöscht');}
function startSpeech(){
    if(!window.webkit?.messageHandlers?.diktat){
        return showToast('Spracherkennung nur in der iOS-App verfügbar.');
    }
    window.speechFinalText='';
    window.isDictating=true;
    const el=document.getElementById('liveText');
    if(el)el.textContent='🎤 Aufnahme aktiv - Sprechen Sie jetzt...';
    render();
    window.webkit.messageHandlers.diktat.postMessage({cmd:'start'});
    showToast('🎤 Aufnahme gestartet');
}
function stopSpeech(){
    if(window.webkit?.messageHandlers?.diktat){
        window.webkit.messageHandlers.diktat.postMessage({cmd:'stop'});
    }
}
window.dStatus=function(active){
    window.isDictating=active===true;
    render();
    if(active===false){
        const finalText=(window.speechFinalText||'').trim();
        if(finalText){
            showSaveTranscriptModal(finalText);
        }else{
            showToast('Kein Text erkannt.');
        }
    }
};
window.dText=function(text){
    window.speechFinalText=text||'';
    const el=document.getElementById('liveText');
    if(el)el.textContent=text||'🎤 Sprechen Sie jetzt...';
};
window.dFehler=function(msg){
    showToast(msg||'Fehler bei Spracherkennung');
    window.isDictating=false;
    render();
};
function showSaveTranscriptModal(text){showModal('📝 Text speichern',`<div class="form-group"><label class="form-label">Name für den Text</label><input type="text" class="form-input" id="transcriptName" placeholder="z.B. Arztgespräch 15.01."></div><div class="form-group"><label class="form-label">Erkannter Text</label><textarea class="form-textarea" id="transcriptText" rows="5">${text}</textarea></div><button class="btn btn-primary btn-block" onclick="saveTranscriptWithName()">${t('saveBtn')}</button>`);}
function saveTranscriptWithName(){const name=document.getElementById('transcriptName')?.value||'Transkript';const text=document.getElementById('transcriptText')?.value;if(!text?.trim())return showToast('Kein Text vorhanden');setState({transcripts:[...state.transcripts,{id:id(),name:name,text:text.trim(),date:new Date().toISOString()}]});closeModal();showToast('Text gespeichert ✓');}
function editTranscript(tid){const t=state.transcripts.find(x=>x.id===tid);if(!t)return;showModal('✏️ Text bearbeiten',`<div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="editTransName" value="${t.name||''}"></div><div class="form-group"><label class="form-label">Text</label><textarea class="form-textarea" id="editTransText" rows="5">${t.text}</textarea></div><button class="btn btn-primary btn-block" onclick="updateTranscript('${tid}')">${t('saveBtn')}</button>`);}
function updateTranscript(tid){const name=document.getElementById('editTransName')?.value;const text=document.getElementById('editTransText')?.value;if(!text?.trim())return showToast('Text darf nicht leer sein');const transcripts=state.transcripts.map(t=>t.id===tid?{...t,name:name||'Transkript',text:text.trim()}:t);setState({transcripts});closeModal();showToast('Aktualisiert ✓');}
function delTranscript(tid){setState({transcripts:state.transcripts.filter(t=>t.id!==tid)});showToast('Gelöscht');}
function renameMemo(mid){const m=state.voiceMemos.find(x=>x.id===mid);if(!m)return;showModal('✏️ Memo umbenennen',`<div class="form-group"><label class="form-label">Neuer Name</label><input type="text" class="form-input" id="memoNewName" value="${m.title||''}"></div><button class="btn btn-primary btn-block" onclick="saveMemoName('${mid}')">${t('saveBtn')}</button>`);}
function saveMemoName(mid){const name=document.getElementById('memoNewName')?.value;if(!name?.trim())return showToast('Name eingeben');const memos=state.voiceMemos.map(m=>m.id===mid?{...m,title:name.trim()}:m);setState({voiceMemos:memos});closeModal();showToast('Umbenannt ✓');}
function getWoundDiaryData(){const wound=state.photos.filter(p=>p.category==='wound').sort((a,b)=>new Date(a.date)-new Date(b.date));if(wound.length===0)return[];const opDate=state.profile.opDate?new Date(state.profile.opDate):null;const grouped={};wound.forEach(p=>{const pDate=new Date(p.date);pDate.setHours(0,0,0,0);let dayKey;if(opDate){const op=new Date(opDate);op.setHours(0,0,0,0);const diffDays=Math.round((pDate-op)/(1000*60*60*24));dayKey=diffDays>=0?`Tag ${diffDays}`:`Tag ${diffDays}`;if(diffDays===0)dayKey='OP-Tag';else if(diffDays>0)dayKey=`Tag ${diffDays} nach OP`;else dayKey=`${Math.abs(diffDays)} Tag(e) vor OP`;}else{dayKey=pDate.toLocaleDateString(getLocale(),{day:'numeric',month:'long',year:'numeric'});}if(!grouped[dayKey])grouped[dayKey]={date:pDate,photos:[],notes:[]};grouped[dayKey].photos.push(p);});const tasks=state.tasks.filter(t=>t.note);tasks.forEach(t=>{const tDate=getDateFor(t.day);if(!tDate)return;const tDateNorm=new Date(tDate);tDateNorm.setHours(0,0,0,0);let dayKey;if(opDate){const op=new Date(opDate);op.setHours(0,0,0,0);const diffDays=Math.round((tDateNorm-op)/(1000*60*60*24));if(diffDays===0)dayKey='OP-Tag';else if(diffDays>0)dayKey=`Tag ${diffDays} nach OP`;else dayKey=`${Math.abs(diffDays)} Tag(e) vor OP`;}else{dayKey=tDateNorm.toLocaleDateString(getLocale(),{day:'numeric',month:'long',year:'numeric'});}if(grouped[dayKey])grouped[dayKey].notes.push({title:t.title,note:t.note});});return Object.entries(grouped).map(([k,v])=>({label:k,date:v.date,photos:v.photos,notes:v.notes})).sort((a,b)=>a.date-b.date);}
function addWoundNote(dateStr){showModal('📝 Notiz hinzufügen',`<div class="form-group"><label class="form-label">Notiz für ${dateStr}</label><textarea class="form-textarea" id="woundNoteText" rows="3" placeholder="Beobachtungen zur Wundheilung..."></textarea></div><button class="btn btn-primary btn-block" onclick="saveWoundNote('${dateStr}')">${t('saveBtn')}</button>`);}
function saveWoundNote(dateStr){const note=document.getElementById('woundNoteText')?.value;if(!note?.trim())return showToast('Notiz eingeben');const woundNotes=state.woundNotes||[];setState({woundNotes:[...woundNotes,{id:id(),date:dateStr,note:note.trim(),created:new Date().toISOString()}]});closeModal();showToast('Notiz gespeichert ✓');}
function generateDoctorReport(){const d=getDaysUntil();const recentPain=state.painRecords.slice(-7);const avgPain=recentPain.length?Math.round(recentPain.reduce((a,b)=>a+b.value,0)/recentPain.length*10)/10:'-';const lastVitals=state.vitalsRecords.slice(-1)[0];const warnings=[];if(recentPain.some(p=>p.value>=7))warnings.push('Hohe Schmerzwerte (≥7) in den letzten Tagen');if(lastVitals&&lastVitals.systolic>140)warnings.push('Erhöhter Blutdruck');if(lastVitals&&lastVitals.pulse>100)warnings.push('Erhöhte Herzfrequenz');return{opType:state.profile.opType||'Nicht angegeben',opDate:formatDate(state.profile.opDate),daysPostOp:d!==null&&d<0?Math.abs(d):0,avgPain,painTrend:recentPain.length>=2?(recentPain[recentPain.length-1].value-recentPain[0].value)>0?'steigend':'fallend':'nicht beurteilbar',lastVitals,medications:state.medications,recentMedRecords:state.medicationRecords.slice(-10),warnings,woundPhotos:state.photos.filter(p=>p.category==='wound').length};}
async function exportData(format){
    showToast('Vorbereitung...');
    var rpt=generateDoctorReport();
    var htm=generateExportHTML(rpt,state.painRecords,state.vitalsRecords,state.appointments,state.medications);
    var fname='Export_'+new Date().toISOString().split('T')[0]+'.html';
    var b=new Blob([htm],{type:'text/html'});
    if(navigator.share){try{var f=new File([b],fname,{type:'text/html'});await navigator.share({files:[f]});return;}catch(e){}}
    if(format==='pdf'){var w=window.open('');if(w){w.document.write(htm);w.document.close();setTimeout(function(){w.print()},400);}}
    else{var u=URL.createObjectURL(b);var a=document.createElement('a');a.href=u;a.download=fname;a.style.display='none';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
}
function generateExportHTML(report,painData,vitalsData,appointments,medications){return`<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>Operationsbegleiter - Patientenübersicht</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#333}h1{color:#6366f1;border-bottom:2px solid #6366f1;padding-bottom:10px}h2{color:#1e1b4b;margin-top:24px;border-left:4px solid #6366f1;padding-left:10px}.section{background:#f8f9fa;border-radius:8px;padding:16px;margin-bottom:16px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}.label{font-weight:bold;color:#64748b;font-size:12px}.value{font-size:16px;margin-top:4px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background-color:#6366f1;color:white}.warning{background-color:#fef3c7;border-left:4px solid #f59e0b;padding:10px;margin:10px 0}.footer{margin-top:30px;padding-top:10px;border-top:1px solid #ddd;font-size:12px;color:#64748b}</style></head><body><h1>🏥 Patientenübersicht</h1><p>Erstellt am: ${escapeHtml(new Date().toLocaleString('de-DE'))}</p><div class="section"><h2>📋 OP-Information</h2><div class="grid"><div><div class="label">OP-Art</div><div class="value">${escapeHtml(report.opType)}</div></div><div><div class="label">OP-Datum</div><div class="value">${escapeHtml(report.opDate)}</div></div><div><div class="label">Tage nach OP</div><div class="value">${escapeHtml(String(report.daysPostOp))}</div></div><div><div class="label">Wundfotos</div><div class="value">${escapeHtml(String(report.woundPhotos))} ${t('photosDocumented')}</div></div></div></div>${report.warnings.length?`<div class="warning"><strong>⚠️ Hinweise:</strong><ul>${report.warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join('')}</ul></div>`:''}<div class="section"><h2>📊 Schmerzverlauf</h2><div class="grid"><div><div class="label">Durchschnitt (letzte 7 Tage)</div><div class="value">${escapeHtml(String(report.avgPain))}/10</div></div><div><div class="label">Tendenz</div><div class="value">${escapeHtml(report.painTrend)}</div></div></div>${painData.length?`<table><tr><th>Datum</th><th>Schmerzwert</th></tr>${painData.slice(-10).map(p=>`<tr><td>${escapeHtml(formatDT(p.date))}</td><td>${escapeHtml(String(p.value))}/10</td></tr>`).join('')}</table>`:''}</div><div class="section"><h2>❤️ Vitalwerte</h2>${report.lastVitals?`<div class="grid"><div><div class="label">Letzter Blutdruck</div><div class="value">${escapeHtml(String(report.lastVitals.systolic))}/${escapeHtml(String(report.lastVitals.diastolic))} mmHg</div></div><div><div class="label">Letzter Puls</div><div class="value">${escapeHtml(String(report.lastVitals.pulse))} bpm</div></div></div>`:'<p>Keine Messungen vorhanden</p>'}${vitalsData.length>1?`<table><tr><th>Datum</th><th>Sys/Dia</th><th>Puls</th></tr>${vitalsData.slice(-10).map(v=>`<tr><td>${escapeHtml(formatDT(v.date))}</td><td>${escapeHtml(String(v.systolic))}/${escapeHtml(String(v.diastolic))}</td><td>${escapeHtml(String(v.pulse))}</td></tr>`).join('')}</table>`:''}</div><div class="section"><h2>💊 Medikation</h2>${medications.length?`<table><tr><th>Medikament</th><th>Dosierung</th><th>Einnahmezeiten</th></tr>${medications.map(m=>`<tr><td>${escapeHtml(m.name)}</td><td>${escapeHtml(m.dose)}</td><td>${escapeHtml(m.alarms.map(a=>a.time).join(', '))}</td></tr>`).join('')}</table>`:'<p>Keine Medikamente eingetragen</p>'}</div><div class="section"><h2>📅 Termine</h2>${appointments.length?`<table><tr><th>Datum</th><th>Termin</th><th>Ort</th></tr>${appointments.map(a=>`<tr><td>${escapeHtml(formatDT(a.datetime))}</td><td>${escapeHtml(a.title)}</td><td>${escapeHtml(a.location||'-')}</td></tr>`).join('')}</table>`:'<p>Keine Termine eingetragen</p>'}</div><div class="footer"><p>Erstellt mit Operationsbegleiter App</p><p>Diese Übersicht ersetzt keine ärztliche Dokumentation.</p></div></body></html>`;}
function savePain(v){setState({painRecords:[...state.painRecords,{id:id(),date:new Date().toISOString(),value:parseInt(v)}]});showToast('Gespeichert ✓');}
function saveVitals(){const sys=parseInt(document.getElementById('sysIn')?.value),dia=parseInt(document.getElementById('diaIn')?.value),pul=parseInt(document.getElementById('pulIn')?.value);if(!sys||!dia||!pul)return showToast('Alle Werte eingeben');setState({vitalsRecords:[...state.vitalsRecords,{id:id(),date:new Date().toISOString(),systolic:sys,diastolic:dia,pulse:pul}]});showToast('Gespeichert ✓');document.getElementById('sysIn').value='';document.getElementById('diaIn').value='';document.getElementById('pulIn').value='';}
function saveMedRec(){const name=document.getElementById('medRecName')?.value,dose=document.getElementById('medRecDose')?.value;if(!name)return showToast('Medikament eingeben');setState({medicationRecords:[...state.medicationRecords,{id:id(),date:new Date().toISOString(),name,dose:dose||''}]});showToast('Dokumentiert ✓');document.getElementById('medRecName').value='';document.getElementById('medRecDose').value='';}
function addQuestion(type,text){if(!text.trim())return;const questions={...state.questions};questions[type]=[...questions[type],{id:id(),text:text.trim(),date:new Date().toISOString()}];setState({questions});showToast('Frage gespeichert ✓');}
function delQuestion(type,qid){const questions={...state.questions};questions[type]=questions[type].filter(q=>q.id!==qid);setState({questions});}
function sendChatMessage(){const input=document.getElementById('chatInput');const msg=input?.value.trim();if(!msg)return;const newMsgs=[...state.chatMessages,{role:'user',content:msg,date:new Date().toISOString()}];setState({chatMessages:newMsgs});input.value='';setTimeout(()=>{const response=getAIResponse(msg);setState({chatMessages:[...state.chatMessages,{role:'assistant',content:response,date:new Date().toISOString()}]});},800);}
function getAIResponse(msg){const lower=msg.toLowerCase();if(lower.includes('narkose')||lower.includes('betäubung'))return AI_RESPONSES.narkose;if(lower.includes('schmerz'))return AI_RESPONSES.schmerzen;if(lower.includes('wunde')||lower.includes('verband'))return AI_RESPONSES.wunde;if(lower.includes('essen')||lower.includes('trinken')||lower.includes('nüchtern'))return AI_RESPONSES.essen;if(lower.includes('medikament')||lower.includes('tablette'))return AI_RESPONSES.medikamente;if(lower.includes('angst')||lower.includes('sorge')||lower.includes('nervös'))return AI_RESPONSES.angst;if(lower.includes('hallo')||lower.includes('hi')||lower.includes('guten'))return AI_RESPONSES.greeting;return AI_RESPONSES.default;}
function painChart(){const r=state.painRecords.slice(-14);if(r.length<2)return`<div class="chart-no-data"><div class="chart-no-data-icon">📊</div><p>Mind. 2 Einträge</p></div>`;const w=280,h=140,p=30,cw=w-p*2,ch=h-p*2;const pts=r.map((x,i)=>({x:p+(i/(r.length-1))*cw,y:p+ch-(x.value/10)*ch}));const path=pts.map((pt,i)=>`${i===0?'M':'L'} ${pt.x} ${pt.y}`).join(' ');return`<svg class="chart-svg" viewBox="0 0 ${w} ${h}">${[0,5,10].map(v=>`<line x1="${p}" y1="${p+ch-(v/10)*ch}" x2="${w-p}" y2="${p+ch-(v/10)*ch}" stroke="var(--border)" stroke-dasharray="3"/><text x="${p-4}" y="${p+ch-(v/10)*ch+3}" fill="var(--muted)" font-size="9" text-anchor="end">${v}</text>`).join('')}<defs><linearGradient id="pg" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="var(--success)"/><stop offset="50%" stop-color="var(--warning)"/><stop offset="100%" stop-color="var(--danger)"/></linearGradient></defs><path d="${path}" fill="none" stroke="url(#pg)" stroke-width="2.5" stroke-linecap="round"/>${pts.map((pt,i)=>{const v=r[i].value,c=v<=3?'var(--success)':v<=6?'var(--warning)':'var(--danger)';return`<circle cx="${pt.x}" cy="${pt.y}" r="4" fill="${c}" stroke="white" stroke-width="1.5"/>`;}).join('')}</svg>`;}
function vitalsChart(){const r=state.vitalsRecords.slice(-10);if(r.length<2)return`<div class="chart-no-data"><div class="chart-no-data-icon">📊</div><p>Mind. 2 Einträge</p></div>`;const w=280,h=140,p=30,cw=w-p*2,ch=h-p*2,minV=50,maxV=180,range=maxV-minV;const mkPts=k=>r.map((x,i)=>({x:p+(i/(r.length-1))*cw,y:p+ch-((x[k]-minV)/range)*ch}));const sP=mkPts('systolic'),dP=mkPts('diastolic'),pP=mkPts('pulse');const mkPath=pts=>pts.map((pt,i)=>`${i===0?'M':'L'} ${pt.x} ${pt.y}`).join(' ');return`<svg class="chart-svg" viewBox="0 0 ${w} ${h}">${[60,100,140,180].map(v=>`<line x1="${p}" y1="${p+ch-((v-minV)/range)*ch}" x2="${w-p}" y2="${p+ch-((v-minV)/range)*ch}" stroke="var(--border)" stroke-dasharray="3"/>`).join('')}<path d="${mkPath(sP)}" fill="none" stroke="var(--danger)" stroke-width="2"/><path d="${mkPath(dP)}" fill="none" stroke="var(--primary)" stroke-width="2"/><path d="${mkPath(pP)}" fill="none" stroke="var(--success)" stroke-width="2"/>${sP.map(pt=>`<circle cx="${pt.x}" cy="${pt.y}" r="3" fill="var(--danger)"/>`).join('')}${dP.map(pt=>`<circle cx="${pt.x}" cy="${pt.y}" r="3" fill="var(--primary)"/>`).join('')}${pP.map(pt=>`<circle cx="${pt.x}" cy="${pt.y}" r="3" fill="var(--success)"/>`).join('')}</svg><div style="display:flex;justify-content:center;gap:10px;font-size:.7rem;margin-top:6px;"><span style="color:var(--danger)">● Sys</span><span style="color:var(--primary)">● Dia</span><span style="color:var(--success)">● Puls</span></div>`;}
function medChart(){const r=state.medicationRecords.slice(-20);if(!r.length)return`<div class="chart-no-data"><div class="chart-no-data-icon">💊</div><p>Noch keine Einträge</p></div>`;const byDay={};r.forEach(x=>{const d=new Date(x.date).toLocaleDateString('de-DE');byDay[d]=(byDay[d]||0)+1;});const days=Object.keys(byDay).slice(-7);const maxC=Math.max(...days.map(d=>byDay[d]),3);const w=280,h=120,p=25,barW=(w-p*2)/days.length-6;return`<svg class="chart-svg" viewBox="0 0 ${w} ${h}">${days.map((day,i)=>{const x=p+i*((w-p*2)/days.length)+3,ht=(byDay[day]/maxC)*(h-p*2),y=h-p-ht;return`<rect x="${x}" y="${y}" width="${barW}" height="${ht}" fill="var(--primary)" rx="3"/><text x="${x+barW/2}" y="${h-6}" fill="var(--muted)" font-size="7" text-anchor="middle">${day.split('.').slice(0,2).join('.')}</text><text x="${x+barW/2}" y="${y-3}" fill="var(--text)" font-size="9" text-anchor="middle" font-weight="bold">${byDay[day]}</text>`;}).join('')}</svg>`;}
function showModal(title,content){const m=document.createElement('div');m.className='modal-overlay';m.id='modal';m.innerHTML=`<div class="modal"><div class="modal-header"><span class="modal-title">${title}</span><button class="modal-close" onclick="closeModal()">✕</button></div>${content}</div>`;document.body.appendChild(m);}
function showSutureGuide(){const content=`<div style="max-height:70vh;overflow-y:auto;padding:0 4px;"><p style="margin-bottom:16px;color:var(--muted);">${t('sutureGuideIntro')}</p><div class="suture-section" style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:4px solid var(--primary);"><h4 style="color:var(--text);margin-bottom:8px;">🔵 ${t('sutureEinzelknopf')}</h4><p style="font-size:.9rem;color:var(--text);line-height:1.5;">${t('sutureEinzelknopfDesc')}</p></div><div class="suture-section" style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:4px solid var(--secondary);"><h4 style="color:var(--text);margin-bottom:8px;">🟣 ${t('sutureDonati')}</h4><p style="font-size:.9rem;color:var(--text);line-height:1.5;">${t('sutureDonatiDesc')}</p></div><div class="suture-section" style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:4px solid var(--success);"><h4 style="color:var(--text);margin-bottom:8px;">🟢 ${t('sutureIntrakutan')}</h4><p style="font-size:.9rem;color:var(--text);line-height:1.5;">${t('sutureIntrakutanDesc')}</p></div><div class="suture-section" style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:4px solid var(--warning);"><h4 style="color:var(--text);margin-bottom:8px;">🟡 ${t('sutureKlammer')}</h4><p style="font-size:.9rem;color:var(--text);line-height:1.5;">${t('sutureKlammerDesc')}</p></div><div class="suture-section" style="background:rgba(59,130,246,0.1);border-radius:12px;padding:14px;margin-bottom:12px;border:1px dashed var(--primary);"><h4 style="color:var(--text);margin-bottom:8px;">💡 ${t('sutureResorbierbar')}</h4><div style="font-size:.9rem;color:var(--text);line-height:1.5;">${t('sutureResorbierbDesc')}</div></div></div>`;showModal(`✂️ ${t('sutureGuideTitle')}`,content);}
function closeModal(){document.getElementById('modal')?.remove();}
function noteModal(tid){const t=state.tasks.find(x=>x.id===tid);showModal('📝 Notiz',`<textarea class="form-textarea" id="noteIn" rows="3" placeholder="Ihre Notiz...">${t?.note||''}</textarea><button class="btn btn-primary btn-block" style="margin-top:14px" onclick="saveNote('${tid}')">Speichern</button>`);setTimeout(()=>document.getElementById('noteIn')?.focus(),100);}
function saveNote(tid){updateNote(tid,document.getElementById('noteIn')?.value||'');closeModal();showToast('Gespeichert ✓');}
function addDocModal(){showModal('📦 Hinzufügen',`<div class="form-group"><label class="form-label">Bezeichnung</label><input type="text" class="form-input" id="newDocIn" placeholder="z.B. Kompressionsstrümpfe"></div><button class="btn btn-primary btn-block" onclick="submitDoc()">Hinzufügen</button>`);}
function submitDoc(){addCustomDoc(document.getElementById('newDocIn')?.value);closeModal();}
function apptModal(){showModal('📅 Neuer Termin',`<div class="form-group"><label class="form-label">Titel</label><input type="text" class="form-input" id="apptTitle" placeholder="z.B. Nachkontrolle"></div><div class="form-group"><label class="form-label">Datum & Uhrzeit</label><input type="datetime-local" class="form-input" id="apptDT"></div><div class="form-group"><label class="form-label">Ort (optional)</label><input type="text" class="form-input" id="apptLoc" placeholder="Klinik, Raum..."></div><div class="form-group"><label class="form-label">Notizen (optional)</label><textarea class="form-textarea" id="apptNotes" rows="2"></textarea></div><div class="checkbox-group" onclick="this.querySelector('input').click()"><input type="checkbox" id="apptReminder" checked><div class="custom-checkbox"></div><div class="checkbox-label"><div class="checkbox-title">🔔 Erinnerung</div><div class="checkbox-desc">Push-Benachrichtigung</div></div></div><button class="btn btn-primary btn-block" style="margin-top:14px" onclick="submitAppt()">Speichern</button>`);}
function submitAppt(){const title=document.getElementById('apptTitle')?.value,dt=document.getElementById('apptDT')?.value;if(!title||!dt)return showToast('Titel und Datum eingeben');addAppt({title,datetime:dt,location:document.getElementById('apptLoc')?.value||'',notes:document.getElementById('apptNotes')?.value||'',reminder:document.getElementById('apptReminder')?.checked});closeModal();}
function medModal(){showModal('💊 Medikament',`<div class="form-group"><label class="form-label">${t('medicationLabel')}</label><input type="text" class="form-input" id="medName" placeholder="z.B. Ibuprofen"></div><div class="form-group"><label class="form-label">Dosierung</label><input type="text" class="form-input" id="medDose" placeholder="z.B. 400mg"></div><div class="form-group"><label class="form-label">Einnahmezeiten (Komma getrennt)</label><input type="text" class="form-input" id="medTimes" placeholder="08:00, 14:00, 20:00"></div><div class="form-group"><label class="form-label">Hinweise (optional)</label><textarea class="form-textarea" id="medNotes" rows="2" placeholder="z.B. Nach dem Essen"></textarea></div><button class="btn btn-primary btn-block" style="margin-top:14px" onclick="submitMed()">Speichern</button>`);}
function submitMed(){const name=document.getElementById('medName')?.value,dose=document.getElementById('medDose')?.value,times=document.getElementById('medTimes')?.value;if(!name||!times)return showToast('Name und Zeiten eingeben');addMed({name,dose:dose||'',times:times.split(',').map(t=>t.trim()).filter(t=>t),notes:document.getElementById('medNotes')?.value||''});closeModal();}
function questionModal(type){const titles={anaesthesist:'Frage an Anästhesist',operateur:'Frage an Operateur'};showModal(`❓ ${titles[type]}`,`<div class="form-group"><label class="form-label">Ihre Frage</label><textarea class="form-textarea" id="questionIn" rows="3" placeholder="Was möchten Sie wissen?"></textarea></div><button class="btn btn-primary btn-block" onclick="submitQuestion('${type}')">Speichern</button>`);}
function submitQuestion(type){addQuestion(type,document.getElementById('questionIn')?.value);closeModal();}
function dateModal(){showModal('📅 OP-Datum',`<div class="form-group"><label class="form-label">Neues Datum</label><input type="date" class="form-input" id="newDate" value="${state.profile.opDate}" min="${new Date().toISOString().split('T')[0]}"></div><p style="color:var(--muted);font-size:.85rem;margin-bottom:14px;">Timeline wird neu berechnet.</p><button class="btn btn-primary btn-block" onclick="changeDate()">Aktualisieren</button>`);}
function changeDate(){const d=document.getElementById('newDate')?.value;if(!d)return showToast('Datum wählen');setState({profile:{...state.profile,opDate:d}});closeModal();showToast('Aktualisiert ✓');}
function typeModal(){showModal('🏥 OP-Art',`<div class="form-group"><label class="form-label">Neue OP-Art</label><input type="text" class="form-input" id="newType" value="${state.profile.opType}" placeholder="z.B. Kniearthroskopie"></div><button class="btn btn-primary btn-block" style="margin-top:14px" onclick="changeType()">Aktualisieren</button>`);}
function changeType(){setState({profile:{...state.profile,opType:document.getElementById('newType')?.value||''}});closeModal();showToast('Aktualisiert ✓');}
function showStorageFullModal(){showModal('💾 Speicher voll',`<div style="text-align:center;"><div style="font-size:3rem;margin-bottom:16px;">⚠️</div><p style="color:var(--muted);margin-bottom:16px;line-height:1.5;">Der Speicher ist voll. Bitte löschen Sie einige Medien, um Platz zu schaffen.</p><div style="display:flex;flex-direction:column;gap:10px;"><button class="btn btn-secondary btn-block" onclick="closeModal();nav('photos');">📷 Fotos verwalten</button><button class="btn btn-secondary btn-block" onclick="closeModal();deleteMediaOnly();">🗑️ Alle Medien löschen</button><button class="btn btn-secondary btn-block" onclick="closeModal();exportFullBackup();">📤 Backup erstellen</button><button class="btn btn-secondary btn-block" onclick="closeModal()">Schließen</button></div></div>`);}
function resetModal(){showModal('🗑️ Daten löschen',`<div style="display:flex;flex-direction:column;gap:12px;"><p style="color:var(--muted);line-height:1.5;">Wählen Sie, was gelöscht werden soll:</p><button class="btn btn-danger btn-block" onclick="resetApp()">🗑️ Alles löschen</button><button class="btn btn-secondary btn-block" onclick="deleteMediaOnly()">🖼️ Nur Medien löschen<br><small style="font-weight:normal;opacity:.7;">Fotos, Memos, Dokumente</small></button><button class="btn btn-secondary btn-block" onclick="deleteHistoryOnly()">📊 Nur Verlauf löschen<br><small style="font-weight:normal;opacity:.7;">Schmerz, Vitalwerte, Medikamenten-Einnahmen</small></button><button class="btn btn-secondary btn-block" onclick="closeModal()">Abbrechen</button></div>`);}
async function resetApp(){await clearAllMedia();localStorage.removeItem(APP_KEY);state={...DEFAULT_STATE};closeModal();showToast('Alle Daten gelöscht');render();}
async function deleteMediaOnly(){await clearAllMedia();setState({photos:[],voiceMemos:[],uploadedDocs:[],transcripts:[]});closeModal();showToast('Medien gelöscht');}
function deleteHistoryOnly(){setState({painRecords:[],vitalsRecords:[],medicationRecords:[]});closeModal();showToast('Verlauf gelöscht');}
function nextStep(){const s=state.onboardingStep;if(s===0&&(!state.profile.disclaimerAccepted||!state.profile.privacyAccepted))return showToast(t('acceptBothNotices'));if(s===1){const d=document.getElementById('opDate')?.value,opT=document.getElementById('opType')?.value;if(!d)return showToast(t('selectOpDate'));setState({profile:{...state.profile,opDate:d,opType:opT||t('defaultOpType')}});}if(s===2)setState({profile:{...state.profile,hospitalName:document.getElementById('hospitalName')?.value||'',hospitalPhone:document.getElementById('hospitalPhone')?.value||'',emergencyContact:document.getElementById('emergencyContact')?.value||''}});if(s===3)setState({profile:{...state.profile,departureTime:document.getElementById('departureTime')?.value||'',travelDuration:document.getElementById('travelDuration')?.value||'',transportAlt:document.getElementById('transportAlt')?.value||''}});if(s===4){setState({setupComplete:true,currentScreen:'dashboard',tasks:genTasks(),onboardingStep:0,chatMessages:[{role:'assistant',content:AI_RESPONSES.greeting,date:new Date().toISOString()}]});if('Notification' in window)Notification.requestPermission();return showToast(t('welcome')+' 🎉');}setState({onboardingStep:s+1});}
function prevStep(){if(state.onboardingStep>0)setState({onboardingStep:state.onboardingStep-1});}
function render(){
    applyTheme(state.theme);
    const app=document.getElementById('app');
    if(!state.setupComplete){app.innerHTML=renderOnboarding();}
    else{app.innerHTML=renderHeader()+renderScreen()+(state.menuOpen?renderMenu():'')+'<button class="ai-fab" onclick="nav(\'assistant\')" title="KI-Assistent">🤖</button><button class="menu-fab" onclick="toggleMenu()">☰ '+t('menu')+'</button>';}
    attachListeners();
    if(state.currentScreen==='wounddiary')setTimeout(loadWoundDiaryThumbnails,50);
}
function renderHeader(){const back=state.currentScreen!=='dashboard';return`<header class="header">${back?'<button class="back-btn" onclick="goBack()">←</button><button class="icon-btn" onclick="nav(\'dashboard\')" style="margin-right:auto;">🏠</button>':'<div style="margin-right:auto;"></div>'}<img src="${LOGO_BASE64}" class="logo-img" alt="Logo"><div class="logo">Operationsbegleiter</div><button class="icon-btn" onclick="toggleTheme()">${state.theme==='light'?'🌙':'☀️'}</button></header>`;}
function renderMenu(){return`<div class="menu-overlay" onclick="toggleMenu()"></div><div class="menu-drawer"><div class="menu-header"><span class="menu-title">📋 Funktionen</span><button class="menu-close" onclick="toggleMenu()">✕</button></div><div class="menu-section"><div class="menu-section-title">Hauptfunktionen</div><div class="menu-item" onclick="nav('dashboard')"><div class="menu-item-icon">🏠</div><div><h4>Startseite</h4><p>Übersicht & Countdown</p></div></div><div class="menu-item" onclick="nav('timeline')"><div class="menu-item-icon">📋</div><div><h4>Timeline</h4><p>Aufgaben vor & nach OP</p></div></div><div class="menu-item" onclick="nav('info')"><div class="menu-item-icon">ℹ️</div><div><h4>OP-Infos</h4><p>Ablauf, Vorbereitung, FAQ</p></div></div><div class="menu-item" onclick="nav('warning')"><div class="menu-item-icon">⚠️</div><div><h4>Warnzeichen</h4><p>Notfall & Symptome</p></div></div></div><div class="menu-section"><div class="menu-section-title">Für Arzt & Physio</div><div class="menu-item" onclick="nav('doctormode')"><div class="menu-item-icon">👨‍⚕️</div><div><h4>Arztmodus</h4><p>Kompakte Übersicht</p></div></div><div class="menu-item" onclick="nav('export')"><div class="menu-item-icon">📤</div><div><h4>Export</h4><p>PDF/Bericht erstellen</p></div></div></div><div class="menu-section"><div class="menu-section-title">Planung</div><div class="menu-item" onclick="nav('appointments')"><div class="menu-item-icon">📅</div><div><h4>Termine</h4><p>Nachkontrollen planen</p></div></div><div class="menu-item" onclick="nav('medications')"><div class="menu-item-icon">⏰</div><div><h4>Medikamentenplan</h4><p>Dosierung & Erinnerungen</p></div></div><div class="menu-item" onclick="nav('questions')"><div class="menu-item-icon">❓</div><div><h4>Fragen</h4><p>An Anästhesist & Operateur</p></div></div><div class="menu-item" onclick="nav('packlist')"><div class="menu-item-icon">📦</div><div><h4>Packliste</h4><p>Was Sie mitnehmen sollten</p></div></div></div><div class="menu-section"><div class="menu-section-title">Dokumentation</div><div class="menu-item" onclick="nav('photos')"><div class="menu-item-icon">📷</div><div><h4>Fotos</h4><p>Wundheilung, Aufklärungen</p></div></div><div class="menu-item" onclick="nav('wounddiary')"><div class="menu-item-icon">📔</div><div><h4>Wundtagebuch</h4><p>Chronologische Übersicht</p></div></div><div class="menu-item" onclick="nav('documents')"><div class="menu-item-icon">📁</div><div><h4>Dokumente</h4><p>PDFs und Dateien hochladen</p></div></div><div class="menu-item" onclick="nav('voice')"><div class="menu-item-icon">🎤</div><div><h4>Sprache</h4><p>Memos & Transkription</p></div></div><div class="menu-item" onclick="nav('pain')"><div class="menu-item-icon">📊</div><div><h4>Schmerz-Tracking</h4><p>VAS-Skala & Verlauf</p></div></div><div class="menu-item" onclick="nav('vitals')"><div class="menu-item-icon">❤️</div><div><h4>Vitalwerte</h4><p>Blutdruck & Puls</p></div></div><div class="menu-item" onclick="nav('medrecords')"><div class="menu-item-icon">💊</div><div><h4>Medikamenten-Doku</h4><p>Einnahmen protokollieren</p></div></div></div><div class="menu-section"><div class="menu-item" onclick="nav('assistant')"><div class="menu-item-icon">🤖</div><div><h4>KI-Assistent</h4><p>Medizinische Fragen</p></div></div><div class="menu-item" onclick="nav('settings')"><div class="menu-item-icon">⚙️</div><div><h4>Einstellungen</h4><p>OP-Daten, Design, Daten</p></div></div></div></div>`;}
function renderScreen(){switch(state.currentScreen){case'dashboard':return renderDashboard();case'timeline':return renderTimeline();case'info':return renderInfo();case'warning':return renderWarning();case'photos':return renderPhotos();case'documents':return renderDocuments();case'voice':return renderVoice();case'pain':return renderPain();case'vitals':return renderVitals();case'medrecords':return renderMedRecords();case'appointments':return renderAppts();case'medications':return renderMeds();case'questions':return renderQuestions();case'packlist':return renderPacklist();case'assistant':return renderAssistant();case'settings':return renderSettings();case'wounddiary':return renderWoundDiary();case'doctormode':return renderDoctorMode();case'export':return renderExport();case'impressum':return renderImpressum();default:return renderDashboard();}}
function renderOnboarding(){const steps=[{title:t('welcome'),subtitle:t('subtitle'),content:`<p style="font-size:.8rem;color:var(--muted);margin-bottom:12px;text-align:center;">${t('acceptTerms')}</p><div class="checkbox-group" onclick="this.querySelector('input').click()"><input type="checkbox" id="disclaimer" ${state.profile.disclaimerAccepted?'checked':''}><div class="custom-checkbox"></div><div class="checkbox-label"><div class="checkbox-title">⚕️ ${t('medicalNote')}</div><div class="checkbox-desc">${t('medicalNoteDesc')}</div></div></div><div class="checkbox-group" onclick="this.querySelector('input').click()"><input type="checkbox" id="privacy" ${state.profile.privacyAccepted?'checked':''}><div class="custom-checkbox"></div><div class="checkbox-label"><div class="checkbox-title">🔒 ${t('privacy')}</div><div class="checkbox-desc">${t('privacyDesc')}</div></div></div>`},{title:t('yourOp'),subtitle:t('whenWhat'),content:`<div class="form-group"><label class="form-label">📅 ${t('opDate')}</label><input type="date" class="form-input date-input" id="opDate" value="${state.profile.opDate}" min="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label class="form-label">🏥 ${t('opType')}</label><input type="text" class="form-input" id="opType" value="${state.profile.opType}" placeholder="${t('opTypePlaceholder')}"></div><div class="form-group"><label class="form-label">${t('opMode')}</label><p style="font-size:.8rem;color:var(--muted);margin-bottom:12px;line-height:1.4;"><strong>${t('ambulant')}:</strong> ${t('ambulantExplain')}<br><strong>${t('stationary')}:</strong> ${t('stationaryExplain')}</p><div class="op-mode-toggle" style="flex-direction:column;gap:8px;"><button class="op-mode-btn ${state.profile.opMode==='ambulant'?'active':''}" onclick="setOpMode('ambulant')">${t('ambulant')}</button><button class="op-mode-btn ${state.profile.opMode==='stationary'?'active':''}" onclick="setOpMode('stationary')">${t('stationary')}</button><button class="op-mode-btn ${state.profile.opMode==='unknown'?'active':''}" onclick="setOpMode('unknown')">${t('iDontKnow')}</button></div></div>`},{title:t('contacts'),subtitle:t('contactsSubtitle'),content:`<div class="form-group"><label class="form-label">🏥 ${t('clinic')}</label><input type="text" class="form-input" id="hospitalName" value="${state.profile.hospitalName}" placeholder="${t('clinicPlaceholder')}"></div><div class="form-group"><label class="form-label">📞 ${t('phone')}</label><input type="tel" class="form-input" id="hospitalPhone" value="${state.profile.hospitalPhone}" placeholder="030 12345678"></div><div class="form-group"><label class="form-label">👤 ${t('emergencyContact')}</label><input type="text" class="form-input" id="emergencyContact" value="${state.profile.emergencyContact}" placeholder="${t('nameAndPhone')}"></div>`},{title:'🚗 '+t('transport'),subtitle:t('transportSubtitle'),content:`<div class="form-group"><label class="form-label">⏰ ${t('departureTime')}</label><input type="time" class="form-input" id="departureTime" value="${state.profile.departureTime||''}"></div><div class="form-group"><label class="form-label">⏱️ ${t('travelDuration')}</label><input type="number" class="form-input" id="travelDuration" value="${state.profile.travelDuration||''}" placeholder="45" min="1" max="300"></div><div class="form-group"><label class="form-label">🚕 ${t('transportAlt')}</label><input type="text" class="form-input" id="transportAlt" value="${state.profile.transportAlt||''}" placeholder="${t('transportAltPlaceholder')}"></div>`},{title:t('allReady'),subtitle:t('letsGoSubtitle'),content:`<div style="text-align:center;padding:16px;"><div style="font-size:3.5rem;margin-bottom:14px;">🚀</div><p style="color:var(--muted);">${t('timelineCreated')}</p></div>`}];const s=steps[state.onboardingStep];return`<div class="onboarding"><header class="header"><img src="${LOGO_BASE64}" class="logo-img" alt="Logo"><div class="logo">Operationsbegleiter</div><button class="icon-btn" onclick="toggleTheme()">${state.theme==='light'?'🌙':'☀️'}</button></header><div class="onboarding-progress">${steps.map((_,i)=>`<div class="progress-dot ${i<state.onboardingStep?'completed':''} ${i===state.onboardingStep?'active':''}"></div>`).join('')}</div><div class="onboarding-content"><div class="onboarding-hero"><img src="${LOGO_BASE64}" class="onboarding-logo" alt="Logo"><h1 class="onboarding-title">${s.title}</h1><p class="onboarding-subtitle">${s.subtitle}</p></div>${s.content}</div><div class="onboarding-nav">${state.onboardingStep>0?`<button class="btn btn-secondary" onclick="prevStep()">${t('back')}</button>`:''}<button class="btn btn-primary btn-block" onclick="nextStep()">${state.onboardingStep===steps.length-1?t('letsGo'):t('next')}</button></div></div>`;}
function setLanguage(lang){}
function setOpMode(mode){state.profile.opMode=mode;saveState();render();showToast('Gespeichert ✓');}
function renderDashboard(){const d=getDaysUntil();const next=state.tasks.filter(tk=>!tk.completed).sort((a,b)=>a.day-b.day).slice(0,3);const appts=state.appointments.filter(a=>new Date(a.datetime)>new Date()).slice(0,2);let cv='?',cu=t('noDate');if(d!==null){if(d<0){cv=Math.abs(d);cu=t('daysToOp').replace('bis','seit');}else if(d===0){cv='🎯';cu=t('todayOpDay');}else{cv=d;cu=d===1?'Tag bis OP':t('daysToOp');}}const opModeText=state.profile.opMode==='ambulant'?'('+t('ambulant')+')':state.profile.opMode==='stationary'?'('+t('stationary')+')':'';return`<div class="screen"><div class="hero"><div class="hero-label">🏥 ${state.profile.opType||'Ihre OP'} ${opModeText}</div><div class="hero-value">${cv}</div><div class="hero-unit">${cu}</div><div class="hero-date">📅 ${formatDate(state.profile.opDate)}${state.profile.departureTime?' • 🚗 '+state.profile.departureTime+' Uhr':''}</div></div><div class="section-header"><h2 class="section-title">⚡ ${t('quickAccess')}</h2></div><div class="grid"><div class="grid-card" onclick="nav('timeline')"><div class="grid-icon">📋</div><div class="grid-label">${t('timeline')}</div></div><div class="grid-card" onclick="nav('questions')"><div class="grid-icon">❓</div><div class="grid-label">${t('questions')}</div></div><div class="grid-card" onclick="nav('photos')"><div class="grid-icon">📷</div><div class="grid-label">${t('photos')}</div></div><div class="grid-card" onclick="nav('wounddiary')"><div class="grid-icon">📔</div><div class="grid-label">${t('woundDiary')}</div></div><div class="grid-card" onclick="nav('doctormode')"><div class="grid-icon">👨‍⚕️</div><div class="grid-label">${t('doctorMode')}</div></div><div class="grid-card" onclick="nav('voice')"><div class="grid-icon">🎤</div><div class="grid-label">${t('voice')}</div></div></div><div class="section-header"><h2 class="section-title">📌 ${t('nextTasks')}</h2><span class="section-link" onclick="nav('timeline')">${t('all')}</span></div><div class="card">${next.length?next.map(tk=>{const today=tk.day===-d;return`<div class="card-item" onclick="nav('timeline')"><div class="badge ${today?'today':''}">` +`${tk.day===0?'OP':(tk.day>0?'D+'+tk.day:'D'+tk.day)}</div><div class="card-content"><div class="card-title">${tk.title}</div><div class="card-desc">${tk.desc}</div></div></div>`;}).join(''):'<div class="card-item"><div class="card-content" style="text-align:center;padding:16px;"><div style="font-size:1.8rem;margin-bottom:8px;">🎉</div><div class="card-title">Alle erledigt!</div></div></div>'}</div>${appts.length?`<div class="section-header" style="margin-top:20px;"><h2 class="section-title">📅 ${t('appointments')}</h2><span class="section-link" onclick="nav('appointments')">${t('all')}</span></div>${appts.map(a=>{const dt=new Date(a.datetime);return`<div class="appt-card"><div class="appt-date"><div class="appt-day">${dt.getDate()}</div><div class="appt-month">${dt.toLocaleDateString(getLocale(),{month:'short'})}</div></div><div class="appt-info"><div class="appt-title">${a.title}</div><div class="appt-details">${dt.toLocaleTimeString(getLocale(),{hour:'2-digit',minute:'2-digit'})} Uhr${a.location?' • '+a.location:''}</div></div></div>`;}).join('')}`:''}</div>`;}
function addCustomTaskModal(){const d=getDaysUntil()||0;showModal('➕ Eigene Aufgabe hinzufügen',`<div class="form-group"><label class="form-label">Titel</label><input type="text" class="form-input" id="customTaskTitle" placeholder="z.B. Physiotherapie-Übungen"></div><div class="form-group"><label class="form-label">Beschreibung</label><input type="text" class="form-input" id="customTaskDesc" placeholder="z.B. 3x täglich für 15 Min."></div><div class="form-group"><label class="form-label">Tag (relativ zum OP-Tag)</label><select class="form-select" id="customTaskDay"><option value="-7">7 Tage vor OP</option><option value="-3">3 Tage vor OP</option><option value="-2">2 Tage vor OP</option><option value="-1">1 Tag vor OP</option><option value="0">OP-Tag</option><option value="1" selected>1 Tag nach OP</option><option value="2">2 Tage nach OP</option><option value="3">3 Tage nach OP</option><option value="5">5 Tage nach OP</option><option value="7">7 Tage nach OP</option><option value="10">10 Tage nach OP</option><option value="14">14 Tage nach OP</option><option value="21">21 Tage nach OP</option><option value="28">28 Tage nach OP</option></select></div><div style="display:flex;gap:10px;margin-top:16px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" style="flex:1;" onclick="saveCustomTask()">Hinzufügen</button></div>`);}
function saveCustomTask(){const title=document.getElementById('customTaskTitle').value.trim();const desc=document.getElementById('customTaskDesc').value.trim();const day=parseInt(document.getElementById('customTaskDay').value);if(!title){showToast('Bitte einen Titel eingeben');return;}const newTask={id:'custom_'+Date.now(),title:title,desc:desc||'Eigene Aufgabe',day:day,completed:false,custom:true};state.tasks.push(newTask);saveState();closeModal();showToast('Aufgabe hinzugefügt');render();}
function deleteCustomTask(tid){
    showModal('Löschen?','<p style="margin-bottom:16px">Aufgabe wirklich löschen?</p><div style="display:flex;gap:12px"><button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Nein</button><button class="btn btn-danger" style="flex:1" onclick="closeModal();execDeleteTask(\''+tid+'\')">Ja</button></div>');
}
function execDeleteTask(tid){state.tasks=state.tasks.filter(function(x){return x.id!==tid});saveState();showToast('Gelöscht');render();}
function renderTimeline(){const d=getDaysUntil();const done=state.tasks.filter(tk=>tk.completed).length,total=state.tasks.length,prog=total>0?Math.round((done/total)*100):0;const grouped={};state.tasks.forEach(tk=>{if(!grouped[tk.day])grouped[tk.day]=[];grouped[tk.day].push(tk);});const days=Object.keys(grouped).map(Number).sort((a,b)=>a-b);const dayLabel=day=>{if(day===0)return t('opDayLabel');if(day>0)return`D+${day} (Nach OP)`;return`D${day} (${Math.abs(day)} Tag${Math.abs(day)>1?'e':''} vorher)`;};const getTaskLink=title=>{const lower=title.toLowerCase();if(lower.includes('medikament'))return'medications';if(lower.includes('kleidung')||lower.includes('pack'))return'packlist';if(lower.includes('transport'))return'settings';if(lower.includes('termin'))return'appointments';if(lower.includes('doku')||lower.includes('foto'))return'photos';if(lower.includes('frage'))return'questions';if(lower.includes('faden')||lower.includes('klammer'))return'sutureGuide';return null;};return`<div class="screen"><div class="section-header"><h1 class="section-title">📋 ${t('timeline')}</h1><button class="btn btn-primary btn-sm" onclick="addCustomTaskModal()">➕ Aufgabe</button></div><div class="card" style="padding:14px;margin-bottom:16px;"><div class="progress-container"><div class="progress-label"><span>Fortschritt</span><span>${done}/${total} (${prog}%)</span></div><div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div></div><div class="filter-tabs"><button class="filter-tab active" data-filter="all">Alle</button><button class="filter-tab" data-filter="open">Offen</button><button class="filter-tab" data-filter="done">Erledigt</button></div></div>${d!==null&&d<=1&&d>=0?`<div class="fasting"><div class="fasting-title">🚫 Nüchternheit!</div><div class="fasting-rule"><div class="fasting-icon">🍽️</div><div class="fasting-text"><strong>8h vor OP</strong><span>${t('noEating')}</span></div></div><div class="fasting-rule"><div class="fasting-icon">💧</div><div class="fasting-text"><strong>2h vor OP</strong><span>${t('clearFluidsOnly')}</span></div></div><button class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="fastingAlarmModal()">⏰ ${t('setAlarm')}</button></div>`:''}<div class="timeline"><div class="timeline-line"></div>${days.map(day=>{const tasks=grouped[day];const date=getDateFor(day);const today=day===-d,op=day===0,allDone=tasks.every(tk=>tk.completed);return`<div class="timeline-phase"><div class="timeline-header"><div class="timeline-dot ${today?'today':''} ${op?'op':''} ${allDone&&!op?'completed':''}"></div><div><div class="phase-label">${dayLabel(day)}${today?' <span style="background:var(--warning);color:#fff;padding:2px 6px;border-radius:8px;font-size:.65rem;margin-left:6px;">HEUTE</span>':''}</div><div class="phase-date">${date?date.toLocaleDateString(getLocale(),{weekday:'short',day:'numeric',month:'short'}):''}</div></div></div>${tasks.map(tk=>{const link=getTaskLink(tk.title);const isSuture=link==='sutureGuide';const isCustom=tk.custom===true;return`<div class="task ${tk.completed?'completed':''}" data-id="${tk.id}"><div class="task-header"><div class="task-check ${tk.completed?'checked':''}" onclick="event.stopPropagation();toggleTask('${tk.id}')">${tk.completed?'✓':''}</div><div class="task-content"><div class="task-title">${tk.title}${isCustom?' <span style="font-size:.65rem;background:var(--secondary);color:#fff;padding:1px 6px;border-radius:6px;">Eigene</span>':''}${link&&!isSuture?`<button class="add-note-btn" style="margin-left:8px;padding:2px 8px;font-size:.75rem;" onclick="event.stopPropagation();nav('${link}')">→ Öffnen</button>`:''}</div><div class="task-desc">${tk.desc}</div>${isSuture?`<button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="event.stopPropagation();showSutureGuide()">📖 Anleitung anzeigen</button>`:''} ${tk.note?`<div class="task-note">📝 ${tk.note}</div>`:''}<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;"><button class="add-note-btn" onclick="event.stopPropagation();noteModal('${tk.id}')">${tk.note?'✏️ Bearbeiten':'➕ Notiz'}</button>${isCustom?`<button class="add-note-btn" style="color:var(--danger);" onclick="event.stopPropagation();deleteCustomTask('${tk.id}')">🗑️ Löschen</button>`:''}</div></div></div></div>`;}).join('')}</div>`;}).join('')}</div></div>`;}
function renderInfo(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('opInfosTitle')}</h1></div><div class="tabs"><button class="tab active" data-tab="ablauf">Ablauf</button><button class="tab" data-tab="vorbereitung">Vorbereitung</button><button class="tab" data-tab="nachsorge">Nach OP</button><button class="tab" data-tab="fragen">Fragen</button></div><div class="info-content" id="infoContent"><div class="info-section" data-content="ablauf"><h3 style="margin-bottom:12px;color:var(--text)">🔄 Ablauf</h3><ul class="info-list">${getOpInfo().ablauf.map(i=>`<li>${i}</li>`).join('')}</ul></div><div class="info-section hidden" data-content="vorbereitung"><h3 style="margin-bottom:12px;color:var(--text)">✅ Vorbereitung</h3><ul class="info-list">${getOpInfo().vorbereitung.map(i=>`<li>${i}</li>`).join('')}</ul></div><div class="info-section hidden" data-content="nachsorge"><h3 style="margin-bottom:12px;color:var(--text)">🏠 Nachsorge</h3><ul class="info-list">${getOpInfo().nachsorge.map(i=>`<li>${i}</li>`).join('')}</ul></div><div class="info-section hidden" data-content="fragen"><h3 style="margin-bottom:12px;color:var(--text)">❓ Häufige Fragen</h3>${getOpInfo().fragen.map(f=>`<div style="margin-bottom:14px;"><strong style="color:var(--text)">${f.q}</strong><p style="color:var(--muted);margin-top:4px;">${f.a}</p></div>`).join('')}</div></div><div class="disclaimer"><span>ℹ️</span><div><strong>Wichtig:</strong> Folgen Sie den Anweisungen Ihres Behandlungsteams.</div></div></div>`;}
function renderWarning(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('warningSignsTitle')}</h1></div><div class="emergency"><div class="emergency-title">${t('emergencyTitle')}</div><p>${t('lifeThreatening')}</p><a href="tel:112" class="emergency-btn">${t('call112')}</a></div><p style="color:var(--muted);margin-bottom:14px;">${t('contactClinicFor')}</p>${getWarnings().map(w=>`<div class="warning-card"><div class="warning-icon">${w.icon}</div><div><h4>${w.title}</h4><p>${w.desc}</p></div></div>`).join('')}${state.profile.hospitalPhone?`<a href="tel:${state.profile.hospitalPhone}" class="clinic-btn">📞 ${state.profile.hospitalName||'Klinik'} anrufen</a>`:'<div class="storage-info" style="margin-top:16px;"><span>💡</span><p>Kliniktelefon in Einstellungen speichern.</p></div>'}</div>`;}
function renderQuestions(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('questionsTitle')}</h1></div><p style="color:var(--muted);margin-bottom:16px;">${t('noteQuestionsText')}</p><div class="question-card"><div class="question-header anaesthesist"><div class="question-icon">😷</div><div class="question-header-info"><h3>${t('anesthesiologist')}</h3><p>${t('anesthesiaQs')}</p></div></div><div class="question-timing op-tag">⏰ Gespräch: Am OP-Tag oder 1 Tag vorher</div><div class="question-body">${state.questions.anaesthesist.length?state.questions.anaesthesist.map(q=>`<div class="question-item"><span class="question-bullet">•</span><span class="question-text">${q.text}</span><button class="question-del" onclick="delQuestion('anaesthesist','${q.id}')">✕</button></div>`).join(''):'<div class="question-empty">'+t('noQuestionsYet')+'</div>'}<button class="btn btn-secondary btn-block btn-sm" onclick="questionModal('anaesthesist')">${t('addQuestionBtn')}</button></div></div><div class="question-card"><div class="question-header operateur"><div class="question-icon">👨‍⚕️</div><div class="question-header-info"><h3>${t('surgeonTitle')}</h3><p>${t('surgeryQs')}</p></div></div><div class="question-timing vor-op">⏰ Aufklärungsgespräch: Tage/Wochen vor OP</div><div class="question-timing nach-op" style="margin-left:8px;">⏰ Nachgespräch: Nach der OP</div><div class="question-body">${state.questions.operateur.length?state.questions.operateur.map(q=>`<div class="question-item"><span class="question-bullet">•</span><span class="question-text">${q.text}</span><button class="question-del" onclick="delQuestion('operateur','${q.id}')">✕</button></div>`).join(''):'<div class="question-empty">'+t('noQuestionsYet')+'</div>'}<button class="btn btn-secondary btn-block btn-sm" onclick="questionModal('operateur')">${t('addQuestionBtn')}</button></div></div><div class="disclaimer"><span>💡</span><div>Tipp: Notieren Sie Ihre Fragen im Voraus, damit Sie im Gespräch nichts vergessen!</div></div></div>`;}
function renderPhotos(){const q=(state.photoSearch||'').toLowerCase();const allPhotos=state.photos.filter(p=>!q||formatShort(p.date).toLowerCase().includes(q)||(p.note||'').toLowerCase().includes(q)||p.category.toLowerCase().includes(q));const wound=allPhotos.filter(p=>p.category==='wound'),consent=allPhotos.filter(p=>p.category==='consent'),other=allPhotos.filter(p=>p.category==='other');const renderPhotoItem=(p)=>`<div class="photo-item" onclick="viewPhoto('${p.id}')" data-media-id="${p.mediaId||''}" data-photo-id="${p.id}"><img src="" data-photo-placeholder="true" style="background:var(--bg);"><div class="photo-date">${formatShort(p.date)}</div><button class="photo-delete" onclick="event.stopPropagation();delPhoto('${p.id}')">✕</button></div>`;setTimeout(()=>loadPhotoThumbnails(),50);return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('photos')}</h1></div><div style="margin-bottom:16px;"><input type="text" class="form-input" placeholder="🔍 Fotos durchsuchen (Datum, Notiz, Kategorie)..." value="${state.photoSearch||''}" oninput="setState({photoSearch:this.value})"></div><div style="margin-bottom:20px;"><h3 style="margin-bottom:10px;color:var(--text)">${t('woundHealingTitle')} (${wound.length})</h3><div style="display:flex;gap:8px;margin-bottom:10px;"><button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('woundCam').click()">📷 Foto aufnehmen</button><button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('woundUp').click()">🖼️ Aus Galerie</button></div><input type="file" id="woundCam" class="file-input" accept="image/*" capture="environment" onchange="handlePhoto(event,'wound')"><input type="file" id="woundUp" class="file-input" accept="image/*" multiple onchange="handlePhoto(event,'wound')">${wound.length?`<div class="photo-grid">${wound.map(renderPhotoItem).join('')}</div>`:''}</div><div style="margin-bottom:20px;"><h3 style="margin-bottom:10px;color:var(--text)">${t('opConsents')} (${consent.length})</h3><div style="display:flex;gap:8px;margin-bottom:10px;"><button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('consentCam').click()">📷 Foto aufnehmen</button><button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('consentUp').click()">🖼️ Aus Galerie</button></div><input type="file" id="consentCam" class="file-input" accept="image/*" capture="environment" onchange="handlePhoto(event,'consent')"><input type="file" id="consentUp" class="file-input" accept="image/*" multiple onchange="handlePhoto(event,'consent')">${consent.length?`<div class="photo-grid">${consent.map(renderPhotoItem).join('')}</div>`:''}</div><div><h3 style="margin-bottom:10px;color:var(--text)">${t('otherPhotos')} (${other.length})</h3><div style="display:flex;gap:8px;margin-bottom:10px;"><button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('otherCam').click()">📷 Foto aufnehmen</button><button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('otherUp').click()">🖼️ Aus Galerie</button></div><input type="file" id="otherCam" class="file-input" accept="image/*" capture="environment" onchange="handlePhoto(event,'other')"><input type="file" id="otherUp" class="file-input" accept="image/*" multiple onchange="handlePhoto(event,'other')">${other.length?`<div class="photo-grid">${other.map(renderPhotoItem).join('')}</div>`:''}</div></div>`;}
async function loadPhotoThumbnails(){const imgs=document.querySelectorAll('img[data-photo-placeholder="true"]');for(const img of imgs){const container=img.closest('.photo-item');if(!container)continue;const mediaId=container.dataset.mediaId;const photoId=container.dataset.photoId;if(mediaId){try{const media=await getMedia(mediaId);if(media){img.src=getCachedUrl(mediaId,media.blob);img.removeAttribute('data-photo-placeholder');}else{img.alt='Nicht verfügbar';img.style.opacity='0.5';}}catch(e){console.error('Thumbnail load error:',e);}}else{const p=state.photos.find(x=>x.id===photoId);if(p&&p.data){img.src=p.data;img.removeAttribute('data-photo-placeholder');}}}}
async function loadWoundDiaryThumbnails(){if(state.currentScreen!=='wounddiary')return;const imgs=document.querySelectorAll('img[data-wound-placeholder="true"]');for(const img of imgs){const mediaId=img.dataset.mediaId;const photoId=img.dataset.photoId;if(mediaId){try{const media=await getMedia(mediaId);if(media){img.src=getCachedUrl(mediaId,media.blob);img.removeAttribute('data-wound-placeholder');}else{img.alt='Nicht verfügbar';img.style.opacity='0.5';img.removeAttribute('data-wound-placeholder');}}catch(e){console.error('Wound thumbnail error:',e);img.alt='Fehler';img.style.opacity='0.5';}}else{const p=state.photos.find(x=>x.id===photoId);if(p&&p.data){img.src=p.data;img.removeAttribute('data-wound-placeholder');}else{img.alt='Nicht verfügbar';img.style.opacity='0.5';}}}}
function renderDocuments(){const q=(state.docSearch||'').toLowerCase();const filteredDocs=state.uploadedDocs.filter(d=>!q||d.name.toLowerCase().includes(q)||formatShort(d.date).toLowerCase().includes(q));return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('documentsTitle')} (${state.uploadedDocs.length})</h1></div><div style="margin-bottom:16px;"><input type="text" class="form-input" placeholder="🔍 Dokumente durchsuchen..." value="${state.docSearch||''}" oninput="setState({docSearch:this.value})"></div><p style="color:var(--muted);margin-bottom:16px;">${t('uploadDocsText')}</p><div class="upload-area" onclick="document.getElementById('docUp').click()"><div class="upload-icon">📄</div><div class="upload-text">${t('uploadDoc')}<br><small>${t('pdfWordImages')}</small></div></div><input type="file" id="docUp" class="file-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple onchange="handleDocUpload(event)">${filteredDocs.length?`<div style="margin-top:16px;">${filteredDocs.map(d=>`<div class="doc-file" onclick="openDocument('${d.id}')" style="cursor:pointer;"><div class="doc-file-icon">${d.type.includes('pdf')?'📕':d.type.includes('word')||d.type.includes('doc')?'📘':'🖼️'}</div><div class="doc-file-info"><div class="doc-file-name">${d.name} <span style="font-size:.7rem;color:var(--primary);">→ Öffnen</span></div><div class="doc-file-meta">${formatFileSize(d.size)} • ${formatShort(d.date)}</div></div><button class="doc-file-del" onclick="event.stopPropagation();delUploadedDoc('${d.id}')">🗑️</button></div>`).join('')}</div>`:(state.uploadedDocs.length?'<p style="color:var(--muted);margin-top:16px;">Keine Treffer für diese Suche</p>':'<div class="storage-info" style="margin-top:16px;"><span>📂</span><p>'+t('noDocsYet')+'</p></div>')}</div>`;}
async function openDocument(did){
    var doc=state.uploadedDocs.find(function(x){return x.id===did});
    if(!doc){showToast('Nicht gefunden');return;}
    var blobData=null;
    if(doc.mediaId){var m=await getMedia(doc.mediaId);if(m)blobData=m.blob;}
    else if(doc.data){blobData=dataURLToBlob(doc.data);}
    if(!blobData){showToast('Keine Daten');return;}
    if(navigator.share){
        try{var f=new File([blobData],doc.name,{type:doc.type});await navigator.share({files:[f]});return;}catch(e){}
    }
    if(doc.type&&doc.type.indexOf('image')===0){
        var u=URL.createObjectURL(blobData);showModal(doc.name,'<img src="'+u+'" style="max-width:100%">');return;
    }
    var url=URL.createObjectURL(blobData);window.open(url);
}
function renderVoice(){const isRec=mediaRecorder&&mediaRecorder.state==='recording',isListen=window.isDictating===true;return`<div class="screen"><div class="section-header"><h1 class="section-title">🎤 Sprache</h1></div><div style="margin-bottom:20px;"><h3 style="margin-bottom:10px;color:var(--text)">🎙️ Sprache zu Text</h3><p style="color:var(--muted);font-size:.85rem;margin-bottom:12px;">Arzt-Gespräche direkt in Text umwandeln.</p><button class="speech-btn ${isListen?'listening':''}" onclick="${isListen?'stopSpeech()':'startSpeech()'}"><span style="font-size:1.5rem;">${isListen?'⏹️':'🎤'}</span>${isListen?'Aufnahme stoppen & speichern':'Aufnahme starten'}</button>${isListen?`<div class="speech-status"><div class="speech-pulse"></div><span style="color:var(--danger);font-weight:600;">Aufnahme aktiv - Sprechen Sie jetzt</span></div><div id="liveText" style="margin-top:14px;padding:16px;background-color:var(--card);border:2px solid var(--primary);border-radius:var(--radius);min-height:100px;color:var(--text);font-size:1rem;line-height:1.6;">🎤 <strong>Aufnahme läuft</strong> - Sprechen Sie jetzt deutlich ins Mikrofon...</div><p style="color:var(--muted);font-size:.8rem;margin-top:10px;text-align:center;">💡 Tipp: Sprechen Sie langsam und deutlich. Tippen Sie auf "Stoppen" um den Text zu speichern.</p>`:''}</div>${state.transcripts.length?`<div style="margin-bottom:20px;"><h4 style="margin:0 0 12px;color:var(--text);display:flex;align-items:center;gap:8px;">📝 Gespeicherte Texte <span style="background:var(--primary);color:#fff;font-size:.7rem;padding:2px 8px;border-radius:10px;">${state.transcripts.length}</span></h4><div class="search-box" style="margin-bottom:12px;"><input type="text" class="form-input" placeholder="🔍 Texte durchsuchen..." value="${state.transcriptSearch||''}" oninput="setState({transcriptSearch:this.value})"></div>${state.transcripts.filter(tr=>!state.transcriptSearch||(tr.name||'').toLowerCase().includes((state.transcriptSearch||'').toLowerCase())||tr.text.toLowerCase().includes((state.transcriptSearch||'').toLowerCase())).slice().reverse().map(t=>`<div class="transcript-item"><div class="transcript-header"><div><div class="transcript-name">${escapeHtml(t.name)||'Transkript'}</div><span class="transcript-date">${formatDT(t.date)}</span></div><div style="display:flex;gap:8px;"><button class="transcript-edit" onclick="editTranscript('${t.id}')" style="min-width:44px;min-height:44px;font-size:1.2rem;">✏️</button><button class="transcript-delete" onclick="delTranscript('${t.id}')" style="min-width:44px;min-height:44px;font-size:1.2rem;">🗑️</button></div></div><div class="transcript-text" style="margin-top:8px;padding:12px;background:var(--bg);border-radius:8px;line-height:1.5;">${escapeHtml(t.text)}</div></div>`).join('')}</div>`:''}<div><h3 style="margin-bottom:10px;color:var(--text)">🎤 Sprachmemos</h3><p style="color:var(--muted);font-size:.85rem;margin-bottom:12px;">Audiomemos aufnehmen und abspielen. Aufnahmen werden lokal gespeichert.</p><div class="recording-controls"><button class="record-btn ${isRec?'recording':''}" onclick="${isRec?'stopRec()':'startRec()'}" style="min-width:80px;min-height:80px;">${isRec?'⏹️':'🎤'}</button><div class="recording-status ${isRec?'active':''}">${isRec?'🔴 Aufnahme läuft...':'Tippen zum Aufnehmen'}</div>${isRec?'<div class="recording-timer" id="recTimer">00:00</div>':''}</div>${state.voiceMemos.length?`<h4 style="margin:16px 0 10px;color:var(--text);">🎧 Gespeicherte Memos</h4>${state.voiceMemos.slice().reverse().map(m=>`<div class="memo-item"><button class="play-btn" onclick="playMemo('${m.id}')" style="min-width:48px;min-height:48px;font-size:1.3rem;">▶️</button><div class="memo-info" onclick="renameMemo('${m.id}')" style="cursor:pointer;flex:1;padding:8px;"><div class="memo-title">${escapeHtml(m.title)} <span style="font-size:.7rem;color:var(--muted);">✏️</span></div><div class="memo-meta">${formatDT(m.date)} • ${formatTime(m.duration)}</div></div><button class="memo-delete" onclick="delMemo('${m.id}')" style="min-width:44px;min-height:44px;font-size:1.2rem;">🗑️</button></div>`).join('')}`:''}</div></div>`;}
function renderPain(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('painTitle')}</h1></div><div class="vas-container"><h3 class="vas-title">${t('currentPain')}</h3><p style="color:var(--muted);font-size:.85rem;margin-bottom:12px;">${t('painScale')}</p><div class="vas-scale"><span class="vas-label">${t('noPain')}</span><input type="range" class="vas-slider" id="painSlider" min="0" max="10" value="0" oninput="document.getElementById('painVal').textContent=this.value"><span class="vas-value" id="painVal">0</span></div><div class="vas-emojis"><span>😊</span><span>😐</span><span>😣</span><span>😖</span><span>😫</span></div><button class="btn btn-primary btn-block" style="margin-top:16px;" onclick="savePain(document.getElementById('painSlider').value)">${t('saveBtn')}</button></div><div class="chart-container"><div class="chart-title">${t('courseTitle')}</div><div class="chart-canvas">${painChart()}</div></div>${state.painRecords.length?`<div style="margin-top:16px;"><h4 style="margin-bottom:10px;color:var(--text)">${t('lastEntries')}</h4>${state.painRecords.slice(-5).reverse().map(r=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span style="color:var(--text)">${formatDT(r.date)}</span><span style="font-weight:700;color:${r.value<=3?'var(--success)':r.value<=6?'var(--warning)':'var(--danger)'};">${r.value}/10</span></div>`).join('')}</div>`:''}</div>`;}
function renderVitals(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('vitalsTitle')}</h1></div><div class="vas-container"><h3 class="vas-title">${t('newMeasurement')}</h3><div class="vitals-row"><div class="vitals-group"><label>${t('systolicLabel')}</label><input type="number" id="sysIn" placeholder="120"></div><div class="vitals-group"><label>${t('diastolicLabel')}</label><input type="number" id="diaIn" placeholder="80"></div></div><div class="vitals-row"><div class="vitals-group"><label>${t('pulseBpmLabel')}</label><input type="number" id="pulIn" placeholder="70"></div></div><button class="btn btn-primary btn-block" style="margin-top:12px;" onclick="saveVitals()">${t('saveBtn')}</button></div><div class="chart-container"><div class="chart-title">${t('courseTitle')}</div><div class="chart-canvas">${vitalsChart()}</div></div>${state.vitalsRecords.length?`<div style="margin-top:16px;"><h4 style="margin-bottom:10px;color:var(--text)">${t('measurementsTitle')}</h4>${state.vitalsRecords.slice(-5).reverse().map(r=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:.85rem;color:var(--muted);">${formatDT(r.date)}</span><div style="display:flex;gap:12px;"><span style="color:var(--danger);font-weight:600;">${r.systolic}/${r.diastolic}</span><span style="color:var(--success);font-weight:600;">❤️ ${r.pulse}</span></div></div>`).join('')}</div>`:''}</div>`;}
function renderMedRecords(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('medRecordsTitle')}</h1></div><div class="vas-container"><h3 class="vas-title">${t('documentIntake')}</h3><div class="form-group"><label class="form-label">${t('medicationLabel')}</label><input type="text" class="form-input" id="medRecName" placeholder="z.B. Ibuprofen"></div><div class="form-group"><label class="form-label">${t('doseOptional')}</label><input type="text" class="form-input" id="medRecDose" placeholder="z.B. 400mg"></div><button class="btn btn-primary btn-block" onclick="saveMedRec()">${t('documentBtn')}</button></div><div class="chart-container"><div class="chart-title">${t('intakesPerDay')}</div><div class="chart-canvas">${medChart()}</div></div>${state.medicationRecords.length?`<div style="margin-top:16px;"><h4 style="margin-bottom:10px;color:var(--text)">${t('lastTitle')}</h4>${state.medicationRecords.slice(-10).reverse().map(r=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:1.2rem;">💊</span><div style="flex:1;"><div style="font-weight:600;font-size:.9rem;color:var(--text)">${r.name}${r.dose?' ('+r.dose+')':''}</div><div style="font-size:.8rem;color:var(--muted);">${formatDT(r.date)}</div></div></div>`).join('')}</div>`:''}</div>`;}
function renderAppts(){const upcoming=state.appointments.filter(a=>new Date(a.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));const past=state.appointments.filter(a=>new Date(a.datetime)<new Date()).sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('appointmentsTitle')}</h1></div><button class="btn btn-primary btn-block" style="margin-bottom:16px;" onclick="apptModal()">${t('addAppointmentBtn')}</button>${upcoming.length?`<h3 style="margin-bottom:10px;color:var(--text)">${t('upcomingTitle')}</h3>${upcoming.map(a=>{const dt=new Date(a.datetime);return`<div class="appt-card"><div class="appt-date"><div class="appt-day">${dt.getDate()}</div><div class="appt-month">${dt.toLocaleDateString(getLocale(),{month:'short'})}</div></div><div class="appt-info"><div class="appt-title">${a.title}</div><div class="appt-details">${dt.toLocaleTimeString(getLocale(),{hour:'2-digit',minute:'2-digit'})} Uhr${a.location?' • '+a.location:''}${a.reminder?' • 🔔':''}</div>${a.notes?`<div style="font-size:.75rem;color:var(--muted);margin-top:3px;">${a.notes}</div>`:''}</div><button class="appt-delete" onclick="delAppt('${a.id}')">🗑️</button></div>`;}).join('')}`:'<div class="storage-info" style="margin-bottom:16px;"><span>📅</span><p>Keine Termine. Nachkontrollen hinzufügen!</p></div>'}${past.length?`<h3 style="margin:16px 0 10px;color:var(--muted);">${t('pastTitle')}</h3>${past.slice(0,5).map(a=>{const dt=new Date(a.datetime);return`<div class="appt-card" style="opacity:.5;"><div class="appt-date" style="background:var(--muted);"><div class="appt-day">${dt.getDate()}</div><div class="appt-month">${dt.toLocaleDateString(getLocale(),{month:'short'})}</div></div><div class="appt-info"><div class="appt-title">${a.title}</div><div class="appt-details">${dt.toLocaleTimeString(getLocale(),{hour:'2-digit',minute:'2-digit'})} Uhr</div></div></div>`;}).join('')}`:''}</div>`;}
function renderMeds(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('medPlanTitle')}</h1></div><button class="btn btn-primary btn-block" style="margin-bottom:16px;" onclick="medModal()">${t('addMedicationBtn')}</button>${state.medications.length?state.medications.map(m=>`<div class="med-card"><div class="med-header"><div><div class="med-name">💊 ${m.name}</div><div class="med-dose">${m.dose}${m.notes?' • '+m.notes:''}</div></div><button class="appt-delete" onclick="delMed('${m.id}')">🗑️</button></div><div class="med-times">${m.alarms.map((a,i)=>`<div class="med-time" onclick="toggleAlarm('${m.id}',${i})"><div class="alarm-dot ${a.enabled?'':'off'}"></div><span>${a.time}</span></div>`).join('')}</div></div>`).join(''):'<div class="storage-info"><span>💊</span><p>Keine Medikamente. Plan erstellen!</p></div>'}<div class="disclaimer" style="margin-top:16px;"><span>🔔</span><div>Tippen Sie auf eine Uhrzeit um die Erinnerung ein/auszuschalten.</div></div></div>`;}
function renderPacklist(){const allDocs=[...getDefaultDocs(),...state.customDocuments];const isAmbulant=state.profile.opMode==='ambulant';const dc=state.documentChecklist||{};const notNeededText=t('notNeededAmbulant');const ambulantNotNeeded=['d7','d8'];return`<div class="screen"><div class="section-header"><h1 class="section-title">📦 ${t('packingList')}</h1></div><p style="color:var(--muted);margin-bottom:14px;">Was Sie für die OP mitnehmen sollten:${isAmbulant?' <strong>(Ambulante OP)</strong>':''}</p><div class="doc-checklist"><h3 style="margin-bottom:12px;color:var(--text);display:flex;align-items:center;gap:8px;">📋 ${t('documentChecklist')}</h3><div class="doc-checklist-item" onclick="toggleDocCheck('referral')"><div class="doc-checklist-check ${dc.referral?'checked':''}">✓</div><span>☑️ ${t('referral')}</span></div><div class="doc-checklist-item" onclick="toggleDocCheck('transfer')"><div class="doc-checklist-check ${dc.transfer?'checked':''}">✓</div><span>☑️ ${t('transfer')}</span></div><div class="doc-checklist-item" onclick="toggleDocCheck('medicationList')"><div class="doc-checklist-check ${dc.medicationList?'checked':''}">✓</div><span>☑️ ${t('medicationList')}</span></div><div class="doc-checklist-item" onclick="toggleDocCheck('allergyPass')"><div class="doc-checklist-check ${dc.allergyPass?'checked':''}">✓</div><span>☑️ ${t('allergyPass')}</span></div><div class="doc-checklist-item" onclick="toggleDocCheck('anesthesiaPass')"><div class="doc-checklist-check ${dc.anesthesiaPass?'checked':''}">✓</div><span>☑️ ${t('anesthesiaPass')}</span></div></div><div class="fasting" style="margin-top:16px;"><h3 style="margin-bottom:12px;display:flex;align-items:center;gap:8px;">⏰ ${t('fastingAlarm')}</h3><p style="font-size:.85rem;margin-bottom:10px;">${t('noEating')} - ${t('clearFluidsOnly')}</p><button class="btn btn-secondary" onclick="fastingAlarmModal()">🔔 ${t('setAlarm')}</button></div><div class="card" style="margin-top:16px;">${allDocs.map(d=>{const notNeeded=isAmbulant&&ambulantNotNeeded.includes(d.id);return`<div class="doc-item ${state.documents.includes(d.id)?'checked':''} ${notNeeded?'not-needed-ambulant':''}" onclick="toggleDoc('${d.id}')"><div class="doc-check">${state.documents.includes(d.id)?'✓':''}</div><div class="doc-icon">${d.icon}</div><div class="doc-label">${d.label}${notNeeded?' <span style="font-size:.7rem;color:var(--muted);">'+notNeededText+'</span>':''}</div>${!getDefaultDocs().find(x=>x.id===d.id)?`<button class="doc-delete" onclick="event.stopPropagation();delCustomDoc('${d.id}')">🗑️</button>`:''}</div>`;}).join('')}</div><div style="margin-top:16px;padding:14px;background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(239,68,68,.1));border:2px solid var(--warning);border-radius:var(--radius);"><p style="font-size:.9rem;color:var(--text);display:flex;align-items:center;gap:8px;">💍 ${t('jewelryNote')}</p></div><button class="btn btn-secondary btn-block" style="margin-top:12px;" onclick="addDocModal()">${t('addOwnEntry')}</button><button class="btn btn-secondary btn-block" style="margin-top:10px;" onclick="window.print()">${t('printList')}</button></div>`;}
function fastingAlarmModal(){showModal('⏰ '+t('fastingAlarm'),`<p style="color:var(--muted);margin-bottom:16px;">${t('noEating')} - ${t('clearFluidsOnly')}</p><div class="form-group"><label class="form-label">${t('alarmTime')}</label><input type="time" class="form-input" id="fastingAlarmTime" value="22:00"></div><button class="btn btn-primary btn-block" onclick="setFastingAlarm()">🔔 ${t('setAlarm')}</button>`);}
function renderAssistant(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('aiAssistantTitle')}</h1></div><div class="chat-container"><div class="chat-header"><div class="chat-header-icon">🤖</div><div class="chat-header-text"><h3>${t('medAssistant')}</h3><p>${t('opPrepQuestions')}</p></div></div><div class="chat-messages" id="chatMessages">${state.chatMessages.map(m=>`<div class="chat-message ${m.role}"><div class="chat-bubble">${m.content}</div></div>`).join('')}</div><div class="chat-input-area"><input type="text" class="chat-input" id="chatInput" placeholder="Ihre Frage..." onkeypress="if(event.key==='Enter')sendChatMessage()"><button class="chat-send" onclick="sendChatMessage()">➤</button></div><div class="chat-disclaimer">⚠️ Dieser Assistent gibt nur allgemeine Informationen. Bei medizinischen Fragen wenden Sie sich an Ihr Behandlungsteam.</div></div></div>`;}
function renderWoundDiary(){const diaryData=getWoundDiaryData();const woundNotes=state.woundNotes||[];return`<div class="screen"><div class="section-header"><h1 class="section-title">📔 ${t('woundDiary')}</h1></div><p style="color:var(--muted);margin-bottom:16px;">${t('woundDiaryDesc')}</p><div class="hygiene-tips"><h3 style="margin-bottom:12px;color:var(--text);display:flex;align-items:center;gap:8px;">🧴 ${t('woundHygiene')}</h3><div class="hygiene-step"><div class="hygiene-step-num">1</div><span>🖐️ ${t('hygieneStep1')}</span></div><div class="hygiene-step"><div class="hygiene-step-num">2</div><span>🩹 ${t('hygieneStep2')}</span></div><div class="hygiene-step"><div class="hygiene-step-num">3</div><span>📋 ${t('hygieneStep3')}</span></div><div class="hygiene-step"><div class="hygiene-step-num">4</div><span>⛔ ${t('hygieneStep4')}</span></div><div class="hygiene-step"><div class="hygiene-step-num">5</div><span>✨ ${t('hygieneStep5')}</span></div><div class="hygiene-step"><div class="hygiene-step-num">6</div><span>🖐️ ${t('hygieneStep6')}</span></div><p style="margin-top:12px;padding:10px;background:rgba(239,68,68,.1);border-radius:8px;font-size:.85rem;color:var(--danger);">⚠️ ${t('rednessWarning')}</p></div><div class="shower-tips"><h3 style="margin-bottom:12px;color:var(--text);display:flex;align-items:center;gap:8px;">🚿 ${t('showerHints')}</h3><ul style="list-style:none;padding:0;"><li style="padding:6px 0;display:flex;gap:8px;"><span>💧</span>${t('showerHint1')}</li><li style="padding:6px 0;display:flex;gap:8px;"><span>🩹</span>${t('showerHint2')}</li><li style="padding:6px 0;display:flex;gap:8px;"><span>♻️</span>${t('showerHint3')}</li></ul></div><div style="margin-bottom:16px;"><h3 style="margin-bottom:10px;color:var(--text);">⏰ ${t('woundAlarm')}</h3><button class="btn btn-secondary btn-block" onclick="woundAlarmModal()">🔔 ${t('setAlarm')}</button></div>${diaryData.length?`<div class="wound-timeline">${diaryData.map(day=>{const dayNotes=woundNotes.filter(n=>n.date===day.label);return`<div class="wound-day"><div class="wound-day-header"><span class="wound-day-badge">${day.label}</span><span class="wound-day-date">${day.date.toLocaleDateString(getLocale(),{weekday:'short',day:'numeric',month:'short'})}</span></div><div class="wound-day-content">${day.photos.length?`<div class="wound-day-photos">${day.photos.map(p=>`<div class="wound-day-photo" onclick="viewPhoto('${p.id}')"><img data-wound-placeholder="true" data-media-id="${p.mediaId||''}" data-photo-id="${p.id}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23e5e7eb' width='100' height='100'/%3E%3Ctext x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='12'%3ELädt...%3C/text%3E%3C/svg%3E" alt="Wundfoto" style="width:100%;height:100%;object-fit:cover;border-radius:8px;"></div>`).join('')}</div>`:''}<div style="display:flex;gap:6px;margin-bottom:10px;"><button class="btn btn-primary btn-sm" style="flex:1;" onclick="document.getElementById('woundDiaryCam').click()">📷 Aufnehmen</button><button class="btn btn-secondary btn-sm" style="flex:1;" onclick="document.getElementById('woundDiaryUp').click()">🖼️ Galerie</button></div>${day.notes.length||dayNotes.length?`<div style="margin-top:8px;">${day.notes.map(n=>`<div class="wound-day-note"><strong>${n.title}</strong><br>${n.note}</div>`).join('')}${dayNotes.map(n=>`<div class="wound-day-note" style="margin-top:6px;">📝 ${n.note}</div>`).join('')}</div>`:''}</div></div>`;}).join('')}</div><input type="file" id="woundDiaryCam" class="file-input" accept="image/*" capture="environment" onchange="handlePhoto(event,'wound')"><input type="file" id="woundDiaryUp" class="file-input" accept="image/*" multiple onchange="handlePhoto(event,'wound')">`:`<div class="storage-info" style="text-align:center;padding:30px;"><div style="font-size:3rem;margin-bottom:16px;">📷</div><h3 style="color:var(--text);margin-bottom:8px;">${t('noWoundPhotos')}</h3><p style="margin-bottom:16px;">${t('documentWoundHealing')}</p><button class="btn btn-primary" onclick="nav('photos')">${t('takePhotosBtn')}</button></div>`}</div>`;}
function woundAlarmModal(){showModal('⏰ '+t('woundAlarm'),`<div class="form-group"><label class="form-label">${t('alarmTime')}</label><input type="time" class="form-input" id="woundAlarmTime" value="10:00"></div><div class="form-group"><label class="form-label">${t('alarmDays')}</label><div style="display:flex;flex-wrap:wrap;gap:8px;">${['Tag 1','Tag 3','Tag 5','Tag 7','Tag 10','Tag 14'].map(d=>`<label style="display:flex;align-items:center;gap:4px;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;cursor:pointer;"><input type="checkbox" value="${d}" checked><span>${d}</span></label>`).join('')}</div></div><button class="btn btn-primary btn-block" onclick="setWoundAlarm()">🔔 ${t('setAlarm')}</button>`);}
function setWoundAlarm(){const time=document.getElementById('woundAlarmTime')?.value;const days=[...document.querySelectorAll('#modal input[type=checkbox]:checked')].map(c=>c.value);setState({woundAlarms:[...state.woundAlarms||[],{time,days,created:new Date().toISOString()}]});closeModal();showToast('Wecker gestellt ✓');if('Notification' in window&&Notification.permission==='granted'){showToast('Benachrichtigungen aktiviert');}}
function toggleDocCheck(item){const dc={...state.documentChecklist||{},};dc[item]=!dc[item];setState({documentChecklist:dc});}
function setFastingAlarm(){const time=document.getElementById('fastingAlarmTime')?.value;setState({fastingAlarms:[...state.fastingAlarms||[],{time,created:new Date().toISOString()}]});closeModal();showToast('Nüchtern-Wecker gestellt ✓');}
function renderDoctorMode(){const report=generateDoctorReport();const d=getDaysUntil();const bedarfsMed=state.medications.filter(m=>m.asNeeded);return`<div class="screen" id="doctorReport"><div class="section-header"><h1 class="section-title">👨‍⚕️ Kurzbericht</h1></div><p style="color:var(--muted);margin-bottom:12px;">Offline-tauglich für Arztgespräche</p><div style="display:flex;gap:10px;margin-bottom:16px;"><button class="btn btn-primary btn-sm" onclick="printReport()" style="flex:1;">🖨️ Als PDF drucken</button><button class="btn btn-secondary btn-sm" onclick="copyReportText()" style="flex:1;">📋 Als Text kopieren</button></div><div class="doctor-mode-card"><div class="doctor-mode-section"><div class="doctor-mode-title">📋 OP-Details</div><div class="doctor-mode-value"><strong>Art:</strong> ${report.opType}<br><strong>Datum:</strong> ${report.opDate}<br><strong>Tage post-OP:</strong> ${report.daysPostOp>0?report.daysPostOp:'-'}<br><strong>Modus:</strong> ${state.profile.opMode==='ambulant'?'Ambulant':state.profile.opMode==='stationary'?'Stationär':'k.A.'}</div></div></div>${report.warnings.length?`<div class="doctor-mode-card" style="border-color:var(--warning);background:rgba(245,158,11,.05);"><div class="doctor-mode-section" style="margin-bottom:0;"><div class="doctor-mode-title" style="color:var(--warning);">⚠️ Auffälligkeiten/Warnzeichen</div><ul class="doctor-mode-list">${report.warnings.map(w=>`<li style="color:var(--warning);">${w}</li>`).join('')}</ul></div></div>`:''}<div class="doctor-mode-card"><div class="doctor-mode-section"><div class="doctor-mode-title">📊 Schmerztrend (letzte 7 Tage)</div><div class="doctor-mode-value"><strong>Durchschnitt:</strong> ${report.avgPain}/10<br><strong>Tendenz:</strong> ${report.painTrend}</div>${state.painRecords.length?`<div style="margin-top:10px;font-size:.8rem;color:var(--muted);">Letzte Werte: ${state.painRecords.slice(-5).map(p=>p.value).join(' → ')}</div>`:''}</div></div><div class="doctor-mode-card"><div class="doctor-mode-section"><div class="doctor-mode-title">❤️ Letzte Vitalwerte</div>${report.lastVitals?`<div class="doctor-mode-value"><strong>RR:</strong> ${report.lastVitals.systolic}/${report.lastVitals.diastolic} mmHg<br><strong>Puls:</strong> ${report.lastVitals.pulse} bpm<br><small style="color:var(--muted);">${formatDT(report.lastVitals.date)}</small></div>`:'<p style="color:var(--muted);">Keine Messungen</p>'}</div></div><div class="doctor-mode-card"><div class="doctor-mode-section"><div class="doctor-mode-title">💊 Medikamentenplan</div>${report.medications.length?`<ul class="doctor-mode-list">${report.medications.filter(m=>!m.asNeeded).map(m=>`<li><strong>${m.name}</strong> ${m.dose} - ${m.alarms.map(a=>a.time).join(', ')}</li>`).join('')}</ul>`:('<p style="color:var(--muted);">Keine Medikamente</p>')}</div></div>${bedarfsMed.length?`<div class="doctor-mode-card"><div class="doctor-mode-section"><div class="doctor-mode-title">💊 Bedarfsmedikation</div><ul class="doctor-mode-list">${bedarfsMed.map(m=>`<li><strong>${m.name}</strong> ${m.dose} - bei Bedarf</li>`).join('')}</ul></div></div>`:''}<div class="doctor-mode-card"><div class="doctor-mode-section" style="margin-bottom:0;"><div class="doctor-mode-title">📷 Wunddokumentation</div><div class="doctor-mode-value">${report.woundPhotos} Fotos dokumentiert</div>${report.woundPhotos>0?`<button class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="nav('wounddiary')">Wundtagebuch öffnen</button>`:''}</div></div><button class="btn btn-secondary btn-block" style="margin-top:16px;" onclick="nav('export')">📤 Vollständiger Export</button></div>`;}
function printReport(){
const report=generateDoctorReport();
const bedarfsMed=state.medications.filter(m=>m.asNeeded);
const html=`<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>Kurzbericht - Operationsbegleiter</title><style>
body{font-family:Arial,sans-serif;max-width:700px;margin:0 auto;padding:20px;color:#333;font-size:14px;line-height:1.5;}
h1{color:#6366f1;border-bottom:2px solid #6366f1;padding-bottom:8px;font-size:20px;}
h2{color:#1e1b4b;margin-top:20px;font-size:16px;border-left:4px solid #6366f1;padding-left:10px;}
.card{background:#f8f9fa;border-radius:8px;padding:14px;margin-bottom:12px;border:1px solid #e5e7eb;}
.label{font-weight:bold;color:#64748b;font-size:12px;}
.value{margin-top:2px;}
.warning{background-color:#fef3c7;border-left:4px solid #f59e0b;padding:10px;margin:10px 0;}
.warning-title{color:#b45309;font-weight:bold;margin-bottom:6px;}
ul{margin:6px 0;padding-left:20px;}
li{margin-bottom:4px;}
.footer{margin-top:24px;padding-top:10px;border-top:1px solid #ddd;font-size:11px;color:#64748b;text-align:center;}
@media print{body{padding:0;}.footer{position:fixed;bottom:10px;left:0;right:0;}}
</style></head><body>
<h1>🏥 Kurzbericht</h1>
<p style="color:#64748b;margin-bottom:16px;">Erstellt: ${new Date().toLocaleString('de-DE')}</p>
<div class="card"><h2>📋 OP-Details</h2>
<div class="label">Art</div><div class="value">${escapeHtml(report.opType)}</div>
<div class="label" style="margin-top:8px;">Datum</div><div class="value">${escapeHtml(report.opDate)}</div>
<div class="label" style="margin-top:8px;">Tage post-OP</div><div class="value">${report.daysPostOp>0?report.daysPostOp:'-'}</div>
<div class="label" style="margin-top:8px;">Modus</div><div class="value">${state.profile.opMode==='ambulant'?'Ambulant':state.profile.opMode==='stationary'?'Stationär':'k.A.'}</div>
</div>
${report.warnings.length?`<div class="warning"><div class="warning-title">⚠️ Auffälligkeiten</div><ul>${report.warnings.map(w=>'<li>'+escapeHtml(w)+'</li>').join('')}</ul></div>`:''}
<div class="card"><h2>📊 Schmerztrend (7 Tage)</h2>
<div class="label">Durchschnitt</div><div class="value">${report.avgPain}/10</div>
<div class="label" style="margin-top:8px;">Tendenz</div><div class="value">${escapeHtml(report.painTrend)}</div>
${state.painRecords.length?`<div style="margin-top:8px;font-size:12px;color:#64748b;">Letzte Werte: ${state.painRecords.slice(-5).map(p=>p.value).join(' → ')}</div>`:''}
</div>
<div class="card"><h2>❤️ Letzte Vitalwerte</h2>
${report.lastVitals?`<div class="label">RR</div><div class="value">${report.lastVitals.systolic}/${report.lastVitals.diastolic} mmHg</div>
<div class="label" style="margin-top:8px;">Puls</div><div class="value">${report.lastVitals.pulse} bpm</div>
<div style="margin-top:8px;font-size:12px;color:#64748b;">${formatDT(report.lastVitals.date)}</div>`:'<p style="color:#64748b;">Keine Messungen</p>'}
</div>
<div class="card"><h2>💊 Medikamentenplan</h2>
${report.medications.filter(m=>!m.asNeeded).length?`<ul>${report.medications.filter(m=>!m.asNeeded).map(m=>'<li><strong>'+escapeHtml(m.name)+'</strong> '+escapeHtml(m.dose)+' - '+m.alarms.map(a=>a.time).join(', ')+'</li>').join('')}</ul>`:'<p style="color:#64748b;">Keine Medikamente</p>'}
</div>
${bedarfsMed.length?`<div class="card"><h2>💊 Bedarfsmedikation</h2><ul>${bedarfsMed.map(m=>'<li><strong>'+escapeHtml(m.name)+'</strong> '+escapeHtml(m.dose)+' - bei Bedarf</li>').join('')}</ul></div>`:''}
<div class="card"><h2>📷 Wunddokumentation</h2>
<p>${report.woundPhotos} Fotos dokumentiert</p>
</div>
<div class="footer">Erstellt mit Operationsbegleiter App</div>
</body></html>`;
let iframe=document.getElementById('printFrame');
if(!iframe){iframe=document.createElement('iframe');iframe.id='printFrame';iframe.style.cssText='position:absolute;width:0;height:0;border:0;left:-9999px;';document.body.appendChild(iframe);}
iframe.contentDocument.open();
iframe.contentDocument.write(html);
iframe.contentDocument.close();
setTimeout(()=>{try{iframe.contentWindow.focus();iframe.contentWindow.print();}catch(e){showToast('Drucken nicht möglich');console.error('Print error:',e);}},200);
}
function copyReportText(){const report=generateDoctorReport();const bedarfsMed=state.medications.filter(m=>m.asNeeded);let text=`KURZBERICHT - Operationsbegleiter\n${'='.repeat(40)}\n\n`;text+=`OP-DETAILS\n`;text+=`Art: ${report.opType}\n`;text+=`Datum: ${report.opDate}\n`;text+=`Tage post-OP: ${report.daysPostOp>0?report.daysPostOp:'-'}\n`;text+=`Modus: ${state.profile.opMode==='ambulant'?'Ambulant':state.profile.opMode==='stationary'?'Stationär':'k.A.'}\n\n`;if(report.warnings.length){text+=`AUFFÄLLIGKEITEN\n`;report.warnings.forEach(w=>text+=`• ${w}\n`);text+=`\n`;}text+=`SCHMERZTREND (7 Tage)\n`;text+=`Durchschnitt: ${report.avgPain}/10\n`;text+=`Tendenz: ${report.painTrend}\n\n`;text+=`VITALWERTE\n`;if(report.lastVitals){text+=`RR: ${report.lastVitals.systolic}/${report.lastVitals.diastolic} mmHg\n`;text+=`Puls: ${report.lastVitals.pulse} bpm\n`;}else{text+=`Keine Messungen\n`;}text+=`\nMEDIKAMENTENPLAN\n`;if(report.medications.length){report.medications.filter(m=>!m.asNeeded).forEach(m=>text+=`• ${m.name} ${m.dose} - ${m.alarms.map(a=>a.time).join(', ')}\n`);}else{text+=`Keine Medikamente\n`;}if(bedarfsMed.length){text+=`\nBEDARFSMEDIKATION\n`;bedarfsMed.forEach(m=>text+=`• ${m.name} ${m.dose}\n`);}text+=`\nWunddokumentation: ${report.woundPhotos} Fotos\n`;text+=`\n---\nErstellt am: ${new Date().toLocaleString('de-DE')}`;navigator.clipboard.writeText(text).then(()=>showToast('In Zwischenablage kopiert 📋')).catch(()=>showToast('Kopieren fehlgeschlagen'));}
function renderExport(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('exportTitle')}</h1></div><p style="color:var(--muted);margin-bottom:16px;">${t('exportExplain')}</p><div class="export-card" onclick="exportData('pdf')"><div class="export-icon">📄</div><div class="export-title">${t('pdfPrint')}</div><div class="export-desc">${t('pdfPrintDesc')}</div></div><div class="export-card" onclick="exportData('html')"><div class="export-icon">💾</div><div class="export-title">HTML-Datei speichern</div><div class="export-desc">${t('saveHtmlDesc')}</div></div><div class="disclaimer" style="margin-top:20px;"><span>ℹ️</span><div><strong>${t('exportContent')}:</strong><ul style="margin-top:8px;padding-left:16px;"><li>${t('opInfoDate')}</li><li>${t('painCourseChart')}</li><li>${t('vitalsValues')}</li><li>${t('medicationList2')}</li><li>${t('appointmentsList')}</li><li>${t('woundPhotoNote')}</li></ul></div></div></div>`;}
function renderSettings(){return`<div class="screen"><div class="section-header"><h1 class="section-title">⚙️ ${t('settings')}</h1></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">📱 Handywechsel / Backup</h3><div class="settings-card"><div class="settings-item" style="flex-direction:column;align-items:stretch;gap:10px;"><p style="font-size:.85rem;color:var(--muted);line-height:1.4;">Alle Daten inkl. Fotos, Dokumente und Sprachmemos sichern. Auf Mobilgeräten öffnet sich ein Teilen-Dialog.</p><button class="btn btn-primary btn-block" onclick="exportFullBackup()">📤 Backup erstellen</button><button class="btn btn-secondary btn-block" onclick="importDataModal()">📥 Backup wiederherstellen</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">👥 OP-Profile</h3><div class="settings-card"><div class="settings-item" style="flex-direction:column;align-items:stretch;gap:10px;"><p style="font-size:.85rem;color:var(--muted);line-height:1.4;">Mehrere Operationen separat verwalten</p>${renderProfilesList()}<button class="btn btn-secondary btn-block" onclick="newProfileModal()">➕ Neues OP-Profil anlegen</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">${t('opDataSection')}</h3><div class="settings-card"><div class="settings-item"><div class="settings-label"><div class="settings-icon">📅</div><div class="settings-text"><h4>${t('opDate')}</h4><p>${formatDate(state.profile.opDate)||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="dateModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">🏥</div><div class="settings-text"><h4>${t('opType')}</h4><p>${state.profile.opType||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="typeModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">🏨</div><div class="settings-text"><h4>${t('opMode')}</h4><p>${state.profile.opMode==='ambulant'?t('ambulant'):state.profile.opMode==='stationary'?t('stationary'):'Unbekannt'}</p></div></div><button class="btn btn-secondary btn-sm" onclick="opModeModal()">${t('changeBtn')}</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">🚗 ${t('transport')}</h3><div class="settings-card"><div class="settings-item"><div class="settings-label"><div class="settings-icon">⏰</div><div class="settings-text"><h4>${t('departureTime')}</h4><p>${state.profile.departureTime||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="departureModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">⏱️</div><div class="settings-text"><h4>${t('travelDuration')}</h4><p>${state.profile.travelDuration?state.profile.travelDuration+' Min.':'Nicht gesetzt'}</p></div></div><button class="btn btn-secondary btn-sm" onclick="durationModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">🚕</div><div class="settings-text"><h4>${t('transportAlt')}</h4><p>${state.profile.transportAlt||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="transportAltModal()">${t('changeBtn')}</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">${t('clinicContactsSection')}</h3><div class="settings-card"><div class="settings-item"><div class="settings-label"><div class="settings-icon">🏥</div><div class="settings-text"><h4>${t('clinicNameLabel')}</h4><p>${state.profile.hospitalName||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="clinicNameModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">📞</div><div class="settings-text"><h4>${t('clinicPhoneLabel')}</h4><p>${state.profile.hospitalPhone||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="clinicPhoneModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">👤</div><div class="settings-text"><h4>${t('emergencyContact')}</h4><p>${state.profile.emergencyContact||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="emergencyContactModal()">${t('changeBtn')}</button></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">👨‍⚕️</div><div class="settings-text"><h4>${t('surgeonNameLabel')}</h4><p>${state.profile.surgeon||t('notSet')}</p></div></div><button class="btn btn-secondary btn-sm" onclick="surgeonModal()">${t('changeBtn')}</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">🎨 Darstellung</h3><div class="settings-card"><div class="settings-item"><div class="settings-label"><div class="settings-icon">${state.theme==='dark'?'🌙':'☀️'}</div><div class="settings-text"><h4>${t('darkMode')}</h4><p>${t('lessEyeStrain')}</p></div></div><label class="toggle"><input type="checkbox" ${state.theme==='dark'?'checked':''} onchange="toggleTheme()"><span class="toggle-slider"></span></label></div><div class="settings-item"><div class="settings-label"><div class="settings-icon">🔤</div><div class="settings-text"><h4>${t('largeFont')}</h4><p>${t('betterReadability')}</p></div></div><label class="toggle"><input type="checkbox" ${state.largeFont?'checked':''} onchange="toggleLargeFont()"><span class="toggle-slider"></span></label></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">${t('notifications')}</h3><div class="settings-card"><div class="settings-item"><div class="settings-label"><div class="settings-icon">🔔</div><div class="settings-text"><h4>${t('notifications')}</h4><p>${t('forTasksMeds')}</p></div></div><label class="toggle"><input type="checkbox" ${state.notifications!==false?'checked':''} onchange="toggleNotifications()"><span class="toggle-slider"></span></label></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">🗑️ Daten verwalten</h3><div class="settings-card"><div class="settings-item" style="flex-direction:column;align-items:stretch;gap:10px;"><p style="font-size:.85rem;color:var(--muted);">📷 ${state.photos.length} Fotos • 🎤 ${state.voiceMemos.length} Memos • 📄 ${state.uploadedDocs.length} Dokumente</p><button class="btn btn-danger btn-block" onclick="resetModal()">🗑️ Daten löschen...</button></div></div><h3 style="font-size:.8rem;color:var(--muted);text-transform:uppercase;margin:16px 0 10px;">${t('legal')}</h3><div class="settings-card"><div class="settings-item" onclick="nav('impressum')" style="cursor:pointer;"><div class="settings-label"><div class="settings-icon">ℹ️</div><div class="settings-text"><h4>${t('impressum')}</h4><p>${t('legalInfoText')}</p></div></div><span style="color:var(--muted);">›</span></div></div><div class="storage-info" style="margin-top:16px;"><span>🔒</span><p>${t('dataStoredLocally')}</p></div></div>`;}
function languageModal(){}
function opModeModal(){showModal(t('opMode'),`<p style="color:var(--muted);margin-bottom:12px;line-height:1.4;"><strong>${t('ambulant')}:</strong> ${t('ambulantExplain')}<br><strong>${t('stationary')}:</strong> ${t('stationaryExplain')}</p><div class="op-mode-toggle" style="flex-direction:column;gap:8px;"><button class="op-mode-btn ${state.profile.opMode==='ambulant'?'active':''}" onclick="setOpMode('ambulant');closeModal();">${t('ambulant')}</button><button class="op-mode-btn ${state.profile.opMode==='stationary'?'active':''}" onclick="setOpMode('stationary');closeModal();">${t('stationary')}</button><button class="op-mode-btn ${state.profile.opMode==='unknown'?'active':''}" onclick="setOpMode('unknown');closeModal();">${t('iDontKnow')}</button></div>`);}
function departureModal(){showModal('⏰ '+t('departureTime'),`<div class="form-group"><label class="form-label">${t('departureTime')}</label><input type="time" class="form-input" id="newDeparture" value="${state.profile.departureTime||''}"></div><button class="btn btn-primary btn-block" onclick="saveDeparture()">${t('saveBtn')}</button>`);}
function saveDeparture(){const val=document.getElementById('newDeparture')?.value;setState({profile:{...state.profile,departureTime:val}});closeModal();showToast('Gespeichert ✓');}
function durationModal(){showModal('⏱️ '+t('travelDuration'),`<div class="form-group"><label class="form-label">${t('travelDuration')}</label><input type="number" class="form-input" id="newDuration" value="${state.profile.travelDuration||''}" min="1" max="300"></div><button class="btn btn-primary btn-block" onclick="saveDuration()">${t('saveBtn')}</button>`);}
function saveDuration(){const val=document.getElementById('newDuration')?.value;setState({profile:{...state.profile,travelDuration:val}});closeModal();showToast('Gespeichert ✓');}
function transportAltModal(){showModal('🚕 '+t('transportAlt'),`<div class="form-group"><label class="form-label">${t('transportAlt')}</label><input type="text" class="form-input" id="newTransportAlt" value="${state.profile.transportAlt||''}" placeholder="${t('transportAltPlaceholder')}"></div><button class="btn btn-primary btn-block" onclick="saveTransportAlt()">${t('saveBtn')}</button>`);}
function saveTransportAlt(){const val=document.getElementById('newTransportAlt')?.value;setState({profile:{...state.profile,transportAlt:val}});closeModal();showToast('Gespeichert ✓');}
function clinicNameModal(){showModal('🏥 Klinikname',`<div class="form-group"><label class="form-label">Name der Klinik</label><input type="text" class="form-input" id="clinicNameInput" value="${state.profile.hospitalName||''}" placeholder="z.B. Charité Berlin"></div><button class="btn btn-primary btn-block" onclick="saveClinicName()">${t('saveBtn')}</button>`);}
function saveClinicName(){const name=document.getElementById('clinicNameInput')?.value;setState({profile:{...state.profile,hospitalName:name}});closeModal();showToast('Klinikname gespeichert ✓');}
function clinicPhoneModal(){showModal('📞 Klinik-Telefon',`<div class="form-group"><label class="form-label">Telefonnummer</label><input type="tel" class="form-input" id="clinicPhoneInput" value="${state.profile.hospitalPhone||''}" placeholder="z.B. 030 123456"></div><button class="btn btn-primary btn-block" onclick="saveClinicPhone()">${t('saveBtn')}</button>`);}
function saveClinicPhone(){const phone=document.getElementById('clinicPhoneInput')?.value;setState({profile:{...state.profile,hospitalPhone:phone}});closeModal();showToast('Telefon gespeichert ✓');}
function emergencyContactModal(){showModal('👤 Notfallkontakt',`<div class="form-group"><label class="form-label">Name und Telefon</label><input type="text" class="form-input" id="emergencyContactInput" value="${state.profile.emergencyContact||''}" placeholder="z.B. Erika Muster, 0170 1234567"></div><button class="btn btn-primary btn-block" onclick="saveEmergencyContact()">${t('saveBtn')}</button>`);}
function saveEmergencyContact(){const contact=document.getElementById('emergencyContactInput')?.value;setState({profile:{...state.profile,emergencyContact:contact}});closeModal();showToast('Notfallkontakt gespeichert ✓');}
function surgeonModal(){showModal('👨‍⚕️ Operateur',`<div class="form-group"><label class="form-label">Name des Operateurs</label><input type="text" class="form-input" id="surgeonInput" value="${state.profile.surgeon||''}" placeholder="z.B. Dr. Schmidt"></div><button class="btn btn-primary btn-block" onclick="saveSurgeon()">${t('saveBtn')}</button>`);}
function saveSurgeon(){const surgeon=document.getElementById('surgeonInput')?.value;setState({profile:{...state.profile,surgeon:surgeon}});closeModal();showToast('Operateur gespeichert ✓');}
function toggleLargeFont(){setState({largeFont:!state.largeFont});document.documentElement.style.fontSize=state.largeFont?'18px':'16px';showToast(state.largeFont?'Große Schrift aktiviert':'Normale Schrift');}
function toggleNotifications(){const newValue=state.notifications===false;setState({notifications:newValue});showToast(newValue?'Erinnerungen aktiviert':'Erinnerungen deaktiviert');}
function getProfiles(){const stored=localStorage.getItem('op_profiles');return stored?JSON.parse(stored):[];}
function saveProfiles(profiles){localStorage.setItem('op_profiles',JSON.stringify(profiles));}
function renderProfilesList(){const profiles=getProfiles();const currentId=state.profileId||'default';if(profiles.length===0)return'<p style="font-size:.85rem;color:var(--muted);margin-bottom:10px;">Aktuell: Standardprofil</p>';return`<div style="margin-bottom:10px;">${profiles.map(p=>`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;${p.id===currentId?'border:2px solid var(--primary);':''}"><span style="flex:1;font-weight:${p.id===currentId?'600':'400'};">${p.name} ${p.id===currentId?'✓':''}</span>${p.id!==currentId?`<button class="btn btn-sm btn-secondary" onclick="switchProfile('${p.id}')">Laden</button>`:''}<button class="btn btn-sm btn-danger" onclick="deleteProfile('${p.id}')" style="padding:6px 10px;">🗑️</button></div>`).join('')}</div>`;}
function newProfileModal(){showModal('➕ Neues OP-Profil',`<p style="color:var(--muted);margin-bottom:16px;">Erstellen Sie ein neues Profil für eine weitere Operation. Ihr aktuelles Profil wird gespeichert.</p><div class="form-group"><label class="form-label">Profilname</label><input type="text" class="form-input" id="newProfileName" placeholder="z.B. Knie-OP 2026"></div><button class="btn btn-primary btn-block" onclick="createNewProfile()">Profil erstellen</button>`);}
function createNewProfile(){const name=document.getElementById('newProfileName')?.value?.trim();if(!name)return showToast('Bitte Namen eingeben');const profiles=getProfiles();const currentId=state.profileId||'default';const existingIdx=profiles.findIndex(p=>p.id===currentId);if(existingIdx>=0){profiles[existingIdx].data=JSON.stringify(state);}else{profiles.push({id:currentId,name:state.profile.opType||'Standardprofil',data:JSON.stringify(state)});}const newId='profile_'+Date.now();const newState={...DEFAULT_STATE,profileId:newId,setupComplete:false};profiles.push({id:newId,name:name,data:JSON.stringify(newState)});saveProfiles(profiles);state=newState;localStorage.setItem(APP_KEY,JSON.stringify(state));closeModal();showToast('Neues Profil erstellt');render();}
function switchProfile(profileId){const profiles=getProfiles();const currentId=state.profileId||'default';const currentIdx=profiles.findIndex(p=>p.id===currentId);if(currentIdx>=0){profiles[currentIdx].data=JSON.stringify(state);}else{profiles.push({id:currentId,name:state.profile.opType||'Standardprofil',data:JSON.stringify(state)});}const targetProfile=profiles.find(p=>p.id===profileId);if(!targetProfile)return showToast('Profil nicht gefunden');saveProfiles(profiles);const newState=JSON.parse(targetProfile.data);newState.profileId=profileId;state=newState;localStorage.setItem(APP_KEY,JSON.stringify(state));showToast('Profil gewechselt zu: '+targetProfile.name);render();}
function deleteProfile(profileId){const profiles=getProfiles().filter(p=>p.id!==profileId);saveProfiles(profiles);showToast('Profil gelöscht');render();}
function exportAllData(){exportFullBackup();}
function blobToBase64(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(blob);});}
async function exportFullBackup(){
showToast('Backup wird erstellt...');
try{
const photosWithMedia=[];
for(const p of state.photos){
let data=null;
if(p.mediaId){try{const media=await getMedia(p.mediaId);if(media&&media.blob){data=await blobToBase64(media.blob);}}catch(e){console.error('Photo export error:',e);}}
photosWithMedia.push({id:p.id,category:p.category,date:p.date,note:p.note||'',mime:p.mime||'image/jpeg',data:data});
}
const docsWithMedia=[];
for(const d of state.uploadedDocs){
let data=null;
if(d.mediaId){try{const media=await getMedia(d.mediaId);if(media&&media.blob){data=await blobToBase64(media.blob);}}catch(e){console.error('Doc export error:',e);}}
docsWithMedia.push({id:d.id,name:d.name,type:d.type,date:d.date,data:data});
}
const memosWithMedia=[];
for(const m of state.voiceMemos){
let data=null;
if(m.mediaId){try{const media=await getMedia(m.mediaId);if(media&&media.blob){data=await blobToBase64(media.blob);}}catch(e){console.error('Memo export error:',e);}}
memosWithMedia.push({id:m.id,date:m.date,duration:m.duration,title:m.title,mime:m.mime||'audio/webm',data:data});
}
const backupData={version:3,exportDate:new Date().toISOString(),includesMedia:true,profile:state.profile,photos:photosWithMedia,voiceMemos:memosWithMedia,uploadedDocs:docsWithMedia,transcripts:state.transcripts,painRecords:state.painRecords,vitalsRecords:state.vitalsRecords,medicationRecords:state.medicationRecords,appointments:state.appointments,medications:state.medications,questions:state.questions,tasks:state.tasks,documents:state.documents,customDocuments:state.customDocuments,woundNotes:state.woundNotes||[],chatMessages:state.chatMessages||[]};
const jsonStr=JSON.stringify(backupData);
const blob=new Blob([jsonStr],{type:'application/json'});
const fname=`operationsbegleiter-backup-${new Date().toISOString().split('T')[0]}.json`;
const sizeMB=(jsonStr.length/1024/1024).toFixed(1);
if(navigator.share){
try{
const file=new File([blob],fname,{type:'application/json'});
if(navigator.canShare&&navigator.canShare({files:[file]})){
await navigator.share({files:[file],title:'Operationsbegleiter Backup',text:'Vollständiges App-Backup mit allen Daten und Medien'});
showToast(`Backup geteilt (${sizeMB} MB) ✓`);
return;
}
}catch(e){if(e.name!=='AbortError'){console.error('Share error:',e);}}
}
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=fname;
a.style.display='none';
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
showToast(`Backup erstellt (${sizeMB} MB) 📤`);
}catch(err){console.error('Backup error:',err);showToast('Backup-Fehler: '+err.message);}
}
function importDataModal(){showModal('📥 Daten importieren',`<p style="color:var(--muted);margin-bottom:16px;line-height:1.5;">Wählen Sie eine Backup-Datei (.json), um Ihre Daten wiederherzustellen. <strong>Achtung:</strong> Vorhandene Daten werden überschrieben!</p><div class="upload-area" onclick="document.getElementById('importFile').click()"><div class="upload-icon">📂</div><div class="upload-text">Backup-Datei auswählen</div></div><input type="file" id="importFile" class="file-input" accept=".json" onchange="handleImport(event)">`);}
async function handleImport(e){
const file=e.target.files[0];if(!file)return;
showToast('Backup wird geladen...');
const r=new FileReader();
r.onload=async ev=>{
try{
const data=JSON.parse(ev.target.result);
if(!data.profile&&!data.version){showToast('Ungültige Backup-Datei');return;}
if(data.version===3&&data.includesMedia){
showToast('Medien werden importiert...');
await clearAllMedia();
const newPhotos=[];
for(const p of data.photos||[]){
if(p.data){
try{const blob=dataURLToBlob(p.data);if(blob){const mediaId=await putMedia({blob,mime:p.mime||'image/jpeg'});newPhotos.push({id:p.id,mediaId:mediaId,category:p.category,date:p.date,note:p.note||'',mime:p.mime||'image/jpeg',size:blob.size});}else{newPhotos.push({id:p.id,category:p.category,date:p.date,note:p.note||'',mime:p.mime});}}catch(err){console.error('Photo import error:',err);newPhotos.push({id:p.id,category:p.category,date:p.date,note:p.note||''});}}else{newPhotos.push({id:p.id,category:p.category,date:p.date,note:p.note||''});}
}
data.photos=newPhotos;
const newDocs=[];
for(const d of data.uploadedDocs||[]){
if(d.data){
try{const blob=dataURLToBlob(d.data);if(blob){const mediaId=await putMedia({blob,mime:d.type});newDocs.push({id:d.id,mediaId:mediaId,name:d.name,type:d.type,date:d.date,size:blob.size});}else{newDocs.push({id:d.id,name:d.name,type:d.type,date:d.date});}}catch(err){console.error('Doc import error:',err);newDocs.push({id:d.id,name:d.name,type:d.type,date:d.date});}}else{newDocs.push({id:d.id,name:d.name,type:d.type,date:d.date});}
}
data.uploadedDocs=newDocs;
const newMemos=[];
for(const m of data.voiceMemos||[]){
if(m.data){
try{const blob=dataURLToBlob(m.data);if(blob){const mediaId=await putMedia({blob,mime:m.mime||'audio/webm'});newMemos.push({id:m.id,mediaId:mediaId,date:m.date,duration:m.duration,title:m.title,mime:m.mime||'audio/webm',size:blob.size});}else{newMemos.push({id:m.id,date:m.date,duration:m.duration,title:m.title});}}catch(err){console.error('Memo import error:',err);newMemos.push({id:m.id,date:m.date,duration:m.duration,title:m.title});}}else{newMemos.push({id:m.id,date:m.date,duration:m.duration,title:m.title});}
}
data.voiceMemos=newMemos;
}
const newState={...state,...data,setupComplete:true,currentScreen:'dashboard',migrations:{mediaToIndexedDB:true}};
delete newState.version;delete newState.exportDate;delete newState.note;delete newState.includesMedia;
localStorage.setItem(APP_KEY,JSON.stringify(newState));
state=newState;
closeModal();
showToast('Backup vollständig importiert! 🎉');
render();
}catch(err){console.error('Import error:',err);showToast('Fehler beim Import: '+err.message);}
};
r.readAsText(file);
}
function renderImpressum(){return`<div class="screen"><div class="section-header"><h1 class="section-title">${t('impressumTitle')}</h1></div><div class="info-content" style="margin-bottom:16px;"><h3 style="margin-bottom:12px;color:var(--text);">${t('aboutAppTitle')}</h3><p style="color:var(--muted);line-height:1.6;margin-bottom:12px;">${t('aboutAppDesc')}</p><h3 style="margin:20px 0 12px;color:var(--text);">${t('medicalNoteTitle')}</h3><p style="color:var(--muted);line-height:1.6;margin-bottom:12px;">${t('medicalNoteContent')}</p><h3 style="margin:20px 0 12px;color:var(--text);">${t('privacyTitleLong')}</h3><p style="color:var(--muted);line-height:1.6;margin-bottom:12px;">${t('privacyContentLong')}</p><h3 style="margin:20px 0 12px;color:var(--text);">${t('contactTitleLong')}</h3><p style="color:var(--muted);line-height:1.6;">${t('contactContentLong')}</p></div><div class="storage-info"><span>💡</span><p>${t('versionInfo')}</p></div></div>`;}
function attachListeners(){document.querySelectorAll('#disclaimer,#privacy').forEach(el=>{el?.addEventListener('change',e=>{const p={...state.profile};if(e.target.id==='disclaimer')p.disclaimerAccepted=e.target.checked;if(e.target.id==='privacy')p.privacyAccepted=e.target.checked;setState({profile:p});});});document.querySelectorAll('.tab').forEach(t=>{t.addEventListener('click',e=>{const tab=e.target.dataset.tab;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));e.target.classList.add('active');document.querySelectorAll('.info-section').forEach(s=>s.classList.add('hidden'));document.querySelector(`[data-content="${tab}"]`)?.classList.remove('hidden');});});document.querySelectorAll('.filter-tab').forEach(t=>{t.addEventListener('click',e=>{const f=e.target.dataset.filter;document.querySelectorAll('.filter-tab').forEach(x=>x.classList.remove('active'));e.target.classList.add('active');document.querySelectorAll('.task').forEach(task=>{const done=task.classList.contains('completed');if(f==='all')task.style.display='';else if(f==='open')task.style.display=done?'none':'';else task.style.display=done?'':'none';});});});const chatMsgs=document.getElementById('chatMessages');if(chatMsgs)chatMsgs.scrollTop=chatMsgs.scrollHeight;}
document.addEventListener('DOMContentLoaded',async()=>{if(state.largeFont)document.documentElement.style.fontSize='18px';try{await openDB();await migrateMediaToIndexedDB();}catch(e){console.error('IndexedDB init error:',e);}if(state.setupComplete&&state.tasks.length>0){const currentIds=state.tasks.map(t=>t.id);let newTasks=false;getTimeline().forEach(p=>{p.tasks.forEach(t=>{if(!currentIds.includes(t.id)){state.tasks.push({...t,day:p.day,completed:false,note:''});newTasks=true;}});});if(newTasks)saveState();}render();});
window.toggleTheme=toggleTheme;window.toggleTask=toggleTask;window.toggleDoc=toggleDoc;window.nav=nav;window.goBack=goBack;window.toggleMenu=toggleMenu;window.nextStep=nextStep;window.prevStep=prevStep;window.noteModal=noteModal;window.saveNote=saveNote;window.addDocModal=addDocModal;window.submitDoc=submitDoc;window.delCustomDoc=delCustomDoc;window.apptModal=apptModal;window.submitAppt=submitAppt;window.delAppt=delAppt;window.medModal=medModal;window.submitMed=submitMed;window.delMed=delMed;window.toggleAlarm=toggleAlarm;window.dateModal=dateModal;window.changeDate=changeDate;window.typeModal=typeModal;window.changeType=changeType;window.resetModal=resetModal;window.resetApp=resetApp;window.closeModal=closeModal;window.handlePhoto=handlePhoto;window.delPhoto=delPhoto;window.execDelPhoto=execDelPhoto;window.viewPhoto=viewPhoto;window.handleDocUpload=handleDocUpload;window.delUploadedDoc=delUploadedDoc;window.execDelUploadedDoc=execDelUploadedDoc;window.startRec=startRec;window.stopRec=stopRec;window.playMemo=playMemo;window.delMemo=delMemo;window.startSpeech=startSpeech;window.stopSpeech=stopSpeech;window.delTranscript=delTranscript;window.savePain=savePain;window.saveVitals=saveVitals;window.saveMedRec=saveMedRec;window.questionModal=questionModal;window.submitQuestion=submitQuestion;window.addQuestion=addQuestion;window.delQuestion=delQuestion;window.sendChatMessage=sendChatMessage;window.renameMemo=renameMemo;window.saveMemoName=saveMemoName;window.editTranscript=editTranscript;window.updateTranscript=updateTranscript;window.saveTranscriptWithName=saveTranscriptWithName;window.exportData=exportData;window.addWoundNote=addWoundNote;window.saveWoundNote=saveWoundNote;window.clinicNameModal=clinicNameModal;window.saveClinicName=saveClinicName;window.clinicPhoneModal=clinicPhoneModal;window.saveClinicPhone=saveClinicPhone;window.emergencyContactModal=emergencyContactModal;window.saveEmergencyContact=saveEmergencyContact;window.surgeonModal=surgeonModal;window.saveSurgeon=saveSurgeon;window.toggleLargeFont=toggleLargeFont;window.toggleNotifications=toggleNotifications;window.exportAllData=exportAllData;window.setLanguage=setLanguage;window.setOpMode=setOpMode;window.showAdFreeModal=showAdFreeModal;window.languageModal=languageModal;window.opModeModal=opModeModal;window.departureModal=departureModal;window.saveDeparture=saveDeparture;window.durationModal=durationModal;window.saveDuration=saveDuration;window.transportAltModal=transportAltModal;window.saveTransportAlt=saveTransportAlt;window.toggleDocCheck=toggleDocCheck;window.setFastingAlarm=setFastingAlarm;window.setWoundAlarm=setWoundAlarm;window.woundAlarmModal=woundAlarmModal;window.fastingAlarmModal=fastingAlarmModal;window.acceptTranslationWarning=acceptTranslationWarning;window.exportFullBackup=exportFullBackup;window.importDataModal=importDataModal;window.handleImport=handleImport;window.deleteMediaOnly=deleteMediaOnly;window.deleteHistoryOnly=deleteHistoryOnly;window.newProfileModal=newProfileModal;window.createNewProfile=createNewProfile;window.switchProfile=switchProfile;window.deleteProfile=deleteProfile;window.printReport=printReport;window.copyReportText=copyReportText;window.addMedTime=addMedTime;window.openDocument=openDocument;window.closePhotoViewer=closePhotoViewer;window.loadPhotoThumbnails=loadPhotoThumbnails;window.loadWoundDiaryThumbnails=loadWoundDiaryThumbnails;window.showStorageFullModal=showStorageFullModal;window.showSutureGuide=showSutureGuide;window.addCustomTaskModal=addCustomTaskModal;window.saveCustomTask=saveCustomTask;window.deleteCustomTask=deleteCustomTask;window.execDeleteTask=execDeleteTask;
</script>
</body>
</html>
